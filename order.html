<!DOCTYPE html>
<html>
<head>
    <title>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body, html { height: 100%; margin: 0; font-family: sans-serif; background-color: #f5f5f5; }
        #map { height: 70%; width: 100%; }
        #controls { 
            height: 30%; background: white; padding: 20px;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            display: flex; flex-direction: column; gap: 15px;
            position: absolute; bottom: 0; left: 0; right: 0;
        }
        input {
            padding: 15px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px;
            width: 100%; box-sizing: border-box; outline: none; background: #fafafa;
        }
        input:focus { border-color: #2ea44f; background: #fff; }
        button {
            background-color: #2ea44f; color: white; border: none; 
            padding: 15px; border-radius: 10px; font-size: 16px; font-weight: bold;
            width: 100%; cursor: pointer; transition: 0.2s;
        }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .label { font-size: 12px; color: #666; margin-bottom: -10px; margin-left: 5px;}
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div id="controls">
        <div class="label">üìù ‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏• / Order ID</div>
        <input type="text" id="billId" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: INV-1001" />
        
        <button id="btnConfirm" disabled>üìç ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô</button>
    </div>

    <script>
        let map, marker, selectedLocation = null;
        const tg = window.Telegram.WebApp;
        tg.expand(); // ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠

        function initMap() {
            // ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û)
            const bangkok = { lat: 13.7563, lng: 100.5018 };
            
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 15, 
                center: bangkok, 
                disableDefaultUI: true, 
                gestureHandling: "greedy",
                zoomControl: true
            });

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° Listener ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏¥‡πâ‡∏°‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
            map.addListener("click", (e) => placeMarker(e.latLng));
        }

        function placeMarker(latLng) {
            if (marker) marker.setMap(null);
            marker = new google.maps.Marker({ position: latLng, map: map, animation: google.maps.Animation.DROP });
            selectedLocation = { lat: latLng.lat(), lng: latLng.lng() };
            
            // ‡∏™‡∏±‡πà‡∏ô‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö
            tg.HapticFeedback.impactOccurred('medium');
            checkReady();
        }

        const billInput = document.getElementById("billId");
        const btn = document.getElementById("btnConfirm");

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå ‡∏´‡∏£‡∏∑‡∏≠ ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î
        billInput.addEventListener("input", checkReady);

        function checkReady() {
            // ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∞‡∏Å‡∏î‡πÑ‡∏î‡πâ‡∏Å‡πá‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠: ‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß AND ‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•‡πÅ‡∏•‡πâ‡∏ß
            if (selectedLocation && billInput.value.trim() !== "") {
                btn.disabled = false;
                btn.innerText = "‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á";
                btn.style.backgroundColor = "#2ea44f";
            } else if (!selectedLocation) {
                btn.disabled = true;
                btn.innerText = "üìç ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á";
            } else {
                btn.disabled = true;
                btn.innerText = "üìù ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•";
            }
        }

        btn.addEventListener("click", () => {
            if (selectedLocation && billInput.value) {
                // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏≤‡∏ö‡∏≠‡∏ó
                const data = JSON.stringify({
                    action: "create_job",
                    bill_id: billInput.value.trim(),
                    lat: selectedLocation.lat,
                    lng: selectedLocation.lng
                });
                tg.sendData(data); 
            }
        });
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAzn1_v_MRFa2FpMjEeVBsdRtZ4dfZPo4w&callback=initMap" async defer></script>
</body>
</html>