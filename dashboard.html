<!DOCTYPE html>
<html>
<head>
    <title>Logistic Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body, html { height: 100%; margin: 0; font-family: 'Kanit', sans-serif; background-color: #f0f2f5; }
        
        /* SEARCH BOX (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Google Maps) */
        .pac-container { z-index: 99999; border-radius: 0 0 10px 10px; border-top: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #search-container {
            position: absolute; top: 60px; left: 10px; right: 10px; z-index: 5;
        }
        #search-box {
            width: 100%; height: 45px; padding: 0 15px;
            border: none; border-radius: 8px; font-family: 'Kanit', sans-serif; font-size: 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3); outline: none; box-sizing: border-box;
        }

        /* MENU SCREEN */
        #menu-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 20px; padding: 20px; }
        .menu-btn { width: 100%; padding: 20px; border: none; border-radius: 15px; font-size: 18px; font-weight: bold; color: white; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-pool { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .btn-create { background: linear-gradient(135deg, #10b981, #059669); }
        .role-badge { position: absolute; top: 20px; right: 20px; background: #e5e7eb; padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }

        /* MAP SCREEN */
        #map-screen { display: none; height: 100%; width: 100%; position: relative; }
        #map { height: 65%; width: 100%; }
        #controls { 
            height: 35%; background: white; padding: 20px;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            display: flex; flex-direction: column; gap: 12px;
            position: absolute; bottom: 0; left: 0; right: 0;
        }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; width: 100%; box-sizing: border-box; outline: none; background: #fafafa; font-family: 'Kanit'; }
        .action-btn { background-color: #2ea44f; color: white; border: none; padding: 15px; border-radius: 12px; font-size: 16px; font-weight: bold; width: 100%; cursor: pointer; }
        .action-btn:disabled { background-color: #ccc; }
        .back-btn { position: absolute; top: 15px; left: 15px; z-index: 10; background: white; padding: 8px 12px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: none; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="menu-screen">
        <div class="role-badge" id="roleDisplay">Checking...</div>
        <h2>‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏á‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h2>
        <button class="menu-btn btn-pool" id="btnViewPool" style="display:none;">üìä ‡∏î‡∏π‡∏á‡∏≤‡∏ô‡πÉ‡∏ô Pool</button>
        <button class="menu-btn btn-create" id="btnCreateJob" style="display:none;">üì¶ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</button>
    </div>

    <div id="map-screen">
        <button class="back-btn" onclick="goBack()">üîô ‡πÄ‡∏°‡∏ô‡∏π</button>
        
        <div id="search-container">
            <input id="search-box" type="text" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏î‡∏û‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß, ‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î...)" />
        </div>

        <div id="map"></div>
        
        <div id="controls">
            <select id="pickupSelector">
                <option value="0">üè≠ ‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö: Main Warehouse (HQ)</option>
                </select>

            <input type="text" id="billId" placeholder="üìù ‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏• / Order ID" />
            <button class="action-btn" id="btnConfirm" disabled>üìç ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // 1. Role Logic
        const params = new URLSearchParams(window.location.search);
        const role = params.get('role') || 'UNKNOWN';
        document.getElementById('roleDisplay').innerText = role;

        const btnPool = document.getElementById('btnViewPool');
        const btnCreate = document.getElementById('btnCreateJob');

        if (['SUPERADMIN', 'SUPERVISOR'].includes(role)) {
            btnPool.style.display = 'flex';
            btnCreate.style.display = 'flex';
        } else if (role === 'ADMIN') {
            btnCreate.style.display = 'flex';
        }

        // Event Listeners
        btnPool.addEventListener('click', () => tg.sendData(JSON.stringify({ action: "view_pool" })));
        btnCreate.addEventListener('click', () => {
            document.getElementById('menu-screen').style.display = 'none';
            document.getElementById('map-screen').style.display = 'block';
            if (!map) initMap();
        });

        function goBack() {
            document.getElementById('map-screen').style.display = 'none';
            document.getElementById('menu-screen').style.display = 'flex';
        }

        // --- MAP & SEARCH LOGIC ---
        let map, marker, selectedLocation = null;
        let searchBox;

        function initMap() {
            const bangkok = { lat: 13.7563, lng: 100.5018 };
            
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 15, center: bangkok, 
                disableDefaultUI: true, gestureHandling: "greedy", zoomControl: false
            });

            // 1. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Search Box ‡∏Å‡∏±‡∏ö Google Maps Places
            const input = document.getElementById("search-box");
            const searchBox = new google.maps.places.Autocomplete(input);
            searchBox.bindTo("bounds", map);

            // 2. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            searchBox.addListener("place_changed", () => {
                const place = searchBox.getPlace();
                if (!place.geometry || !place.geometry.location) return;

                // ‡∏¢‡πâ‡∏≤‡∏¢‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏à‡∏∏‡∏î‡∏ô‡∏±‡πâ‡∏ô
                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(17);
                }
                
                // ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                placeMarker(place.geometry.location);
            });

            // 3. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏¥‡πâ‡∏°‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏á
            map.addListener("click", (e) => placeMarker(e.latLng));
        }

        function placeMarker(latLng) {
            if (marker) marker.setMap(null);
            marker = new google.maps.Marker({ position: latLng, map: map, animation: google.maps.Animation.DROP });
            selectedLocation = { lat: latLng.lat(), lng: latLng.lng() };
            tg.HapticFeedback.impactOccurred('medium');
            checkReady();
        }

        // --- FORM LOGIC ---
        const billInput = document.getElementById("billId");
        const btnConfirm = document.getElementById("btnConfirm");
        billInput.addEventListener("input", checkReady);

        function checkReady() {
            if (selectedLocation && billInput.value.trim() !== "") {
                btnConfirm.disabled = false;
                btnConfirm.innerText = "‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á";
            } else {
                btnConfirm.disabled = true;
                btnConfirm.innerText = selectedLocation ? "üìù ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•" : "üìç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á";
            }
        }

        btnConfirm.addEventListener("click", () => {
            if (selectedLocation && billInput.value) {
                const pickupIndex = document.getElementById("pickupSelector").value; // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö
                const data = JSON.stringify({
                    action: "create_job",
                    bill_id: billInput.value.trim(),
                    lat: selectedLocation.lat,
                    lng: selectedLocation.lng,
                    pickup_index: parseInt(pickupIndex) // ‡∏™‡πà‡∏á index ‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
                });
                tg.sendData(data); 
            }
        });
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAzn1_v_MRFa2FpMjEeVBsdRtZ4dfZPo4w&libraries=places&callback=initMap" async defer></script>
</body>
</html>