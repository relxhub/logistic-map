<!DOCTYPE html>
<html lang="th">
<head>
<title>Logistic SuperApp</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<style>
    :root { --primary: #00B900; --danger: #dc3545; --warning: #ffc107; --bg: #F5F5F5; --card: #FFF; --text: #333; }
    body { margin: 0; padding: 0; font-family: 'Kanit', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 90px; -webkit-tap-highlight-color: transparent; }
    
    .view { display: none; padding: 15px; animation: fadeIn 0.3s; }
    .view.active { display: block; }
    
    .header { background: white; padding: 20px 20px 15px; border-radius: 0 0 20px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
    .user-info h1 { margin: 0; font-size: 18px; color: #333; }
    .user-info p { margin: 0; font-size: 12px; color: #888; }
    .role-badge { background: #e8f5e9; color: var(--primary); padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }

    .card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; border-left: 4px solid var(--primary); }
    .card-header { font-weight: bold; font-size: 16px; margin-bottom: 8px; display: flex; justify-content: space-between; }
    .card-row { display: flex; align-items: flex-start; gap: 8px; font-size: 13px; color: #555; margin-bottom: 6px; }
    .card-row i { margin-top: 3px; width: 16px; text-align: center; color: var(--primary); }
    .card-actions { margin-top: 10px; display: flex; gap: 8px; justify-content: flex-end; border-top: 1px solid #eee; padding-top: 10px; }

    .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .menu-item { background: white; padding: 20px; border-radius: 15px; text-align: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.1s; }
    .menu-item:active { transform: scale(0.98); }
    .menu-item i { font-size: 28px; color: var(--primary); margin-bottom: 10px; display: block; }

    .form-group { margin-bottom: 15px; }
    .form-label { font-size: 14px; font-weight: bold; margin-bottom: 5px; display: block; color: #333; }
    input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: 'Kanit'; outline: none; font-size: 15px; background: #fff; }
    input:focus, select:focus, textarea:focus { border-color: var(--primary); }

    .btn { box-sizing: border-box;width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer; color: white; display: inline-flex; align-items: center; justify-content: center; gap: 5px; margin-top: 5px; transition: 0.2s; }
    .btn:disabled { background-color: #ccc !important; cursor: not-allowed; }
    .btn-primary { background: var(--primary); }
    .btn-danger { background: var(--danger); }
    .btn-warning { background: var(--warning); color: #333; }
    .btn-finish { background: #FFC107 !important; color: #000 !important; border: 1px solid #e0a800; } 
    .btn-finish:active { background: #FFB300 !important; }
    .btn-outline { background: transparent; border: 1px solid #ddd; color: #333; width: auto; padding: 6px 12px; font-size: 12px; }
    .btn-icon { background: none; border: none; cursor: pointer; font-size: 16px; padding: 5px; color: #888; }
    .btn-icon:hover { color: var(--primary); }
    .btn-icon.delete:hover { color: var(--danger); }
    .btn-call { background: #e8f5e9; color: var(--primary); border: 1px solid var(--primary); padding: 4px 10px; border-radius: 20px; font-size: 12px; text-decoration: none; display: inline-block; margin-left: 5px; }

    .map-preview { width: 100%; height: 180px; border-radius: 8px; margin-bottom: 10px; background: #eee; border: 1px solid #ddd; display: none; position: relative; overflow: hidden; }
    .map-preview-placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px; background: #f9f9f9; cursor: pointer; }
    
    #map-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; display: none; background: white; flex-direction: column; }
    .map-header-bar { padding: 15px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 2010; display: flex; gap: 10px; align-items: center; }
    #search-box-overlay { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Kanit'; outline: none; background: #f5f5f5; }
    #map-fullscreen { flex-grow: 1; width: 100%; }
    .map-footer-bar { padding: 20px; background: white; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); z-index: 2010; text-align: center; }
    .pac-container { z-index: 10000 !important; font-family: 'Kanit', sans-serif; }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: none; align-items: center; justify-content: center; }
    .modal-box { background: white; width: 85%; max-width: 320px; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); animation: fadeIn 0.2s; }
    .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: var(--primary); }
    .modal-detail { text-align: left; font-size: 14px; color: #555; background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
    .modal-line { display: flex; justify-content: space-between; margin-bottom: 5px; }
    .modal-actions { display: flex; gap: 10px; flex-direction: column; }
    .btn-copy { background: #333; color: white; }

    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0 25px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 900; }
    .nav-btn { text-align: center; color: #ccc; font-size: 10px; cursor: pointer; flex: 1; }
    .nav-btn.active { color: var(--primary); }
    .nav-btn i { font-size: 22px; display: block; margin-bottom: 4px; }
    
    .fab { position: fixed; bottom: 90px; right: 20px; width: 50px; height: 50px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; z-index: 800; }

    .card.selected {
    border: 2px solid var(--primary) !important;
    background-color: #e8f5e9;
    transform: scale(0.98);
    }
    .select-check {
    display: none;
    font-size: 20px;
    color: var(--primary);
    position: absolute;
    top: 10px;
    right: 10px;
    }
    .card.selected .select-check { display: block; }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á Select2 ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ò‡∏µ‡∏° Falcon App */
    .select2-container { width: 100% !important; }
    .select2-container .select2-selection--single {
    height: 50px; /* ‡∏™‡∏π‡∏á‡πÄ‡∏ó‡πà‡∏≤ Input ‡∏≠‡∏∑‡πà‡∏ô */
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px;
    background-color: #fff;
    }
    .select2-selection__arrow { top: 12px !important; right: 10px !important; }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 28px;
    font-family: 'Kanit', sans-serif; /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå Kanit */
    font-size: 15px;
    color: #333;
    }
    .select2-container--default .select2-results__option--highlighted.select2-results__option--selectable {
    background-color: var(--primary); /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ */
    color: white;
    }
    .select2-search__field {
    border-radius: 5px !important;
    font-family: 'Kanit', sans-serif;
    }
/* ‡∏ã‡πà‡∏≠‡∏ô Search box ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô HTML ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) */

    /* [‡πÄ‡∏û‡∏¥‡πà‡∏°] Toast Notification (‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏≤‡∏¢‡πÄ‡∏≠‡∏á) */
    #toast {
        visibility: hidden;
        min-width: 200px;
        background-color: #333; /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏î‡∏≥‡∏à‡∏≤‡∏á */
        color: #fff;
        text-align: center;
        border-radius: 30px;
        padding: 12px 20px;
        position: fixed;
        z-index: 9999;
        left: 50%;
        bottom: 30px;
        font-size: 14px;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s, bottom 0.3s;
    }

    #toast.show {
        visibility: visible;
        opacity: 0.9;
        bottom: 50px; /* ‡∏•‡∏≠‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
    }
</style>
</head>
<body>

<div class="header">
    <div class="user-info"><h1 id="user-name">...</h1><p id="user-id">ID: ...</p></div>
    <div style="display:flex; align-items:center; gap:10px;">
        <button class="btn-icon" onclick="window.location.reload()" style="background:#f0f0f0; border-radius:50%; width:35px; height:35px; display:flex; align-items:center; justify-content:center;">
            <i class="fa-solid fa-rotate-right" style="font-size:16px;"></i>
        </button>
        <div class="role-badge" id="user-role">...</div>
    </div>
</div>

<div id="view-home" class="view active">
    <h2 style="font-size:18px; margin:0 0 15px 0;">‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</h2>
    <div class="grid-menu" id="menu-container"></div>
    <button class="btn btn-danger" style="margin-top:30px;" onclick="confirmSOS()">üö® S.O.S</button>
</div>

<div id="view-pickup" class="view">
    <h3>üìç ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</h3>
    <div id="pickup-list"></div>
    <div class="fab" onclick="goToAddPickup()"><i class="fa-solid fa-plus"></i></div>
</div>

<div id="view-customers" class="view">
    <h3>üìñ ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
    
    <div class="form-group" style="margin-bottom:10px;">
        <input type="text" id="customer-filter-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£..." onkeyup="renderCustomerList()" style="padding:10px; border-radius:20px;">
    </div>

    <div id="customer-list"></div>
    <div class="fab" onclick="goToAddCustomer()"><i class="fa-solid fa-plus"></i></div>
</div>

<div id="view-add-customer" class="view">
    <button class="btn btn-outline" onclick="nav('customers')" style="margin-bottom:15px;">üîô ‡∏Å‡∏•‡∏±‡∏ö</button>
    <h3 id="customer-form-title">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
    
    <div class="form-group">
        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</label>
        <input type="text" id="cust-save-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏´‡∏±‡∏™ A01" />
    </div>
    
    <div class="form-group">
        <label class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</label>
        <input type="text" id="cust-recv-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö" style="margin-bottom:5px;" />
        <input type="tel" id="cust-recv-phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" />
    </div>

    <div class="form-group">
        <label class="form-label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</label>
        <div style="display:flex; gap:5px;">
            <input type="text" id="cust-search-input" placeholder="‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà..." onclick="openMap('customer')" readonly />
            <button class="btn btn-primary" style="width:auto;" onclick="openMap('customer')"><i class="fa-solid fa-map"></i></button>
        </div>
        <div id="preview-customer" class="map-preview" onclick="openMap('customer')"><div class="map-preview-placeholder">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div></div>
    </div>

    <button class="btn btn-primary" onclick="saveCustomerForm()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
</div>

<div id="view-add-pickup" class="view">
    <button class="btn btn-outline" onclick="nav('pickup')" style="margin-bottom:15px;">üîô ‡∏Å‡∏•‡∏±‡∏ö</button>
    <h3 id="pickup-form-title">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà</h3>
    <div class="form-group"><input type="text" id="pickup-search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." onclick="openMap('pickup')" readonly /><button class="btn btn-primary" onclick="openMap('pickup')"><i class="fa-solid fa-map"></i></button></div>
    <div class="form-group"><div id="preview-pickup" class="map-preview" onclick="openMap('pickup')"><div class="map-preview-placeholder">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div></div></div>
    <div class="form-group"><input type="text" id="new-pickup-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö" /></div>
    <button class="btn btn-primary" onclick="savePickup()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
</div>

<div id="view-create-job" class="view">
    <button class="btn btn-outline" onclick="nav('home')" style="margin-bottom:15px;">üîô ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
    <h3>üì¶ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
    
    <div class="form-group">
        <label class="form-label">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö</label>
        <select id="job-pickup-select"></select>
    </div>
    
    <div class="form-group" style="background:#e8f5e9; padding:10px; border-radius:8px;">
        <label class="form-label" style="color:var(--primary);"><i class="fa-solid fa-user-clock"></i> ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤ (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)</label>

        <select id="customer-search-select" onchange="selectSavedCustomer(this.value)">

        <option value="">-- ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ --</option>

        </select>

    </div>
    
    <div class="form-group">
        <label class="form-label">2. ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</label>
        <div style="display:flex; gap:5px;">
            <input type="text" id="job-search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î..." onclick="openMap('job')" readonly />
            <button class="btn btn-primary" style="width:auto;" onclick="openMap('job')"><i class="fa-solid fa-map"></i></button>
        </div>
        <div id="preview-job" class="map-preview" onclick="openMap('job')" style="margin-top:5px;"><div class="map-preview-placeholder">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div></div>
    </div>
    
    <div class="form-group">
        <label class="form-label">3. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
        <input type="text" id="job-bill-id" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏• / Order ID" style="margin-bottom:5px;" enterkeyhint="next" />
        <div style="display:flex; gap:5px; margin-bottom:5px;">
            <input type="text" id="job-recv-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö" style="flex:1;" enterkeyhint="next" />
            <input type="tel" id="job-recv-phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" style="flex:1;" enterkeyhint="next" />
        </div>
        <input type="text" id="job-note" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" enterkeyhint="done" />
        
        <div style="text-align:right; margin-top:5px;">
            <span style="font-size:12px; color:#666; text-decoration:underline; cursor:pointer;" onclick="promptSaveCustomer()">
                <i class="fa-solid fa-floppy-disk"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤
            </span>
        </div>
    </div>

    <button class="btn btn-primary" id="btn-submit-job" onclick="submitJob()">üöÄ ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</button>
</div>

<div id="view-pool" class="view">
    <h3>üì¶ Pool (<span id="pool-count">0</span>)</h3>
    <div id="pool-list"></div>
</div>

<div id="view-warehouse" class="view">
    <h3>üì¶ ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡∏£‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡∏≠‡∏á)</h3>
    <div id="warehouse-list"></div>
</div>

<div id="view-monitor" class="view"><h3>üëÄ Monitor</h3><div id="monitor-list"></div></div>

<div id="view-rider" class="view">
    <button class="btn btn-outline" onclick="nav('home')" style="margin-bottom:15px;">üîô ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
    <h3>üõµ ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
    <div id="rider-job-card"></div>
</div>

<div id="view-wallet" class="view">
    <button class="btn btn-outline" onclick="nav('home')" style="margin-bottom:15px;">üîô ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
    <h3>üí∞ ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
    
    <div class="card" style="text-align:center; padding:30px; background: linear-gradient(135deg, #00B900 0%, #008f00 100%); color:white;">
        <div style="font-size:14px; opacity:0.9;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
        <div style="font-size:42px; font-weight:bold; margin:10px 0;" id="wallet-balance">0.00</div>
        <div style="font-size:14px;">‡∏ö‡∏≤‡∏ó</div>
        <button class="btn" style="background:white; color:#00B900; margin-top:15px; border-radius:20px;" onclick="requestWithdraw()">
            üí∏ ‡πÅ‡∏à‡πâ‡∏á‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
        </button>
    </div>

    <h4>‚è≥ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h4>
    <div id="wallet-history-list"></div>
</div>

<div id="view-bank" class="view">
    <button class="btn btn-outline" onclick="nav('wallet')" style="margin-bottom:15px;">üîô ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô</button>
    <h3>üè¶ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>
    <div class="card">
        <div class="form-group">
            <label class="form-label">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label>
            <select id="bank-name">
                <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ --</option>
                <option value="KBANK">‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ (KBANK)</option>
                <option value="SCB">‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå (SCB)</option>
                <option value="BBL">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û (BBL)</option>
                <option value="KTB">‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢ (KTB)</option>
                <option value="TTB">‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï (TTB)</option>
                <option value="BAY">‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤ (BAY)</option>
                <option value="GSB">‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô (GSB)</option>
                <option value="BAAC">‡∏ò.‡∏Å.‡∏™. (BAAC)</option>
                <option value="UOB">‡∏¢‡∏π‡πÇ‡∏≠‡∏ö‡∏µ (UOB)</option>
                <option value="CIMB">‡∏ã‡∏µ‡πÑ‡∏≠‡πÄ‡∏≠‡πá‡∏°‡∏ö‡∏µ ‡πÑ‡∏ó‡∏¢ (CIMB)</option>
                <option value="LHBANK">‡πÅ‡∏•‡∏ô‡∏î‡πå ‡πÅ‡∏≠‡∏ô‡∏î‡πå ‡πÄ‡∏Æ‡πâ‡∏≤‡∏™‡πå (LH Bank)</option>
                <option value="TISCO">‡∏ó‡∏¥‡∏™‡πÇ‡∏Å‡πâ (TISCO)</option>
                <option value="KKP">‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ô‡∏≤‡∏Ñ‡∏¥‡∏ô‡∏†‡∏±‡∏ó‡∏£ (KKP)</option>
                <option value="GHB">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (GHB)</option>
                <option value="ICBC">‡πÑ‡∏≠‡∏ã‡∏µ‡∏ö‡∏µ‡∏ã‡∏µ (ICBC)</option>
                <option value="PROMPTPAY">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå (PromptPay)</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ / ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</label>
            <input type="tel" id="bank-acc-no" placeholder="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô" />
        </div>
        <div class="form-group">
            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
            <input type="text" id="bank-acc-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)" />
        </div>
        <button class="btn btn-primary" onclick="saveBankInfo()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
</div>

<div id="view-finance" class="view">
    <button class="btn btn-outline" onclick="nav('home')" style="margin-bottom:15px;">üîô ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
    <h3>üí∞ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</h3>
    
    <div style="display:flex; gap:10px; margin-bottom:15px;">
        <button class="btn btn-primary" id="btn-tab-pending" onclick="switchFinanceTab('pending')">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
        <button class="btn btn-outline" id="btn-tab-history" onclick="switchFinanceTab('history')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÇ‡∏≠‡∏ô</button>
    </div>

    <div id="finance-list"></div>
</div>

<div id="view-broadcast" class="view">
    <button class="btn btn-outline" onclick="nav('home')" style="margin-bottom:15px;">üîô ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
    <h3>üì¢ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</h3>
    
    <div class="form-group">
        <label class="form-label">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</label>
        <textarea id="broadcast-msg" rows="4" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." style="resize:none;"></textarea>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <div style="font-weight:bold;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö <span id="broadcast-count">(0)</span></div>
        <button class="btn btn-outline btn-sm" onclick="toggleAllRiders()" style="width:auto;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>

    <div id="broadcast-list" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; max-height:400px; overflow-y:auto; padding:2px;"></div>

    <button class="btn btn-primary" onclick="submitBroadcast()" style="margin-top:15px;">üöÄ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
</div>

<div id="view-history" class="view">
    <button class="btn btn-outline" onclick="nav('home')" style="margin-bottom:15px;">üîô ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
    <h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h3>
    <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
        <select id="hist-filter-date" onchange="renderFullHistory()" style="flex:1;">
            <option value="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>
            <option value="week">‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ô‡∏µ‡πâ</option>
            <option value="month" selected>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
        <select id="hist-filter-user" onchange="renderFullHistory()" style="flex:1; display:none;">
            <option value="all">-- ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô --</option>
        </select>
    </div>
    <div id="history-list"></div>
</div>

<div id="view-report" class="view">
    <button class="btn btn-outline" onclick="nav('home')" style="margin-bottom:15px;">üîô ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
    <h3>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (7 ‡∏ß‡∏±‡∏ô)</h3>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
        <div class="card" style="text-align:center; padding:15px; margin:0; border-left:4px solid var(--primary);">
            <div style="font-size:12px; color:#888;">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</div>
            <div style="font-size:20px; font-weight:bold; color:var(--primary);" id="report-total-rev">-</div>
        </div>
        <div class="card" style="text-align:center; padding:15px; margin:0; border-left:4px solid var(--warning);">
            <div style="font-size:12px; color:#888;">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div style="font-size:20px; font-weight:bold;" id="report-total-jobs">-</div>
        </div>
    </div>

    <div class="card">
        <canvas id="revenueChart" style="width:100%; height:250px;"></canvas>
    </div>

    <div style="margin-top:20px;">
        <button class="btn btn-primary" onclick="if(confirm('‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå Report ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ä‡∏ó?')) sendAction('export_report')">
            <i class="fa-solid fa-file-excel"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)
        </button>
        <p style="text-align:center; font-size:11px; color:#999; margin-top:5px;">‡πÑ‡∏ü‡∏•‡πå CSV ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
    </div>
</div>

<div id="map-overlay">
    <div class="map-header-bar"><button class="btn btn-outline" onclick="closeMap()"><i class="fa-solid fa-arrow-left"></i></button><input id="search-box-overlay" type="text" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." /></div>
    <div id="map-fullscreen"></div>
    <div class="map-footer-bar"><div id="map-status-text">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏∏‡∏î</div><button class="btn btn-primary" id="btn-confirm-loc" disabled>üìç ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div>
</div>

<div id="confirm-modal" class="modal-overlay" onclick="if(event.target === this) closeModal()">
    <div class="modal-box">
        <div class="modal-title" id="modal-title">üì¶ ‡∏™‡∏£‡∏∏‡∏õ</div>
        <div class="modal-detail" id="modal-content"></div>
        <div class="modal-actions">
            <button class="btn btn-copy" onclick="copyShippingPrice()"><i class="fa-solid fa-copy"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-outline" style="flex:1;" onclick="closeModal()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button class="btn btn-primary" style="flex:1;" onclick="confirmAction()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>
</div>

<div id="toast"></div>

<div class="bottom-nav" id="bottom-nav"></div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const CLOUD_NAME = "dzdijo6tx"; 
    const UPLOAD_PRESET = "rider_slip"; // ‡∏ä‡∏∑‡πà‡∏≠ Preset ‡πÅ‡∏ö‡∏ö Unsigned ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ

    // ‚úÖ ‡∏ß‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å‡πÜ ‡∏Ç‡∏≠‡∏á script)
    let selectedJobs = new Set();
    let selectedPoolJobs = new Set(); // ‚úÖ ‡∏Ç‡∏≠‡∏á Pool (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ)
    let selectedRiders = new Set(); // ‚úÖ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Broadcast
    let pendingPhone = "";
    
    // STATE
    let data = { role: 'GUEST' };
    let tempLat = null, tempLng = null;
    let map, marker, mapMode, editPickupId = null, currentJobId = null, currentEditJobData = null;
    let mapsLoaded = false;
    let config = { base: 40, km: 10, change_fee: 30 };
    let modalActionType = ''; 
    let pendingPayload = null;
    let pendingCopyText = "";
    let countdownInterval;

    // INIT
    try {
        const params = new URLSearchParams(window.location.search);
        const rawData = params.get('data');
        if (rawData) {
            data = JSON.parse(decodeURIComponent(rawData));
            if(data.config) config = data.config;
            if(data.role && data.role.startsWith('Role.')) data.role = data.role.replace('Role.', '');
        }
        document.getElementById('user-name').innerText = data.name || 'Guest';
        document.getElementById('user-id').innerText = `ID: ${data.id || '-'}`;
        document.getElementById('user-role').innerText = data.role || '-';
        const serverTime = new Date(data.server_time).toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' }, { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        document.getElementById('user-id').innerHTML = `ID: ${data.id || '-'}<br><span style="color:${data.role==='RIDER'?'red':'#888'}; font-size:10px;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${serverTime}</span>`;

        if(data.filter_admins) {
            const sel = document.getElementById('hist-filter-user');
            sel.style.display = 'block';
            data.filter_admins.forEach(u => sel.innerHTML += `<option value="${u}">${u}</option>`);
        }
        
        renderMenu(data.role);

    } catch (e) { console.error("Init Error", e); }

    function renderMenu(role) {
        const menu = document.getElementById('menu-container');
        const nav = document.getElementById('bottom-nav');
        let navHtml = `<div class="nav-btn active" onclick="nav('home', this)"><i class="fa-solid fa-house"></i>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</div>`;
        let menuHtml = '';

        if (['SUPERADMIN', 'ADMIN'].includes(role)) {
            menuHtml += `<div class="menu-item" onclick="goToPage('create-job')"><i class="fa-solid fa-plus-circle"></i><br>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</div>`;
        }
        if (['SUPERADMIN', 'SUPERVISOR'].includes(role)) {
            menuHtml += `<div class="menu-item" onclick="nav('pickup')"><i class="fa-solid fa-map-pin"></i><br>‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö</div>`;
            menuHtml += `<div class="menu-item" onclick="nav('report')"><i class="fa-solid fa-chart-line"></i><br>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>`;
        }
        if (role === 'SUPERADMIN') {
            menuHtml += `<div class="menu-item" onclick="nav('finance')"><i class="fa-solid fa-sack-dollar"></i><br>‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</div>`;
            menuHtml += `<div class="menu-item" onclick="nav('broadcast')"><i class="fa-solid fa-bullhorn"></i><br>‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</div>`;
        }
        if (['SUPERADMIN', 'SUPERVISOR', 'ADMIN'].includes(role)) {
            menuHtml += `<div class="menu-item" onclick="nav('history')"><i class="fa-solid fa-clock-rotate-left"></i><br>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div><div class="menu-item" onclick="nav('customers')"><i class="fa-solid fa-address-book"></i><br>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>`;
            let nh = navHtml + `<div class="nav-btn" onclick="nav('history', this)"><i class="fa-solid fa-list"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`;
            if (role !== 'ADMIN') {
                menuHtml += `<div class="menu-item" onclick="nav('pool')"><i class="fa-solid fa-layer-group"></i><br>Pool</div>`;
                nh += `<div class="nav-btn" onclick="nav('pool', this)"><i class="fa-solid fa-box"></i>Pool</div>`;
            }
            if (['ADMIN', 'SUPERADMIN', 'SUPERVISOR'].includes(role)) {
                menuHtml += `<div class="menu-item" onclick="nav('monitor')"><i class="fa-solid fa-desktop"></i><br>Monitor</div>`;
                nh += `<div class="nav-btn" onclick="nav('monitor', this)"><i class="fa-solid fa-eye"></i>Monitor</div>`;
            }
            navHtml = nh;
        }

        if (role === 'WAREHOUSE') {
            menuHtml += `
            <div class="menu-item" onclick="nav('warehouse')">
                <i class="fa-solid fa-boxes-packing"></i><br>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡∏≠‡∏á)
            </div>`;
            navHtml += `<div class="nav-btn" onclick="nav('warehouse', this)"><i class="fa-solid fa-box"></i>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>`;
        }

        if (role === 'RIDER') {
            menuHtml += `
                <div class="menu-item" onclick="nav('rider')"><i class="fa-solid fa-motorcycle"></i><br>‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
                <div class="menu-item" onclick="nav('wallet')"><i class="fa-solid fa-wallet"></i><br>‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô</div>
                <div class="menu-item" onclick="nav('history')"><i class="fa-solid fa-clock-rotate-left"></i><br>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</div>
            `;
        
            // (‡∏™‡πà‡∏ß‡∏ô‡∏•‡πà‡∏≤‡∏á) ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏°‡∏µ‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ö‡∏•‡πà‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
            navHtml += `<div class="nav-btn" onclick="nav('rider', this)"><i class="fa-solid fa-motorcycle"></i>‡∏á‡∏≤‡∏ô</div>`;
            navHtml += `<div class="nav-btn" onclick="nav('wallet', this)"><i class="fa-solid fa-wallet"></i>‡πÄ‡∏á‡∏¥‡∏ô</div>`; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏•‡πà‡∏≤‡∏á
            navHtml += `<div class="nav-btn" onclick="nav('history', this)"><i class="fa-solid fa-list"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`;
        }

        menu.innerHTML = menuHtml;
        menu.style.display = 'grid';
        // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" ‡πÉ‡∏´‡πâ Admin/Sup/SuperAdmin ‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏≤‡∏õ‡∏∏‡πà‡∏° "‡∏õ‡∏¥‡∏î" ‡∏≠‡∏≠‡∏Å
        if (['SUPERADMIN', 'SUPERVISOR', 'ADMIN'].includes(role)) {
            navHtml += `<div class="nav-btn" onclick="nav('customers', this)"><i class="fa-solid fa-address-book"></i>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>`;
        }

        // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏≠‡∏≤‡∏õ‡∏∏‡πà‡∏° tg.close() ‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà HTML ‡∏•‡∏á‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡πÜ
        nav.innerHTML = navHtml;

        if (['SUPERADMIN', 'SUPERVISOR', 'ADMIN'].includes(role)) {
            try { renderPickupList(data.pickup_points || []); } catch(e){ console.error(e); }
            try { setupPickupSelector(); } catch(e){ console.error(e); }
            try { setupCustomerSearch(); } catch(e){ console.error(e); }
            try { renderFullHistory(); } catch(e){ console.error(e); }
            try { renderReport(); } catch(e){}
            if (role !== 'ADMIN') try { renderPoolList(data.pool_jobs || []); } catch(e){}
            try { renderMonitor(data.monitor_jobs || []); } catch(e){}
            try { renderCustomerList(); } catch(e){}
            try { setupCustomerSearch(); } catch(e){ console.error(e); }
            try { renderFinance('pending'); } catch(e){}
            try { renderBroadcastList(); } catch(e){}
        }

        if (role === 'WAREHOUSE') {
            try { renderWarehouseList(data.warehouse_jobs || []); } catch(e){}
        }

        if (role === 'RIDER') {
            try { renderRiderJob(data.current_job); } catch(e){ console.error("Render Job Error:", e); }
            try { renderWallet(); } catch(e){ console.error("Render Wallet Error:", e); }
            try { renderFullHistory(); } catch(e){}
        }
    }

    function setupPickupSelector() {
        const list = data.pickup_points || [];
        const sel = document.getElementById('job-pickup-select');
        sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏ --</option>' + 
                        list.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    }

    // --- RENDER FUNCTIONS ---
    function renderFullHistory() {
        const list = data.full_history || [];
        const dateMode = document.getElementById('hist-filter-date').value;
        const userMode = document.getElementById('hist-filter-user').value;
        const el = document.getElementById('history-list');

        if(list.length === 0) { el.innerHTML = '<div style="text-align:center; padding:20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>'; return; }
        
        const now = new Date();
        const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());

        const filtered = list.filter(j => {
            const d = new Date(j.created_at);
            let dateMatch = true;
            if(dateMode === 'today') dateMatch = d >= startOfDay;
            else if(dateMode === 'week') { const w = new Date(startOfDay); w.setDate(w.getDate()-7); dateMatch = d >= w; }
            else if(dateMode === 'month') { const m = new Date(startOfDay); m.setMonth(m.getMonth()-1); dateMatch = d >= m; }
            
            let userMatch = true;
            if(userMode !== 'all') userMatch = j.admin === userMode;
            
            return dateMatch && userMatch;
        });

        if(filtered.length === 0) { el.innerHTML = '<div style="text-align:center; padding:20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</div>'; return; }

        el.innerHTML = filtered.map(h => {
            const isRider = data.role === 'RIDER';
            let details = '';
            if (!isRider) details += `<div class="card-row"><i class="fa-solid fa-user"></i> Admin: ${h.admin} | Rider: ${h.rider}</div>`;
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
            let recv = '';
            if(h.receiver_name && h.receiver_name !== '-') recv += `üßë‚Äçü¶∞ ${h.receiver_name} `;
            if(h.receiver_phone && h.receiver_phone !== '-') recv += `üìû ${h.receiver_phone}`;
            if(recv) details += `<div class="card-row"><i class="fa-solid fa-box-open"></i> ${recv}</div>`;
            if(h.note && h.note !== '-') details += `<div class="card-row"><i class="fa-solid fa-note-sticky"></i> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${h.note}</div>`;

            const proofBtn = (h.proof && !isRider) ? `<div class="card-actions"><a href="${h.proof}" target="_blank" class="btn btn-outline btn-sm">‡∏£‡∏π‡∏õ‡∏à‡∏ö‡∏á‡∏≤‡∏ô</a></div>` : '';

            return `
            <div class="card" style="border-left: 4px solid ${h.status==='COMPLETED'?'#00B900':'#dc3545'};">
                <div class="card-header">${h.bill_id} <span class="role-badge">${h.status}</span></div>
                ${details}
                <div class="card-row"><i class="fa-solid fa-money-bill"></i> ‡∏Ñ‡πà‡∏≤‡∏£‡∏ñ: ${h.price} ${h.extra_fee>0 ? `(+${h.extra_fee})` : ''}</div>
                <div class="card-row"><i class="fa-solid fa-clock"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á: ${new Date(h.created_at).toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' })}</div>
                ${proofBtn}
            </div>
            `;
        }).join('');
    }

    function renderMonitor(list) {
        const filtered = (data.monitor_jobs || []);
        const el = document.getElementById('monitor-list');
        if(filtered.length === 0) { el.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô</div>'; return; }

        el.innerHTML = filtered.map(j => {
            const jobDataStr = encodeURIComponent(JSON.stringify(j));
            const showAdminName = ['SUPERADMIN', 'SUPERVISOR'].includes(data.role);
            
            let details = '';
            if (showAdminName) details += `<div class="card-row"><i class="fa-solid fa-user"></i> Admin: ${j.admin} | Rider: ${j.rider}</div>`;
            else details += `<div class="card-row"><i class="fa-solid fa-motorcycle"></i> Rider: ${j.rider}</div>`;

            // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞ Note
            details += `<div class="card-row"><i class="fa-solid fa-box"></i> ‡∏ö‡∏¥‡∏•: ${j.bill_id}</div>`;
            if(j.receiver_name && j.receiver_name !== '-') {
                details += `<div class="card-row"><i class="fa-solid fa-address-card"></i> ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: ${j.receiver_name} <a href="tel:${j.receiver_phone}" style="text-decoration:none; color:inherit;">üìû ${j.receiver_phone}</a></div>`;
            }
            if(j.note && j.note !== '-') {
                details += `<div class="card-row"><i class="fa-solid fa-comment-dots"></i> Note: ${j.note}</div>`;
            }

            details += `<div class="card-row"><i class="fa-solid fa-clock"></i> ${new Date(j.created_at).toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' })}</div>`;
            
            let priceText = `üí∞ ${j.price}`;
            if (j.extra_fee > 0) priceText += ` (+‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡πà ${j.extra_fee})`;
            details += `<div class="card-row">${priceText}</div>`;

            let actions = '';
            if (j.status === 'COMPLETED' && j.proof) {
                actions += `<a href="${j.proof}" target="_blank" class="btn btn-outline btn-sm">‡∏£‡∏π‡∏õ‡∏à‡∏ö‡∏á‡∏≤‡∏ô</a> `;
            }
            if (!['COMPLETED', 'CANCELLED'].includes(j.status)) {
                actions += `<button class="btn btn-outline btn-sm" onclick="prepareEditDest('${j.job_id}', '${jobDataStr}')">‡πÅ‡∏Å‡πâ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</button>`;
            }

            return `
            <div class="card">
                <div class="card-header">${j.bill_id} <span class="role-badge">${j.status}</span></div>
                ${details}
                <div class="card-actions">${actions}</div>
            </div>
            `;
        }).join('');
    }

    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á Rider (‡∏â‡∏ö‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Syntax)
    function renderRiderJob(job) {
        const el = document.getElementById('rider-job-card');
    
        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Countdown ‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        if (window.countdownInterval) clearInterval(window.countdownInterval);
    
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
        if (!job) { 
            el.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö</div>'; 
            return; 
        }

        let btns = '';
        let statusColor = '#00B900';
        let statusText = '‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì';
        let extraHtml = '';

        // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡πÉ‡∏ä‡πâ Google Maps Link ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)
        const pickupMap = `https://www.google.com/maps/search/?api=1&query=${job.pickup_lat},${job.pickup_lng}`;
        const dropoffMap = `https://www.google.com/maps/search/?api=1&query=${job.dropoff_lat},${job.dropoff_lng}`;

        // --- ‡∏™‡πà‡∏ß‡∏ô Contact Info ---
        let contactInfo = '';
        if(job.receiver_name && job.receiver_name !== '-') {
            contactInfo += `<div style="margin-top:10px;">üë§ ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: <b>${job.receiver_name}</b></div>`;
        }
        // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏à‡∏≤‡∏Å‡∏ö‡∏≠‡∏ó
        if(job.receiver_phone && job.receiver_phone !== '-') {
            const cleanPhone = job.receiver_phone.replace(/[^0-9+]/g, '');
            
            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° job.receiver_name ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô parameter ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 3
            contactInfo += `
                <div id="phone-wrapper" style="margin-top:10px;">
                    <div style="font-size:14px; margin-bottom:5px;">üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</div>
                    <button class="btn btn-outline" onclick="showInlineCall('${cleanPhone}', '${job.receiver_phone}', '${job.receiver_name}')" style="width:100%; border:1px solid #ccc; color:#333; display:flex; justify-content:space-between; align-items:center; padding:10px;">
                        <span>${job.receiver_phone}</span>
                        <i class="fa-solid fa-phone" style="color:var(--primary);"></i>
                    </button>
                </div>`;
        }
        if(job.note && job.note !== '-') {
        contactInfo += `<div style="background:#f8f9fa; border-left:3px solid #6c757d; padding:8px; margin:10px 0; font-size:13px; border-radius:4px;">üìù <b>Note:</b> ${job.note}</div>`;
        }

        // --- Logic ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ---
        if (job.status === 'OFFERED') {
        statusColor = '#ffc107';
        statusText = 'üîî ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß!';

        // [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á A -> B -> C
        extraHtml = `<div id="job-analysis" style="margin-bottom:10px; font-size:12px; color:#666;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...</div>
                     <div id="route-preview-map" style="width:100%; height:180px; border-radius:10px; background:#eee; margin-bottom:10px;"></div>`;

        // ‡∏î‡∏∂‡∏á GPS ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå (A)
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((pos) => {
                const myLat = pos.coords.latitude;
                const myLng = pos.coords.longitude;

                // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì A -> B (‡πÄ‡∏£‡∏≤‡πÑ‡∏õ‡∏£‡πâ‡∏≤‡∏ô)
                const distToPickup = getDist(myLat, myLng, job.pickup_lat, job.pickup_lng);
                const timeToPickup = Math.ceil((distToPickup / 20) * 60); // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß 20km/h ‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á

                // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì B -> C (‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏õ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)
                const distDelivery = getDist(job.pickup_lat, job.pickup_lng, job.dropoff_lat, job.dropoff_lng);
                const timeDelivery = Math.ceil((distDelivery / 20) * 60);

                // 3. ‡∏£‡∏ß‡∏°
                const totalDist = distToPickup + distDelivery;
                const totalTime = timeToPickup + timeDelivery + 10; // +10 ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                document.getElementById('job-analysis').innerHTML = `
                    <div style="background:#f8f9fa; padding:10px; border-radius:8px; border:1px solid #ddd;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span>üõµ ‡∏Ñ‡∏∏‡∏ì ‚ûù üè™ ‡∏£‡πâ‡∏≤‡∏ô (A‚ûùB)</span>
                            <b>${distToPickup.toFixed(1)} ‡∏Å‡∏°. (${timeToPickup} ‡∏ô.)</b>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span>üè™ ‡∏£‡πâ‡∏≤‡∏ô ‚ûù üè† ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (B‚ûùC)</span>
                            <b>${distDelivery.toFixed(1)} ‡∏Å‡∏°. (${timeDelivery} ‡∏ô.)</b>
                        </div>
                        <hr style="margin:5px 0;">
                        <div style="display:flex; justify-content:space-between; color:var(--primary); font-weight:bold;">
                            <span>üèÅ ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                            <span>${totalDist.toFixed(1)} ‡∏Å‡∏°. (~${totalTime} ‡∏ô.)</span>
                        </div>
                    </div>
                `;

                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ß‡∏≤‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                drawRoutePreview(myLat, myLng, job.pickup_lat, job.pickup_lng, job.dropoff_lat, job.dropoff_lng);

            }, (err) => {
                console.error(err);
                document.getElementById('job-analysis').innerHTML = `<div style="color:red;">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á GPS ‡πÑ‡∏î‡πâ (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î Location Service)</div>`;
            });
        }

        // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞ Countdown ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ) ...
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á...
        const timeoutSec = (data.config && data.config.offer_timeout_sec) ? parseInt(data.config.offer_timeout_sec) : 60;
        // ... (Copy ‡πÇ‡∏Ñ‡πâ‡∏î Countdown ‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢) ...
        
        // (‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        btns = `
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-primary" onclick="sendAction('accept_offer', {job_id:'${job.job_id}'})">‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</button>
            <button class="btn btn-danger" onclick="if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?')) sendAction('reject_offer', {job_id:'${job.job_id}'})">‚ùå ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö</button>
        </div>
        <div id="job-countdown" style="text-align:center; font-size:18px; font-weight:bold; color:#d9534f; margin-top:5px;">...</div>
        `;

            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á
            window.countdownInterval = setInterval(() => {
                const nowAdjusted = new Date().getTime() - timeDiff;
                const diff = expireTime - nowAdjusted;
                if (diff <= 0) {
                    clearInterval(window.countdownInterval);
                    const cdEl = document.getElementById('job-countdown');
                    if(cdEl) cdEl.innerText = "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤!";
                    // Refresh ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    const s = Math.floor(diff / 1000);
                    const cdEl = document.getElementById('job-countdown');
                    if(cdEl) cdEl.innerText = `‚è≥ ${s} ‡∏ß‡∏¥`;
                }
            }, 1000);

        } else if(job.status === 'ASSIGNED') {
            btns = `
            <div style="display:flex; flex-direction:column; gap:10px;">
                <a href="${pickupMap}" target="_blank" class="btn btn-primary" style="text-decoration:none;">
                    <i class="fa-solid fa-location-arrow"></i> ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö
                </a>
                <button class="btn btn-warning" onclick="if(confirm('‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß?')) sendAction('rider_update', {status:'PICKED_UP', job_id:'${job.job_id}'})">
                    <i class="fa-solid fa-box-open"></i> ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
                </button>
                <button class="btn btn-danger" onclick="cancelJob('${job.job_id}')"><i class="fa-solid fa-ban"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</button>
            </div>`;

        } else if (job.status === 'PICKED_UP') {
            btns = `
            <div style="display:flex; flex-direction:column; gap:10px;">
                <a href="${dropoffMap}" target="_blank" class="btn btn-primary" style="text-decoration:none;">
                    <i class="fa-solid fa-flag-checkered"></i> ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á
                </a>
                <button class="btn btn-finish" onclick="showFinishConfirm('${job.job_id}')">
                    <i class="fa-solid fa-camera"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô
                </button>
            </div>`;
        }

        // Render HTML
        el.innerHTML = `
        <div class="card" style="border-left:5px solid ${statusColor};">
            <h2 style="color:${statusColor}; margin-top:0;">${statusText}</h2>
            ${extraHtml}
            <h3 style="margin-bottom:5px;">${job.bill_id}</h3>
            <div style="color:#666; font-size:12px; margin-bottom:10px;">Order #${job.order_no || '-'}</div>
        
            <p>üí∞ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß: <b>${job.price} ‡∏ø</b> ${job.extra_fee > 0 ? `<span style="color:red; font-size:12px;">(+‡πÄ‡∏û‡∏¥‡πà‡∏° ${job.extra_fee})</span>` : ''}</p>
            <p>üìç ‡∏£‡∏±‡∏ö: ${job.pickup_name}</p>
            <hr style="border:0; border-top:1px dashed #ddd; margin:10px 0;">
            ${contactInfo}
            <div style="margin-top:15px;">${btns}</div>
        </div>`;
    }

    function confirmPoolDispatchSelected() {
        if (selectedPoolJobs.size === 0) return;
        modalActionType = 'release_pool_selected';
        pendingPayload = { job_ids: Array.from(selectedPoolJobs) };
        
        const content = `
            <div style="text-align:center; padding:10px;">
                <i class="fa-solid fa-paper-plane" style="font-size:40px; color:var(--primary); margin-bottom:10px;"></i>
                <p>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏á‡∏≤‡∏ô <b>${selectedPoolJobs.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</b>?</p>
                <p style="font-size:12px; color:#666;">‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
            </div>
        `;
        document.getElementById('modal-title').innerText = "üöÄ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏á‡∏≤‡∏ô";
        document.getElementById('modal-content').innerHTML = content;
        document.querySelector('.btn-copy').style.display = 'none';
        document.getElementById('confirm-modal').style.display = 'flex';
    }

    function confirmPoolCancel(jobId, billId) {
        modalActionType = 'pool_cancel';
        pendingPayload = { job_id: jobId };
        
        const content = `
            <div style="text-align:center; padding:10px;">
                <i class="fa-solid fa-circle-xmark" style="font-size:40px; color:#dc3545; margin-bottom:10px;"></i>
                <p>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?</p>
                <p>‡∏ö‡∏¥‡∏•: <b>${billId}</b></p>
            </div>
        `;
        document.getElementById('modal-title').innerText = "‚ö†Ô∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô";
        document.getElementById('modal-content').innerHTML = content;
        document.querySelector('.btn-copy').style.display = 'none';
        document.getElementById('confirm-modal').style.display = 'flex';
    }

    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î (X) ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô
    function showFinishConfirm(jobId) {
        currentJobId = jobId;
        
        const content = `
            <div style="position:relative; text-align:center; padding:10px;">
                <div onclick="closeModal()" style="position:absolute; top:-10px; right:-10px; width:30px; height:30px; background:#eee; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; color:#666;">
                    <i class="fa-solid fa-xmark"></i>
                </div>

                <i class="fa-solid fa-camera" style="font-size:40px; color:#FFC107; margin-bottom:10px;"></i>
                <h3>üì∏ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</h3>
                <p style="font-size:12px; color:#666; margin-bottom:15px;">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</p>
                
                <div style="margin-bottom:15px; border: 2px dashed #ddd; padding: 20px; border-radius: 10px; background: #fafafa;">
                    <input type="file" id="proof-upload" accept="image/png, image/jpeg, image/jpg" style="width:100%;">
                    <div id="proof-status" style="margin-top:10px; font-size:12px; color:#999;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</div>
                </div>

                <button class="btn btn-finish" onclick="submitFinishJob()" style="width:100%;">
                    ‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏à‡∏ö‡∏á‡∏≤‡∏ô
                </button>
            </div>
        `;

        document.getElementById('modal-title').innerText = "üèÅ ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô";
        document.getElementById('modal-content').innerHTML = content;
        
        document.querySelector('.modal-actions').style.display = 'none'; 
        document.getElementById('confirm-modal').style.display = 'flex';
    }

    // --- OTHER FUNCTIONS ---
    function nav(id, el) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-'+id).classList.add('active');
        if(el) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }
    }
    
    function goToPage(page) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        if (page === 'create-job') {
            document.getElementById('view-create-job').classList.add('active');
            resetJobForm();
        } else if (page === 'add-pickup') {
            document.getElementById('view-add-pickup').classList.add('active');
            editPickupId = null;
            resetPickupForm();
        } else if (page === 'add-customer') { 
            document.getElementById('view-add-customer').classList.add('active');
        } else {
            document.getElementById('view-'+page).classList.add('active');
        }
    }

    function goToAddPickup() {
        editPickupId = null;
        resetPickupForm();
        goToPage('add-pickup');
        document.getElementById('pickup-form-title').innerText = "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà";
    }

    function resetPickupForm() {
        document.getElementById('new-pickup-name').value = '';
        document.getElementById('pickup-search-input').value = '';
        document.getElementById('preview-pickup').innerHTML = '<div class="map-preview-placeholder">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>';
        tempLat = null; tempLng = null;
    }

    function resetJobForm() {
        document.getElementById('job-bill-id').value = '';
        document.getElementById('job-recv-name').value = '';
        document.getElementById('job-recv-phone').value = '';
        document.getElementById('job-note').value = '';
        document.getElementById('job-search-input').value = '';
        document.getElementById('job-pickup-select').value = '';
        document.getElementById('preview-job').innerHTML = '<div class="map-preview-placeholder">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</div>';
        tempLat = null; tempLng = null;
    }

    function savePickup() {
        const name = document.getElementById('new-pickup-name').value;
        if(!name || !tempLat) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠');
        if(editPickupId) {
            sendAction('delete_pickup', {id: editPickupId});
            setTimeout(() => sendAction('save_pickup', { name, lat: tempLat, lng: tempLng }), 500);
        } else {
            sendAction('save_pickup', { name, lat: tempLat, lng: tempLng });
        }
    }

    function renderPickupList(list) {
        const el = document.getElementById('pickup-list');
        if(list.length === 0) { el.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</div>'; return; }
        el.innerHTML = list.map(p => `
            <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                <div><b>${p.name}</b><br><span style="font-size:10px; color:#999;">‡πÇ‡∏î‡∏¢: ${p.creator_name || 'System'}</span></div>
                <div style="display:flex; gap:5px;">
                    <button class="btn-icon" onclick="editPickup('${p.id}', '${p.name}', ${p.lat}, ${p.lng})"><i class="fa-solid fa-pen"></i></button>
                    <button class="btn-icon delete" onclick="if(confirm('‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ô‡∏µ‡πâ?')) sendAction('delete_pickup', {id: '${p.id}'})"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
        `).join('');
    }

    function renderPoolList(list) {
        const el = document.getElementById('pool-list');
        if(document.getElementById('pool-count')) document.getElementById('pool-count').innerText = list.length;

        if(list.length === 0) { el.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô Pool</div>'; return; }

        // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏Å‡∏≤‡∏£‡πå‡∏î
        let html = list.map(j => {
            const isReady = j.status === 'PENDING_POOL';
            const isSel = selectedPoolJobs.has(j.job_id) ? 'selected' : '';
            
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° (Preparing) ‡∏à‡∏∞‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
            const clickAction = isReady ? `onclick="toggleSelectPoolJob('${j.job_id}')"` : '';
            const checkIcon = isReady ? `<i class="fa-solid fa-circle-check select-check"></i>` : '';
            const cardStyle = isReady ? 'border-left:4px solid #ffc107; cursor:pointer;' : 'border-left:4px solid #ccc; opacity:0.8;';

            // ‡∏õ‡∏∏‡πà‡∏° Action (‡∏Ç‡∏ß‡∏≤)
            let mainBtn = '';
            if (isReady) {
                mainBtn = `<button class="btn btn-primary btn-sm" style="width:70%;" onclick="sendAction('release_one', {job_id: '${j.job_id}'})">üöÄ ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏á‡∏≤‡∏ô</button>`;
            } else {
                mainBtn = `<button class="btn btn-outline btn-sm" disabled style="width:70%; color:#999; border-color:#ddd;">‚è≥ ‡∏£‡∏≠‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</button>`;
            }

            return `
            <div class="card ${isSel}" style="${cardStyle} position:relative;" ${clickAction}>
                ${checkIcon}
                <div class="card-header">üìù #${j.order_no || '-'} | ${j.bill_id}</div>
                <div class="card-row">üìç ‡∏£‡∏±‡∏ö: ${j.pickup}</div>
                <div class="card-row">üèÅ ‡∏™‡πà‡∏á: ${j.dropoff_lat.toFixed(4)}, ${j.dropoff_lng.toFixed(4)}</div>
                
                <div class="card-actions" onclick="event.stopPropagation()">
                    <button class="btn btn-outline btn-sm" style="color:var(--danger); border-color:var(--danger); width:30%; margin-right:5px;" onclick="confirmPoolCancel('${j.job_id}', '${j.bill_id}')">
                        ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    ${mainBtn}
                </div>
            </div>
            `;
        }).join('');

        // 2. Logic ‡∏õ‡∏∏‡πà‡∏° Batch (Dynamic Switching)
        const count = selectedPoolJobs.size;
        let bottomBtnHtml = '';

        if (count > 0) {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö Batch -> ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (Primary)
            bottomBtnHtml = `
            <div style="padding: 10px 0; position:sticky; bottom:0; background:var(--bg); z-index:100; border-top:1px solid #ddd;">
                <button class="btn btn-primary" onclick="confirmPoolDispatchSelected()">
                    üöÄ ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
                </button>
            </div>`;
        } else {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -> ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (Finish/Warning) ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°
            // (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏á‡∏≤‡∏ô‡πÑ‡∏´‡∏° ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ‡πÄ‡∏•‡∏¢)
            const readyCount = list.filter(j => j.status === 'PENDING_POOL').length;
            if(readyCount > 0) {
                bottomBtnHtml = `
                <div style="padding: 10px 0;">
                    <button class="btn btn-finish" onclick="if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ó‡∏∏‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° (${readyCount})?')) sendAction('release_all')">
                        üöÄ ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° (${readyCount})
                    </button>
                </div>`;
            }
        }

        el.innerHTML = html + bottomBtnHtml;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Toggle ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô
    function toggleSelectPoolJob(jobId) {
        if (selectedPoolJobs.has(jobId)) {
            selectedPoolJobs.delete(jobId);
        } else {
            selectedPoolJobs.add(jobId);
        }
        renderPoolList(data.pool_jobs);
    }

    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô (‡πÅ‡∏ö‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô NaN ‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏∏‡∏î‡∏ú‡∏¥‡∏î)
    function submitJob() {
        const bill = document.getElementById('job-bill-id').value;
        const pid = document.getElementById('job-pickup-select').value;

        // New Fields
        const rName = document.getElementById('job-recv-name').value;
        const rPhone = document.getElementById('job-recv-phone').value;
        const note = document.getElementById('job-note').value;

        // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö‡πÑ‡∏´‡∏°
        if(!bill || !tempLat || !pid) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (‡∏ö‡∏¥‡∏•, ‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö, ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á)');

        // 2. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö (Pickup Point)
        const pickup = (data.pickup_points || []).find(p => p.id === pid);
        if (!pickup) return alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏ (‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)');

        // 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤ Config (‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß‡πÑ‡∏ß‡πâ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ Default)
        const basePrice = (config && config.base) ? parseFloat(config.base) : 40;
        const pricePerKm = (config && config.km) ? parseFloat(config.km) : 10;

        // 4. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á
        const dist = calcDist(parseFloat(pickup.lat), parseFloat(pickup.lng), parseFloat(tempLat), parseFloat(tempLng));
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°
        if (isNaN(dist)) return alert('‚ùå ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)');

        // 5. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤
        const price = Math.ceil(basePrice + (dist * pricePerKm));

        // 6. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏õ‡∏¥‡∏î Modal
        modalActionType = 'create';
        pendingPayload = { 
            bill_id: bill, 
            pickup_id: pid, 
            lat: tempLat, 
            lng: tempLng,
            receiver_name: rName,
            receiver_phone: rPhone,
            note: note
        };
        
        pendingCopyText = `‡∏ö‡∏¥‡∏•: ${bill}\n‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: ${rName} (${rPhone})\n‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á : ${price} ‡∏ö‡∏≤‡∏ó`;
        
        const content = `
        <div class="modal-line"><span>üìÑ ‡∏ö‡∏¥‡∏•:</span> <b>${bill}</b></div>
        <div class="modal-line"><span>üë§ ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö:</span> <span>${rName || '-'}</span></div>
        <div class="modal-line"><span>üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå:</span> <span>${rPhone || '-'}</span></div>
        <div class="modal-line"><span>üìç ‡∏£‡∏±‡∏ö:</span> <span>${pickup.name}</span></div>
        <div class="modal-line"><span>üèÅ ‡∏™‡πà‡∏á:</span> <span>(‡∏´‡∏°‡∏∏‡∏î)</span></div>
        <div class="modal-line"><span>üìè ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á:</span> <span>~${dist.toFixed(2)} ‡∏Å‡∏°.</span></div>
        <hr style="margin: 5px 0; border:0; border-top:1px dashed #ddd;">
        <div class="modal-line" style="font-size:16px; color:var(--primary);"><span>üí∞ ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á:</span> <b>${price} ‡∏ö‡∏≤‡∏ó</b></div>
        `;
        
        document.getElementById('modal-title').innerText = "üì¶ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô";
        document.getElementById('modal-content').innerHTML = content;
        document.getElementById('confirm-modal').style.display = 'flex';
    }

    function prepareEditDest(jobId, jobDataStr) {
        currentJobId = jobId;
        currentEditJobData = JSON.parse(decodeURIComponent(jobDataStr));
        openMap('edit_dest');
    }

    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô NaN)
    function confirmEditDestPreview() {
        if (!currentEditJobData || !tempLat) return;

        // 1. ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß)
        const oldPrice = parseFloat(currentEditJobData.price) || 0;
        
        // ‡∏î‡∏∂‡∏á Config ‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ Default ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
        const basePrice = (config && config.base) ? parseFloat(config.base) : 40;
        const pricePerKm = (config && config.km) ? parseFloat(config.km) : 10;
        const changeFee = (config && config.change_fee) ? parseFloat(config.change_fee) : 30;

        // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
        const newDist = calcDist(
            parseFloat(currentEditJobData.pickup_lat), 
            parseFloat(currentEditJobData.pickup_lng), 
            parseFloat(tempLat), 
            parseFloat(tempLng)
        );

        if (isNaN(newDist)) return alert('‚ùå ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (‡∏•‡∏≠‡∏á‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà)');

        // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
        const newPurePrice = Math.ceil(basePrice + (newDist * pricePerKm));

        // 4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏¥‡∏î‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°
        const isPickedUp = (currentEditJobData.status === 'PICKED_UP');
        const fee = isPickedUp ? changeFee : 0;

        let finalPrice = 0;
        let priceDetailHtml = '';

        if (isPickedUp) {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß: ‡∏Ñ‡∏¥‡∏î‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏° + ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á (‡∏ñ‡πâ‡∏≤‡πÅ‡∏û‡∏á‡∏Ç‡∏∂‡πâ‡∏ô)
            // ‡∏™‡∏π‡∏ï‡∏£: ‡∏ñ‡πâ‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏û‡∏á‡∏Å‡∏ß‡πà‡∏≤ -> ‡∏Ñ‡∏¥‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà + 30
            //       ‡∏ñ‡πâ‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏ß‡πà‡∏≤ -> ‡∏¢‡∏∂‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏î‡∏¥‡∏° + 30 (‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á)
            finalPrice = (newPurePrice > oldPrice) ? (newPurePrice + fee) : (oldPrice + fee);
            
            pendingCopyText = `‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á : ${finalPrice - fee} ‡∏ö‡∏≤‡∏ó\n‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà : ${fee} ‡∏ö‡∏≤‡∏ó\n‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á : ${finalPrice} ‡∏ö‡∏≤‡∏ó`;
            priceDetailHtml = `
            <div class="modal-line"><span>üí∂ ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°:</span> <span>${oldPrice} ‡∏ö‡∏≤‡∏ó</span></div>
            <div class="modal-line"><span>üìè ‡∏£‡∏∞‡∏¢‡∏∞‡πÉ‡∏´‡∏°‡πà:</span> <span>~${newDist.toFixed(2)} ‡∏Å‡∏°.</span></div>
            <div class="modal-line" style="color:${config.primary || 'green'}"><span>‚ûï ‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</span> <b>${fee} ‡∏ö‡∏≤‡∏ó</b></div>
            <hr style="margin: 5px 0;">
            <div class="modal-line" style="font-size:16px; color:var(--primary);"><span>üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÉ‡∏´‡∏°‡πà:</span> <b>${finalPrice} ‡∏ö‡∏≤‡∏ó</b></div>
            `;
        } else {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å: ‡∏Ñ‡∏¥‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏•‡∏¢ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö)
            finalPrice = newPurePrice;
            
            pendingCopyText = `‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á : ${finalPrice} ‡∏ö‡∏≤‡∏ó`;
            priceDetailHtml = `
            <div class="modal-line"><span>üí∂ ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°:</span> <span>${oldPrice} ‡∏ö‡∏≤‡∏ó</span></div>
            <div class="modal-line"><span>üìè ‡∏£‡∏∞‡∏¢‡∏∞‡πÉ‡∏´‡∏°‡πà:</span> <span>~${newDist.toFixed(2)} ‡∏Å‡∏°.</span></div>
            <hr style="margin: 5px 0;">
            <div class="modal-line" style="font-size:16px; color:var(--primary);"><span>üí∞ ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà:</span> <b>${finalPrice} ‡∏ö‡∏≤‡∏ó</b></div>
            `;
        }
        
        modalActionType = 'edit_dest';
        pendingPayload = { job_id: currentJobId, lat: tempLat, lng: tempLng };
        
        const content = `
        <div class="modal-line"><span>üìÑ ‡∏ö‡∏¥‡∏•:</span> <b>${currentEditJobData.bill_id}</b></div>
        <div class="modal-line"><span>üèÅ ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà:</span> <span>(‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏Å)</span></div>
        <div style="background:#f9f9f9; padding:10px; border-radius:8px; margin-top:10px;">
            ${priceDetailHtml}
        </div>
        `;
        document.getElementById('modal-title').innerText = "‚úèÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á";
        document.getElementById('modal-content').innerHTML = content;
        document.getElementById('confirm-modal').style.display = 'flex';
    }

    // --- UTILS & MAP ---
    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î] ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏π‡πà‡∏™‡∏†‡∏≤‡∏û‡πÄ‡∏î‡∏¥‡∏°
    function closeModal() { 
        document.getElementById('confirm-modal').style.display = 'none'; 
        
        // 1. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏° Action (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡πÇ‡∏î‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏ö‡∏á‡∏≤‡∏ô)
        document.querySelector('.modal-actions').style.display = 'flex';

        // 2. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô Modal (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡πÇ‡∏î‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå)
        const actionBtns = document.querySelectorAll('.modal-actions button');
        if(actionBtns.length >= 2) {
            actionBtns[1].style.display = 'inline-block'; // ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
            actionBtns[0].innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç";            // ‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            actionBtns[1].innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô";           // ‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
        }
        
        // 3. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏° Copy
        setTimeout(() => {
            const btnCopy = document.querySelector('.btn-copy');
            if(btnCopy) btnCopy.style.display = 'block';
        }, 300);
    }
    function confirmAction() {
        // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
        if (modalActionType === 'create') {
            sendAction('create_job', pendingPayload);
        
        // 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        } else if (modalActionType === 'save_customer') {
            const name = document.getElementById('save-customer-name').value;
            if(!name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠');
            pendingPayload.save_name = name;
            sendAction('save_customer', pendingPayload);
            tg.close();

        // 3. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á
        } else if (modalActionType === 'edit_dest') {
            sendAction('edit_destination', pendingPayload);

        // 4. ‡∏à‡∏ö‡∏á‡∏≤‡∏ô (Rider)
        } else if (modalActionType === 'finish_job') {
            sendAction('req_finish', { job_id: currentJobId });
            tg.close();

        // 5. ‡∏Ñ‡∏•‡∏±‡∏á: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        } else if (modalActionType === 'warehouse_ready_all') {
            sendAction('warehouse_ready_all');

        // 6. ‡∏Ñ‡∏•‡∏±‡∏á: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        } else if (modalActionType === 'warehouse_ready_selected') {
            sendAction('warehouse_ready_selected', pendingPayload);

        // 7. ‡∏Ñ‡∏•‡∏±‡∏á: ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô
        } else if (modalActionType === 'warehouse_cancel') {
            sendAction('warehouse_cancel', { job_id: currentJobId });

        // 8. Pool: ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        } else if (modalActionType === 'release_pool_selected') {
            sendAction('release_pool_selected', pendingPayload);

        // 9. Pool: ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô
        } else if (modalActionType === 'pool_cancel') {
            sendAction('pool_cancel', pendingPayload);

        // 10. ‚úÖ ‡πÇ‡∏ó‡∏£‡∏≠‡∏≠‡∏Å (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà: ‡πÉ‡∏ä‡πâ Ghost Link + ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£)
        } else if (modalActionType === 'call_phone') {
            if(pendingPhone) {
                // ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏ï‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞ + (‡πÄ‡∏ä‡πà‡∏ô 081-123-4567 -> 0811234567)
                const cleanNumber = pendingPhone.replace(/[^0-9+]/g, '');
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå <a> ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏´‡∏•‡∏≠‡∏Å‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏±‡πà‡∏á‡∏Å‡∏î‡∏Ñ‡∏•‡∏¥‡∏Å
                const a = document.createElement('a');
                a.href = `tel:${cleanNumber}`;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click(); // ‡∏™‡∏±‡πà‡∏á‡∏Å‡∏î
                setTimeout(() => document.body.removeChild(a), 100); // ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á
            } else {
                alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå");
            }
        }
        
        closeModal();
        // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏° Copy ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏¥‡∏î Modal
        setTimeout(() => {
            const btnCopy = document.querySelector('.btn-copy');
            if(btnCopy) btnCopy.style.display = 'block';
        }, 300);
    }
    
    function copyShippingPrice() {
        const el = document.createElement('textarea');
        el.value = pendingCopyText;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        const btn = document.querySelector('.btn-copy');
        const oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-check"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
        setTimeout(() => btn.innerHTML = oldText, 2000);
    }

    function openMap(mode) {
        mapMode = mode;
        document.getElementById('map-overlay').style.display = 'flex';
        document.getElementById('search-box-overlay').value = '';
        document.getElementById('btn-confirm-loc').disabled = true;
        if (!mapsLoaded) initMap();
    }
    function closeMap() { document.getElementById('map-overlay').style.display = 'none'; }
    
    function initMap() {
        const bangkok = { lat: 13.7563, lng: 100.5018 };
        map = new google.maps.Map(document.getElementById("map-fullscreen"), {
            zoom: 15, center: bangkok, disableDefaultUI: true, gestureHandling: "greedy"
        });
        const input = document.getElementById("search-box-overlay");
        const ac = new google.maps.places.Autocomplete(input);
        ac.bindTo("bounds", map);
        ac.addListener("place_changed", () => {
            const p = ac.getPlace();
            if (p.geometry) {
                if (p.geometry.viewport) map.fitBounds(p.geometry.viewport);
                else { map.setCenter(p.geometry.location); map.setZoom(17); }
                placeMarker(p.geometry.location);
            }
        });
        map.addListener("click", (e) => placeMarker(e.latLng));
        mapsLoaded = true;
    }
    
    function placeMarker(loc) {
        if (marker) marker.setMap(null);
        marker = new google.maps.Marker({ position: loc, map: map });
        tempLat = loc.lat();
        tempLng = loc.lng();
        document.getElementById('btn-confirm-loc').disabled = false;
        document.getElementById('map-status-text').innerText = `‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${tempLat.toFixed(4)}, ${tempLng.toFixed(4)}`;
    }
    
    document.getElementById('btn-confirm-loc').addEventListener('click', () => {
        closeMap();
        if (mapMode === 'pickup') {
            document.getElementById('pickup-search-input').value = `${tempLat.toFixed(4)}, ${tempLng.toFixed(4)}`;
            showStaticMap('preview-pickup', tempLat, tempLng);
        } else if (mapMode === 'job') {
            document.getElementById('job-search-input').value = `${tempLat.toFixed(4)}, ${tempLng.toFixed(4)}`;
            showStaticMap('preview-job', tempLat, tempLng);
        } else if (mapMode === 'edit_dest') {
            confirmEditDestPreview();
        } else if (mapMode === 'customer') { 
            document.getElementById('cust-search-input').value = `${tempLat.toFixed(4)}, ${tempLng.toFixed(4)}`;
            showStaticMap('preview-customer', tempLat, tempLng);
        }
    });
    
    function showStaticMap(elemId, lat, lng) {
        const el = document.getElementById(elemId);
        el.style.display = 'block';
        el.innerHTML = `<div style="width:100%; height:100%; background:#e0e0e0; display:flex; align-items:center; justify-content:center; flex-direction:column;">
            <i class="fa-solid fa-map-location-dot" style="font-size:30px; color:${elemId.includes('pickup')?'red':'blue'};"></i>
            <span style="font-size:12px; margin-top:5px;">${lat.toFixed(4)}, ${lng.toFixed(4)}</span>
        </div>`;
    }

    function sendAction(action, payload={}) { tg.sendData(JSON.stringify({ action, ...payload })); }
    function cancelJob(id) { const r = prompt("‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:"); if(r) sendAction('cancel_job', {job_id: id, reason: r}); }
    function confirmSOS() { if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô SOS?")) sendAction('sos'); }
    function calcDist(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180; 
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        return R * c; 
    }

    // --- AUTO FOCUS LOGIC ---
    function setupFormNavigation() {
        // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ID ‡∏Ç‡∏≠‡∏á Input ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö
        const inputs = ['job-bill-id', 'job-recv-name', 'job-recv-phone', 'job-note'];

        inputs.forEach((id, index) => {
            const el = document.getElementById(id);
            if (!el) return;

            el.addEventListener('keydown', (e) => {
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Enter (code 13)
                if (e.key === 'Enter' || e.keyCode === 13) {
                    e.preventDefault(); // ‡∏´‡πâ‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î Action ‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÄ‡∏ä‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà)

                    if (index < inputs.length - 1) {
                        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≤‡∏¢ Focus ‡πÑ‡∏õ‡∏ä‡πà‡∏≠‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                        const nextEl = document.getElementById(inputs[index + 1]);
                        if (nextEl) nextEl.focus();
                    } else {
                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ (job-note) ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô
                        el.blur(); 
                        submitJob();
                    }
                }
            });
        });
    }

    function renderWarehouseList(list) {
        const el = document.getElementById('warehouse-list');
        if(!list || list.length === 0) { 
            el.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á (‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß)</div>'; 
            return; 
        }

        // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î
        let html = list.map(j => {
            const isSel = selectedJobs.has(j.job_id) ? 'selected' : '';
            return `
            <div class="card ${isSel}" style="border-left: 4px solid #ffc107; cursor:pointer; position:relative;" onclick="toggleSelectJob('${j.job_id}')">
                <i class="fa-solid fa-circle-check select-check"></i>
                <div class="card-header">üì¶ #${j.order_no} | ${j.bill_id}</div>
                <div class="card-row">üë§ ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: ${j.receiver_name}</div>
                <div class="card-row">üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${j.receiver_phone}</div>
                <div class="card-actions" onclick="event.stopPropagation()"> <button class="btn btn-outline btn-sm" style="color:var(--danger); border-color:var(--danger); width:30%; margin-right:5px;" onclick="confirmWarehouseCancel('${j.job_id}', '${j.bill_id}')">
                        ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button class="btn btn-primary btn-sm" style="width:70%;" onclick="sendAction('warehouse_ready_one', {job_id: '${j.job_id}', bill_id: '${j.bill_id}'})">
                        ‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß
                    </button>
                </div>
            </div>
            `;
        }).join('');

        // 2. Logic ‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á (Batch Button)
        const count = selectedJobs.size;
        let btnText = `üöÄ ‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${list.length})`;
        let btnAction = `confirmWarehouseReadyAll(${list.length})`;
        let btnColor = "btn-finish"; // ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á

        if (count > 0) {
            btnText = `‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á (${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
            btnAction = `confirmWarehouseReadySelected()`;
            btnColor = "btn-primary"; // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà)
        }

        html += `
        <div style="padding: 10px 0; position:sticky; bottom:0; background:var(--bg); z-index:100; border-top:1px solid #ddd;">
            <button class="btn ${btnColor}" onclick="${btnAction}">
                ${btnText}
            </button>
        </div>`;

        el.innerHTML = html;
    }

    // 1.4 ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Toggle (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
    function toggleSelectJob(jobId) {
        if (selectedJobs.has(jobId)) {
            selectedJobs.delete(jobId);
        } else {
            selectedJobs.add(jobId);
        }
        // Re-render ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° data.warehouse_jobs)
        renderWarehouseList(data.warehouse_jobs);
    }

    function confirmWarehouseReadySelected() {
        if (selectedJobs.size === 0) return;
        
        modalActionType = 'warehouse_ready_selected';
        // ‡πÅ‡∏õ‡∏•‡∏á Set ‡πÄ‡∏õ‡πá‡∏ô Array ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ
        pendingPayload = { job_ids: Array.from(selectedJobs) };
        
        const content = `
            <div style="text-align:center; padding:10px;">
                <i class="fa-solid fa-check-double" style="font-size:40px; color:var(--primary); margin-bottom:10px;"></i>
                <p style="font-size:16px; font-weight:bold;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ${selectedJobs.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?</p>
                <p style="font-size:12px; color:#666;">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏á‡∏≤‡∏ô</p>
            </div>
        `;
        
        document.getElementById('modal-title').innerText = "üì¶ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å";
        document.getElementById('modal-content').innerHTML = content;
        document.querySelector('.btn-copy').style.display = 'none';
        document.getElementById('confirm-modal').style.display = 'flex';
    }

    function confirmWarehouseCancel(jobId, billId) {
        currentJobId = jobId;
        modalActionType = 'warehouse_cancel';
        
        const content = `
            <div style="text-align:center; padding:10px;">
                <i class="fa-solid fa-circle-xmark" style="font-size:40px; color:#dc3545; margin-bottom:10px;"></i>
                <p style="font-size:16px; font-weight:bold;">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå?</p>
                <p>‡∏ö‡∏¥‡∏•: <b>${billId}</b></p>
                <hr style="margin:10px 0; border:0; border-top:1px dashed #ddd;">
                <p style="font-size:12px; color:#666;">(‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)</p>
            </div>
        `;
        
        document.getElementById('modal-title').innerText = "‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å";
        document.getElementById('modal-content').innerHTML = content;
        document.querySelector('.btn-copy').style.display = 'none';
        document.getElementById('confirm-modal').style.display = 'flex';
    }

    function confirmWarehouseReadyAll(count) {
        modalActionType = 'warehouse_ready_all';
        // ‡πÉ‡∏ä‡πâ pendingPayload ‡∏´‡∏•‡∏≠‡∏Å‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡πá‡πÑ‡∏î‡πâ
        pendingPayload = {}; 
        
        const content = `
            <div style="text-align:center; padding:10px;">
                <i class="fa-solid fa-boxes-packing" style="font-size:40px; color:#FFC107; margin-bottom:10px;"></i>
                <p style="font-size:16px; font-weight:bold;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°?</p>
                <p>‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <b>${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</b> ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                <hr style="margin:10px 0; border:0; border-top:1px dashed #ddd;">
                <p style="font-size:12px; color:#666;">(‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)</p>
            </div>
        `;
        
        document.getElementById('modal-title').innerText = "üì¶ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á";
        document.getElementById('modal-content').innerHTML = content;
        document.querySelector('.btn-copy').style.display = 'none';
        document.getElementById('confirm-modal').style.display = 'flex';
    }

    // 2. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -> ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
    function selectSavedCustomer(custId) {
        if(!custId) return;
        const customer = data.saved_customers.find(c => c.id === custId);
        if(!customer) return;

        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        document.getElementById('job-recv-name').value = customer.receiver_name;
        document.getElementById('job-recv-phone').value = customer.receiver_phone;
        
        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î
        tempLat = customer.lat;
        tempLng = customer.lng;
        document.getElementById('job-search-input').value = `${tempLat.toFixed(4)}, ${tempLng.toFixed(4)}`;
        showStaticMap('preview-job', tempLat, tempLng);
        
        // Focus ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏• (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏á‡∏Å‡πá‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà)
        document.getElementById('job-bill-id').focus();
    }

    // 3. ‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -> ‡πÅ‡∏™‡∏î‡∏á Modal
    function promptSaveCustomer() {
        const rName = document.getElementById('job-recv-name').value;
        const rPhone = document.getElementById('job-recv-phone').value;
        
        if(!tempLat || !rName) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
            return;
        }

        modalActionType = 'save_customer';
        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏™‡πà‡∏á
        pendingPayload = { 
            receiver_name: rName, 
            receiver_phone: rPhone, 
            lat: tempLat, 
            lng: tempLng 
        };

        const content = `
            <div class="form-group">
                <label class="form-label">‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</label>
                <input type="text" id="save-customer-name" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ A01" style="width:100%; border:1px solid #ccc;">
            </div>
            <div style="font-size:12px; color:#666; margin-top:5px;">
                ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: ${rName}<br>‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${rPhone}
            </div>
        `;
        
        document.getElementById('modal-title').innerText = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤";
        document.getElementById('modal-content').innerHTML = content;
        document.querySelector('.btn-copy').style.display = 'none';
        document.getElementById('confirm-modal').style.display = 'flex';
        
        // Focus ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠
        setTimeout(() => document.getElementById('save-customer-name').focus(), 100);
    }

    // --- ‚úÖ‚úÖ‚úÖ [‡∏ß‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏•‡∏á‡πÑ‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö] CUSTOMER LOGIC ‚úÖ‚úÖ‚úÖ ---
    let editCustomerId = null;

    // 1. ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° Role)
    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (Search)
    function renderCustomerList() {
        const list = data.saved_customers || [];
        const el = document.getElementById('customer-list');
        const myId = data.id;
    
        // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        const searchInput = document.getElementById('customer-filter-input');
        const keyword = searchInput ? searchInput.value.toLowerCase().trim() : '';

        // ‡∏Å‡∏£‡∏≠‡∏á 1: ‡∏ï‡∏≤‡∏° Role ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á
        let filtered = list.filter(c => {
            if (['SUPERADMIN', 'SUPERVISOR'].includes(data.role)) return true;
            if (data.role === 'ADMIN') return c.created_by === myId;
            return false;
        });

        // ‡∏Å‡∏£‡∏≠‡∏á 2: ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏Ñ‡πâ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å, ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö, ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£)
        if (keyword) {
            filtered = filtered.filter(c => 
             c.name.toLowerCase().includes(keyword) || 
                (c.receiver_name && c.receiver_name.toLowerCase().includes(keyword)) ||
                (c.receiver_phone && c.receiver_phone.includes(keyword))
            );
        }

        if(filtered.length === 0) { 
            el.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>'; 
            return; 
        }

        el.innerHTML = filtered.map(c => `
        <div class="card" style="position:relative;">
            <div class="card-header"><i class="fa-solid fa-user-tag"></i> ${c.name}</div>
            <div class="card-row">üë§ ${c.receiver_name || '-'} | üìû ${c.receiver_phone || '-'}</div>
            <div class="card-actions">
                <button class="btn-icon" onclick="editCustomer('${c.id}')"><i class="fa-solid fa-pen"></i></button>
                <button class="btn-icon delete" onclick="if(confirm('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?')) sendAction('delete_customer', {id: '${c.id}'})"><i class="fa-solid fa-trash"></i></button>
            </div>
        </div>
        `).join('');
    }

    // 2. ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
    function goToAddCustomer() {
        editCustomerId = null;
        document.getElementById('customer-form-title').innerText = "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà";
        
        // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
        document.getElementById('cust-save-name').value = '';
        document.getElementById('cust-recv-name').value = '';
        document.getElementById('cust-recv-phone').value = '';
        document.getElementById('cust-search-input').value = '';
        document.getElementById('preview-customer').innerHTML = '<div class="map-preview-placeholder">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>';
        tempLat = null; tempLng = null;
        
        goToPage('add-customer');
    }

    // 3. ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏°‡∏≤‡πÉ‡∏™‡πà)
    function editCustomer(id) {
        const c = data.saved_customers.find(x => x.id === id);
        if(!c) return;

        editCustomerId = id;
        document.getElementById('customer-form-title').innerText = "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤";
        
        document.getElementById('cust-save-name').value = c.name;
        document.getElementById('cust-recv-name').value = c.receiver_name;
        document.getElementById('cust-recv-phone').value = c.receiver_phone;
        
        tempLat = c.lat;
        tempLng = c.lng;
        document.getElementById('cust-search-input').value = `${c.lat}, ${c.lng}`;
        showStaticMap('preview-customer', c.lat, c.lng);
        
        goToPage('add-customer');
    }

    // 4. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    function saveCustomerForm() {
        const name = document.getElementById('cust-save-name').value;
        const rName = document.getElementById('cust-recv-name').value;
        const rPhone = document.getElementById('cust-recv-phone').value;

        if(!name || !tempLat) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà');

        const payload = {
            save_name: name,
            receiver_name: rName,
            receiver_phone: rPhone,
            lat: tempLat,
            lng: tempLng
        };

        if(editCustomerId) {
            payload.id = editCustomerId; // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ID ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        }

        sendAction('save_customer', payload);
    }

    function setupCustomerSearch() {
        const list = data.saved_customers || [];
        const sel = document.getElementById('customer-search-select');
        if(!sel) return;

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Option ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
        let html = '<option value="">-- ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>';
        html += list.map(c => `<option value="${c.id}">${c.name} (${c.receiver_name || '-'})</option>`).join('');
        sel.innerHTML = html;

        // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Select2 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        $(sel).select2({
            placeholder: "üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...",
            allowClear: true,
            dropdownParent: $('#view-create-job') // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ view
        });

        // ‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Event ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        $(sel).on('change', function() {
            selectSavedCustomer(this.value);
        });
    }

    // 2. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ -> ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    function onCustomerSelected(input) {
        const val = input.value;
        if(!val) return;
        const customer = (data.saved_customers || []).find(c => `${c.name} (${c.receiver_name})` === val);
        
        if(customer) {
            document.getElementById('job-recv-name').value = customer.receiver_name || '';
            document.getElementById('job-recv-phone').value = customer.receiver_phone || '';
            tempLat = customer.lat;
            tempLng = customer.lng;
            document.getElementById('job-search-input').value = `${tempLat.toFixed(4)}, ${tempLng.toFixed(4)}`;
            showStaticMap('preview-job', tempLat, tempLng);
            document.getElementById('job-bill-id').focus();
            
            // ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏™‡∏∞‡∏≠‡∏≤‡∏î (Option)
            input.value = ''; 
            input.placeholder = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${customer.name} ‡πÅ‡∏•‡πâ‡∏ß`;
        }
    }

    // 3. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -> ‡πÅ‡∏™‡∏î‡∏á Modal
    function promptSaveCustomer() {
        const rName = document.getElementById('job-recv-name').value;
        const rPhone = document.getElementById('job-recv-phone').value;
        
        if(!tempLat || !rName) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
            return;
        }

        modalActionType = 'save_customer';
        pendingPayload = { 
            receiver_name: rName, 
            receiver_phone: rPhone, 
            lat: tempLat, 
            lng: tempLng 
        };

        const content = `
            <div class="form-group">
                <label class="form-label">‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</label>
                <input type="text" id="save-customer-name" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ A01" style="width:100%; border:1px solid #ccc; padding:8px;">
            </div>
            <div style="font-size:12px; color:#666; margin-top:5px;">
                ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: ${rName}<br>‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${rPhone}
            </div>
        `;
        
        document.getElementById('modal-title').innerText = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤";
        document.getElementById('modal-content').innerHTML = content;
        document.querySelector('.btn-copy').style.display = 'none';
        document.getElementById('confirm-modal').style.display = 'flex';
        
        setTimeout(() => document.getElementById('save-customer-name').focus(), 100);
    }

    // [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü
    function renderReport() {
        const stats = data.analytics || [];
        if(stats.length === 0) return;

        // 1. ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏£‡∏ß‡∏°
        const totalRev = stats.reduce((sum, d) => sum + d.revenue, 0);
        const totalJobs = stats.reduce((sum, d) => sum + d.count, 0);
    
        document.getElementById('report-total-rev').innerText = totalRev.toLocaleString() + " ‡∏ø";
        document.getElementById('report-total-jobs').innerText = totalJobs + " ‡∏á‡∏≤‡∏ô";

        // 2. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏≤‡∏ü
        const labels = stats.map(d => d.date);
        const revenues = stats.map(d => d.revenue);
        const counts = stats.map(d => d.count);

        // 3. ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü (Chart.js)
        const ctx = document.getElementById('revenueChart').getContext('2d');
    
        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô)
        if(window.myChart) window.myChart.destroy();

        window.myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)',
                        data: revenues,
                        borderColor: '#00B900',
                        backgroundColor: 'rgba(0, 185, 0, 0.1)',
                        yAxisID: 'y',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô',
                        data: counts,
                        borderColor: '#ffc107',
                        backgroundColor: 'transparent',
                        yAxisID: 'y1',
                        borderDash: [5, 5],
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y: { type: 'linear', display: true, position: 'left', beginAtZero: true },
                    y1: { type: 'linear', display: false, position: 'right', grid: { drawOnChartArea: false } }
                }
            }
        });
    }

    // [‡πÄ‡∏û‡∏¥‡πà‡∏°] Helper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Toggle Detail ‡πÉ‡∏ô Wallet
    function toggleTxDetail(id) {
        const el = document.getElementById('tx-detail-' + id);
        if (el) {
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }
    }

    // [‡πÄ‡∏û‡∏¥‡πà‡∏°] Helper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Toggle Total Income
    function toggleTotalIncome() {
        const valEl = document.getElementById('wallet-total-income-val');
        if (valEl) {
            valEl.style.display = valEl.style.display === 'none' ? 'block' : 'none';
        }
    }

    // [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï renderWallet ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞ Total Income
    function renderWallet() {
        const w = data.wallet;
        if(!w) return;

        document.getElementById('wallet-balance').innerText = w.balance.toLocaleString(undefined, {minimumFractionDigits: 2});

        // 1. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
        const bank = data.bank_info;
        const walletCard = document.querySelector('#view-wallet .card'); 
        
        // ‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢ append ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≥
        const oldBankInfo = document.getElementById('wallet-bank-display');
        if(oldBankInfo) oldBankInfo.remove();
        const oldTotalInc = document.getElementById('wallet-total-income');
        if(oldTotalInc) oldTotalInc.remove();

        // 1.1 ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏° (Total Income)
        if (w.total_income !== undefined) {
            const totalHtml = `
            <div id="wallet-total-income" style="margin-top:15px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.3); cursor:pointer;" onclick="toggleTotalIncome()">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-size:12px; opacity:0.9;">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    <i class="fa-solid fa-chevron-down" style="font-size:10px;"></i>
                </div>
                <div id="wallet-total-income-val" style="font-size:18px; font-weight:bold; margin-top:5px; display:none;">${w.total_income.toLocaleString()} ‡∏ø</div>
            </div>`;
            walletCard.insertAdjacentHTML('beforeend', totalHtml);
        }

        // 1.2 ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
        let bankHtml = '';
        if(bank && bank.acc_no) {
            bankHtml = `
                <div id="wallet-bank-display" style="margin-top:15px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.3);">
                    <div style="font-size:12px; opacity:0.9; margin-bottom:5px;">üè¶ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô:</div>
                    <div style="font-size:14px; font-weight:bold;">${bank.name} - ${bank.acc_no}</div>
                    <div style="font-size:13px;">${bank.acc_name}</div>
                    <button class="btn btn-outline btn-sm" style="color:white; border-color:white; margin-top:8px; width:auto;" onclick="nav('bank')"><i class="fa-solid fa-pen"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
                </div>`;
        } else {
            bankHtml = `<div id="wallet-bank-display" style="margin-top:15px;"><button class="btn btn-warning btn-sm" style="color:#333; font-weight:bold;" onclick="nav('bank')"><i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</button></div>`;
        }
        walletCard.insertAdjacentHTML('beforeend', bankHtml);

        // 2. ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏°‡∏µ Detail)
        const el = document.getElementById('wallet-history-list');
        if(w.history.length === 0) { el.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>'; return; }

        el.innerHTML = w.history.map(t => {
            const isIncome = t.type === 'INCOME' || t.type === 'REFUND';
            let color = isIncome ? '#00B900' : '#dc3545';
            let sign = isIncome ? '+' : '';
            let icon = isIncome ? 'fa-circle-arrow-down' : 'fa-circle-arrow-up';
            if (t.type === 'REFUND') icon = 'fa-rotate-left';
        
            // Note: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤ REJECTED ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ
            if (t.status === 'REJECTED') {
                color = '#dc3545'; 
            }
            
            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Detail HTML
            let detailHtml = '';
            
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô (WITHDRAW)
            if (t.type === 'WITHDRAW') {
                if (t.status === 'COMPLETED' && t.slip) {
                    detailHtml += `<div style="margin-top:10px;"><a href="${t.slip}" target="_blank" class="btn btn-outline btn-sm" style="width:100%;">üìÑ ‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</a></div>`;
                } else if (t.status === 'REJECTED' && t.note) {
                    detailHtml += `<div style="margin-top:10px; padding:8px; background:#fff3cd; border-radius:5px; font-size:12px; color:#856404;"><i class="fa-solid fa-circle-exclamation"></i> <b>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò:</b> ${t.note}</div>`;
                }
            }

            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Detail ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á Icon Chevron
            const hasDetail = detailHtml !== '';
            const chevron = hasDetail ? `<i class="fa-solid fa-chevron-down" style="color:#ccc; font-size:12px;"></i>` : '';
            const onClickAttr = hasDetail ? `onclick="toggleTxDetail('${t.id}')"` : '';

            // ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ Icon ‡∏ñ‡πâ‡∏≤ Rejected
            if (t.status === 'REJECTED') {
                 icon = 'fa-circle-xmark';
                 color = '#FFC107'; 
            }

            return `
            <div class="card" ${onClickAttr} style="cursor:pointer;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <i class="fa-solid ${icon}" style="font-size:24px; color:${color};"></i>
                        <div>
                            <div style="font-weight:bold;">${t.note || t.type}</div>
                            <div style="font-size:10px; color:#888;">${t.date} <span class="role-badge" style="font-size:9px;">${t.status}</span></div>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:bold; color:${color}; font-size:16px;">${sign}${t.amount.toLocaleString()} ‡∏ø</div>
                        ${chevron}
                    </div>
                </div>
                <div id="tx-detail-${t.id}" style="display:none; margin-top:10px; border-top:1px dashed #eee; padding-top:10px;">
                    <div style="font-size:12px; color:#666;">Ref: ${t.id}</div>
                    ${detailHtml}
                </div>
            </div>`;
        }).join('');
    }

    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô)
    function requestWithdraw() {
        // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô
        const balance = parseFloat(document.getElementById('wallet-balance').innerText.replace(/,/g, ''));
        if(balance <= 0) return alert('‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô');

        // 2. [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?
        const bank = data.bank_info;
        if (!bank || !bank.acc_no) {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏´‡∏°
            if(confirm('‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                nav('bank'); // ‡∏û‡∏≤‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
            }
            return; // ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏≠‡∏ô
        }

        // 3. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß)
        if(confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${balance.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ${bank.name} - ${bank.acc_no}?`)) {
            sendAction('withdraw_request', { amount: balance });
        }
    }

    // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (Rider)
    function saveBankInfo() {
        const bank = document.getElementById('bank-name').value;
        const no = document.getElementById('bank-acc-no').value;
        const name = document.getElementById('bank-acc-name').value;
    
        if(!no || !name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
    
        sendAction('save_bank_info', {
            bank_name: bank,
            bank_acc_no: no,
            bank_acc_name: name
        });
    }

    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (SuperAdmin) ‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏£‡∏ö
    function renderFinance(tab) {
        const el = document.getElementById('finance-list');
        const f = data.finance; 
        
        if(!f) { el.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>'; return; }

        if(tab === 'pending') {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
            if(!f.pending || f.pending.length === 0) {
                el.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>';
                return;
            }
            el.innerHTML = f.pending.map(t => `
                <div class="card" style="border-left: 4px solid #ffc107;" id="card-${t.id}">
                    <div class="card-header">üí∏ ‡∏ñ‡∏≠‡∏ô: ${t.amount.toLocaleString()} ‡∏ø</div>
                    <div class="card-row">üë§ ‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå: <b>${t.rider_name}</b></div>
                    
                    <div class="card-row" style="background:#f8f9fa; padding:10px; border-radius:8px; margin:5px 0; border:1px dashed #ddd; display:flex; justify-content:space-between; align-items:center;">
                        <div>üè¶ <b>${t.bank_info}</b></div>
                        <button class="btn-icon" onclick="copyText('${t.acc_no}')" style="background:#e0e0e0; border-radius:5px; width:30px; height:30px; display:flex; align-items:center; justify-content:center;">
                            <i class="fa-solid fa-copy"></i>
                        </button>
                    </div>
                    
                    <div class="card-row"><small>üïí ${t.date}</small></div>

                    <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                        <label style="font-size:12px; font-weight:bold;">üì∏ ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</label>
                        <input type="file" id="slip-input-${t.id}" accept="image/*" style="font-size:12px; padding:5px; width:100%;">
                        <div id="upload-status-${t.id}" style="font-size:11px; color:#888;"></div>
                    </div>

                    <div class="card-actions" style="margin-top:15px; display:flex; gap:10px;">
                        <button class="btn btn-outline btn-sm" style="color:var(--danger); border-color:var(--danger); flex:1;" onclick="processWithdraw('${t.id}', 'REJECT')">
                            ‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
                        </button>
                        <button class="btn btn-primary btn-sm" style="flex:1;" onclick="processWithdraw('${t.id}', 'APPROVE')">
                            ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÇ‡∏≠‡∏ô
                        </button>
                    </div>
                </div>
            `).join('');
            
        } else {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
            if(!f.history || f.history.length === 0) {
                el.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>';
                return;
            }
            el.innerHTML = f.history.map(t => `
                <div class="card" style="opacity:0.8; border-left: 4px solid ${t.status==='COMPLETED'?'#00B900':'#dc3545'};">
                    <div class="card-header">
                        ${t.amount.toLocaleString()} ‡∏ø 
                        <span class="role-badge">${t.status}</span>
                    </div>
                    <div class="card-row">üë§ ${t.rider_name} | üïí ${t.date}</div>
                    ${t.slip ? `<div style="margin-top:5px;"><a href="${t.slip}" target="_blank" class="btn btn-outline btn-sm" style="width:100%; text-decoration:none;">üìÑ ‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</a></div>` : ''}
                </div>
            `).join('');
        }
    }

    // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö Tab ‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô
    function switchFinanceTab(tab) {
        // ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°
        document.getElementById('btn-tab-pending').className = tab === 'pending' ? 'btn btn-primary' : 'btn btn-outline';
        document.getElementById('btn-tab-history').className = tab === 'history' ? 'btn btn-primary' : 'btn btn-outline';
        renderFinance(tab);
    }

    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÉ‡∏ä‡πâ showToast ‡πÅ‡∏ó‡∏ô alert
    function copyText(text) {
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                showToast("‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"); // <--- ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
            }).catch(err => {
                console.error('Async failed', err);
                fallbackCopyText(text);
            });
        } else {
            fallbackCopyText(text);
        }
    }

    function fallbackCopyText(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed"; // ‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡∏Å
        textArea.style.opacity = "0";
        
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            const successful = document.execCommand('copy');
            if(successful) showToast("‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"); // <--- ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
            else showToast("‚ùå ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        } catch (err) {
            console.error('Fallback failed', err);
            alert("‚ùå ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å"); // ‡∏Å‡∏£‡∏ì‡∏µ Error ‡∏´‡∏ô‡∏±‡∏Å‡πÜ ‡∏≠‡∏≤‡∏à‡∏¢‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ alert ‡∏ä‡πà‡∏ß‡∏¢
        }

        document.body.removeChild(textArea);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ)
    async function processWithdraw(txId, decision) {
        if (decision === 'REJECT') {
            const reason = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ):");
            if (reason === null) return; // ‡∏Å‡∏î Cancel
            if (!reason.trim()) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö");

            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: "${reason}"?`)) return;
            
            sendAction('admin_process_withdraw', { tx_id: txId, decision: 'REJECT', reason: reason });
            return;
        }

        // ‡∏Å‡∏£‡∏ì‡∏µ APPROVE: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏•‡∏¥‡∏õ
        const fileInput = document.getElementById(`slip-input-${txId}`);
        const file = fileInput.files[0];

        if (!file) {
            return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
        }

        if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏•‡∏¥‡∏õ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á?')) return;

        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
        const statusEl = document.getElementById(`upload-status-${txId}`);
        statusEl.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ...";
        statusEl.style.color = "blue";

        try {
            // 1. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ Cloudinary ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (Client-side upload)
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', UPLOAD_PRESET); // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô

            const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                method: 'POST',
                body: formData
            });

            const resData = await response.json();
            
            if (resData.secure_url) {
                // 2. ‡πÑ‡∏î‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÉ‡∏´‡πâ Bot ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                sendAction('admin_process_withdraw', { 
                    tx_id: txId, 
                    decision: 'APPROVE',
                    slip_url: resData.secure_url
                });
                statusEl.innerText = "‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!";
                statusEl.style.color = "green";
            } else {
                throw new Error("Upload failed");
            }

        } catch (error) {
            console.error(error);
            statusEl.innerText = "‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ô‡πá‡∏ï ‡∏´‡∏£‡∏∑‡∏≠ Cloud Name)";
            statusEl.style.color = "red";
            alert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
        }
    }

    // [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö Fade
    function showToast(message) {
        const x = document.getElementById("toast");
        x.innerText = message;
        x.className = "show";
        
        // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
        setTimeout(function(){ 
            x.className = x.className.replace("show", ""); 
        }, 2000);
    }

    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Modal ‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° Link ‡∏à‡∏£‡∏¥‡∏á 100%)
    function promptCall(phone) {
        // 1. ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î (‡πÄ‡∏≠‡∏≤‡∏Ç‡∏µ‡∏î/‡∏ß‡∏£‡∏£‡∏Ñ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏ï‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞ +)
        const cleanNumber = phone.replace(/[^0-9+]/g, '');
        
        // 2. ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô" ‡∏≠‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡∏Ç‡∏≠‡∏á Modal (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏°‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡πÇ‡∏ó‡∏£‡πÅ‡∏•‡πâ‡∏ß)
        const actionBtns = document.querySelectorAll('.modal-actions button');
        if(actionBtns.length >= 2) {
            actionBtns[1].style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡∏ï‡∏±‡∏ß‡∏Ç‡∏ß‡∏≤)
            actionBtns[0].innerText = "‡∏õ‡∏¥‡∏î";      // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (‡∏ï‡∏±‡∏ß‡∏ã‡πâ‡∏≤‡∏¢) ‡πÄ‡∏õ‡πá‡∏ô "‡∏õ‡∏¥‡∏î"
        }
        
        // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° Copy ‡∏î‡πâ‡∏ß‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        const btnCopy = document.querySelector('.btn-copy');
        if(btnCopy) btnCopy.style.display = 'none';

        // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ Modal ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏° Link ‡∏à‡∏£‡∏¥‡∏á‡πÜ (<a href="tel:...">)
        // ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç! ‡∏°‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô <a> ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà <button> Browser ‡∏à‡∏∂‡∏á‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÇ‡∏ó‡∏£
        const content = `
            <div style="text-align:center; padding:20px;">
                <div style="font-size:24px; font-weight:bold; color:#333; margin-bottom:20px;">${phone}</div>
                
                <a href="tel:${cleanNumber}" class="btn btn-primary" style="text-decoration:none; display:flex; align-items:center; justify-content:center; gap:10px; font-size:18px; padding:15px; border-radius:10px;">
                    <i class="fa-solid fa-phone-volume"></i> ‡πÇ‡∏ó‡∏£‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                </a>
            </div>
        `;

        document.getElementById('modal-title').innerText = "üìû ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£";
        document.getElementById('modal-content').innerHTML = content;
        document.getElementById('confirm-modal').style.display = 'flex';
    }

    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î] ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ú‡πà‡∏≤‡∏ô‡∏ö‡∏≠‡∏ó (Work 100%)
    function showInlineCall(cleanPhone, originalPhone, custName) {
        const el = document.getElementById('phone-wrapper');
        if(!el) return;

        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏° "‡∏™‡πà‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ä‡∏ó"
        el.innerHTML = `
            <div style="font-size:14px; margin-bottom:5px; color:var(--primary); font-weight:bold;">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠?</div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary" onclick="requestCallFromBot('${originalPhone}', '${custName || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'}')" style="flex:1;">
                    <i class="fa-solid fa-paper-plane"></i> ‡∏™‡πà‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ä‡∏ó
                </button>
                
                <button class="btn btn-danger" onclick="resetPhoneDisplay('${cleanPhone}', '${originalPhone}')" style="width:80px;">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
            <div style="font-size:10px; color:#999; margin-top:5px; text-align:center;">
                (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á Contact Card ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏î‡πÇ‡∏ó‡∏£‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó)
            </div>
        `;
    }

    // [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏¥‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏´‡∏≤‡∏ö‡∏≠‡∏ó
    function requestCallFromBot(phone, name) {
        sendAction('request_call', { phone: phone, name: name });
        // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ß‡∏¢‡πÜ
        showToast("‚úÖ ‡∏™‡πà‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢");
        
        // (Optional) ‡∏™‡∏±‡πà‡∏á‡∏õ‡∏¥‡∏î App ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏ä‡∏ó‡πÄ‡∏•‡∏¢‡∏Å‡πá‡πÑ‡∏î‡πâ
        // tg.close(); 
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏° (‡∏Å‡∏£‡∏ì‡∏µ‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å)
    function resetPhoneDisplay(cleanPhone, originalPhone) {
        const el = document.getElementById('phone-wrapper');
        if(!el) return;
        
        el.innerHTML = `
            <div style="font-size:14px; margin-bottom:5px;">üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</div>
            <button class="btn btn-outline" onclick="showInlineCall('${cleanPhone}', '${originalPhone}')" style="width:100%; border:1px solid #ccc; color:#333; display:flex; justify-content:space-between; align-items:center; padding:10px;">
                <span>${originalPhone}</span>
                <i class="fa-solid fa-phone" style="color:var(--primary);"></i>
            </button>
        `;
    }

    // --- BROADCAST LOGIC ---
    function renderBroadcastList() {
        const list = data.all_riders || [];
        const el = document.getElementById('broadcast-list');
        const countEl = document.getElementById('broadcast-count');
        
        if (countEl) countEl.innerText = `(${selectedRiders.size})`;

        if (list.length === 0) {
            el.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#999; padding:20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå</div>';
            return;
        }

        el.innerHTML = list.map(r => {
            const isSel = selectedRiders.has(String(r.id));
            
            // Status Color logic
            let statusColor = '#ccc';
            let statusText = r.status || 'OFFLINE';
            if (statusText === 'IDLE') { statusColor = '#28a745'; statusText = '‡∏ß‡πà‡∏≤‡∏á'; }
            else if (statusText === 'BUSY') { statusColor = '#ffc107'; statusText = '‡∏ï‡∏¥‡∏î‡∏á‡∏≤‡∏ô'; }
            else if (statusText === 'OFFLINE') { statusColor = '#6c757d'; statusText = '‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå'; }
            else if (statusText === 'BANNED') { statusColor = '#dc3545'; statusText = '‡∏ñ‡∏π‡∏Å‡πÅ‡∏ö‡∏ô'; }

            // Style for Selected state (Border & Background)
            const cardStyle = isSel 
                ? `border:2px solid var(--primary); background:#e8f5e9;` 
                : `border:2px solid transparent; background:white;`;

            return `
            <div class="card" onclick="toggleSelectRider('${r.id}')" style="cursor:pointer; padding:10px; min-height:80px; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; position:relative; ${cardStyle}">
                ${isSel ? '<div style="position:absolute; top:5px; right:5px; color:var(--primary); font-size:16px;"><i class="fa-solid fa-circle-check"></i></div>' : ''}
                <div style="font-weight:bold; font-size:14px; margin-bottom:5px;">${r.name}</div>
                <div style="font-size:10px; padding:2px 8px; border-radius:10px; background:${statusColor}; color:white;">${statusText}</div>
            </div>`;
        }).join('');
    }

    function toggleSelectRider(id) {
        const sid = String(id);
        if (selectedRiders.has(sid)) selectedRiders.delete(sid);
        else selectedRiders.add(sid);
        renderBroadcastList();
    }

    function toggleAllRiders() {
        const list = data.all_riders || [];
        if (selectedRiders.size === list.length) {
            selectedRiders.clear(); // Deselect all
        } else {
            list.forEach(r => selectedRiders.add(String(r.id))); // Select all
        }
        renderBroadcastList();
    }

    function submitBroadcast() {
        const msg = document.getElementById('broadcast-msg').value;
        if (!msg.trim()) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°");
        if (selectedRiders.size === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô");

        if (confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏≤ ${selectedRiders.size} ‡∏Ñ‡∏ô?`)) {
            sendAction('broadcast_message', {
                target_ids: Array.from(selectedRiders),
                message: msg
            });
            // Clear UI
            document.getElementById('broadcast-msg').value = '';
            selectedRiders.clear();
            renderBroadcastList();
        }
    }

    // [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏à‡∏ö‡∏á‡∏≤‡∏ô
    async function submitFinishJob() {
        const fileInput = document.getElementById('proof-upload');
        const statusEl = document.getElementById('proof-status');
        const file = fileInput.files[0];

        if (!file) {
            return alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
        }

        if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡∏á‡∏≤‡∏ô?")) return;

        // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
        statusEl.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...";
        statusEl.style.color = "blue";
        
        try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', UPLOAD_PRESET); // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Rider Slip ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ

            const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                method: 'POST',
                body: formData
            });

            const resData = await response.json();

            if (resData.secure_url) {
                // 2. ‡πÑ‡∏î‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏≤‡∏ö‡∏≠‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô
                statusEl.innerText = "‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
                statusEl.style.color = "green";
                
                sendAction('finish_job_with_proof', { 
                    job_id: currentJobId, 
                    photo_url: resData.secure_url 
                });
                
                // ‡∏õ‡∏¥‡∏î Modal
                setTimeout(() => {
                    document.getElementById('confirm-modal').style.display = 'none';
                    document.querySelector('.modal-actions').style.display = 'flex'; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô
                }, 1000);
                
            } else {
                throw new Error("Upload failed");
            }

        } catch (error) {
            console.error(error);
            statusEl.innerText = "‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á)";
            statusEl.style.color = "red";
        }
    }

    // [‡πÅ‡∏ñ‡∏°] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç closeModal ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏õ‡∏∏‡πà‡∏° Action ‡∏î‡πâ‡∏ß‡∏¢
    const originalCloseModal = closeModal; // ‡πÄ‡∏Å‡πá‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°
    closeModal = function() {
        document.querySelector('.modal-actions').style.display = 'flex'; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°
        originalCloseModal();
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (Haversine Formula)
    function getDist(lat1, lon1, lat2, lon2) {
        const R = 6371; // ‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÇ‡∏•‡∏Å (km)
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô KM
    }

    // ==================================================
    // [UPDATE] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà + ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á/‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏£‡∏¥‡∏á
    // ==================================================
    function drawRoutePreview(riderLat, riderLng, pickupLat, pickupLng, dropoffLat, dropoffLng) {
        setTimeout(() => {
            const mapDiv = document.getElementById('route-preview-map');
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏ç‡πà
            mapDiv.onclick = () => {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Full Map ‡πÇ‡∏î‡∏¢‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
                openFullMap(riderLat, riderLng, pickupLat, pickupLng, dropoffLat, dropoffLng);
            };
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ
            mapDiv.style.cursor = 'pointer';
            if(!mapDiv) return;

            // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
            const map = new google.maps.Map(mapDiv, {
                zoom: 13,
                center: { lat: pickupLat, lng: pickupLng },
                disableDefaultUI: true,
                gestureHandling: "none"
            });

            const directionsService = new google.maps.DirectionsService();

            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            let distAtoB = 0, timeAtoB = 0;
            let distBtoC = 0, timeBtoC = 0;

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ (Reusable)
            function calculateAndDisplay(origin, destination, color, callback) {
                const renderer = new google.maps.DirectionsRenderer({
                    map: map,
                    suppressMarkers: true,
                    polylineOptions: { strokeColor: color, strokeWeight: 5, strokeOpacity: 0.8 },
                    preserveViewport: true
                });

                directionsService.route({
                    origin: origin,
                    destination: destination,
                    travelMode: google.maps.TravelMode.DRIVING, // üöó ‡πÇ‡∏´‡∏°‡∏î‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ‡∏à‡∏£‡∏¥‡∏á
                    drivingOptions: {
                        departureTime: new Date(), // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏≤‡∏à‡∏£ ‡∏ì ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
                        trafficModel: 'bestguess'
                    }
                }, (response, status) => {
                    if (status === "OK") {
                        renderer.setDirections(response);
                        // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å API
                        const leg = response.routes[0].legs[0];
                        const distVal = leg.distance.value / 1000; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏°‡∏ï‡∏£‡πÄ‡∏õ‡πá‡∏ô km
                        const timeVal = Math.ceil(leg.duration.value / 60); // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏≤‡∏ó‡∏µ
                        callback(distVal, timeVal);
                    } else {
                        console.error("Directions failed: " + status);
                    }
                });
            }

            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏û‡∏¥‡∏Å‡∏±‡∏î
            const posA = new google.maps.LatLng(riderLat, riderLng);   // ‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå
            const posB = new google.maps.LatLng(pickupLat, pickupLng); // ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
            const posC = new google.maps.LatLng(dropoffLat, dropoffLng); // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤

            // ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô
            const iconRider = { url: "https://maps.gstatic.com/mapfiles/ms2/micons/motorcycling.png", scaledSize: new google.maps.Size(32, 32) };
            const iconPickup = { url: "https://maps.gstatic.com/mapfiles/ms2/micons/shopping.png", scaledSize: new google.maps.Size(32, 32) };
            const iconDropoff = { url: "https://maps.gstatic.com/mapfiles/ms2/micons/flag.png", scaledSize: new google.maps.Size(32, 32) };

            new google.maps.Marker({ position: posA, map: map, icon: iconRider, zIndex: 3 });
            new google.maps.Marker({ position: posB, map: map, icon: iconPickup, zIndex: 2 });
            new google.maps.Marker({ position: posC, map: map, icon: iconDropoff, zIndex: 1 });

            // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ---
            
            // ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1: ‡∏Ñ‡∏∏‡∏ì(A) -> ‡∏£‡πâ‡∏≤‡∏ô(B) [‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô]
            calculateAndDisplay(posA, posB, "#2196F3", (d, t) => {
                distAtoB = d;
                timeAtoB = t;
                updateDisplay(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
            });

            // ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2: ‡∏£‡πâ‡∏≤‡∏ô(B) -> ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤(C) [‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß]
            calculateAndDisplay(posB, posC, "#4CAF50", (d, t) => {
                distBtoC = d;
                timeBtoC = t;
                updateDisplay(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
            });

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï HTML
            function updateDisplay() {
                // ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡∏°‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ä‡πà‡∏ß‡∏á ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏Å‡πà‡∏≠‡∏ô
                if (distAtoB === 0 && distBtoC === 0) return;

                const totalDist = distAtoB + distBtoC;
                const totalTime = timeAtoB + timeBtoC + 5; // +5 ‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á

                // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô HTML
                const el = document.getElementById('job-analysis');
                if (el) {
                    el.innerHTML = `
                        <div style="background:#fff; padding:12px; border-radius:10px; border:1px solid #ddd; font-family:'Kanit'; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                            <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:13px;">
                                <span style="color:#2196F3;"><i class="fa-solid fa-motorcycle"></i> ‡∏Ñ‡∏∏‡∏ì ‚ûù ‡∏£‡πâ‡∏≤‡∏ô</span>
                                <b>${distAtoB.toFixed(1)} ‡∏Å‡∏°. (${timeAtoB} ‡∏ô.)</b>
                            </div>
                            <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:13px;">
                                <span style="color:#4CAF50;"><i class="fa-solid fa-store"></i> ‡∏£‡πâ‡∏≤‡∏ô ‚ûù ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
                                <b>${distBtoC.toFixed(1)} ‡∏Å‡∏°. (${timeBtoC} ‡∏ô.)</b>
                            </div>
                            <div style="height:1px; background:#eee; margin:5px 0;"></div>
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                                <span style="font-size:12px; color:#666;">‡∏£‡∏∞‡∏¢‡∏∞‡∏£‡∏ß‡∏°‡∏à‡∏£‡∏¥‡∏á</span>
                                <span style="font-size:16px; font-weight:bold; color:#333;">${totalDist.toFixed(1)} ‡∏Å‡∏°. / ~${totalTime} ‡∏ô‡∏≤‡∏ó‡∏µ</span>
                            </div>
                        </div>
                    `;
                }
                
                // ‡∏à‡∏±‡∏î‡∏°‡∏∏‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏£‡∏ö
                const bounds = new google.maps.LatLngBounds();
                bounds.extend(posA);
                bounds.extend(posB);
                bounds.extend(posC);
                map.fitBounds(bounds, { top: 50, bottom: 50, left: 30, right: 30 });
            }

        }, 500);
    }

    // --- [START] Fullscreen Map Logic ---

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡πÑ‡∏ß‡πâ
    let fullMap = null;
    let fullDirectionsDisplay1, fullDirectionsDisplay2;

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î Modal
    function closeFullMap() {
        document.getElementById('fullMapModal').style.display = 'none';
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ (High-Quality Style)
    function openFullMap(riderLat, riderLng, pickupLat, pickupLng, dropoffLat, dropoffLng) {
        const modal = document.getElementById('fullMapModal');
        const mapCanvas = document.getElementById('full-map-canvas');
        modal.style.display = 'block';

        // ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏ö‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û (‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢ Grab/Google Maps App)
        const stylishMapStyles = [
            { elementType: "geometry", stylers: [{ color: "#f5f5f5" }] },
            { elementType: "labels.icon", stylers: [{ visibility: "off" }] },
            { elementType: "labels.text.fill", stylers: [{ color: "#616161" }] },
            { elementType: "labels.text.stroke", stylers: [{ color: "#f5f5f5" }] },
            { featureType: "administrative.land_parcel", elementType: "labels.text.fill", stylers: [{ color: "#bdbdbd" }] },
            { featureType: "poi", elementType: "geometry", stylers: [{ color: "#eeeeee" }] },
            { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
            { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#e5e5e5" }] },
            { featureType: "poi.park", elementType: "labels.text.fill", stylers: [{ color: "#9e9e9e" }] },
            { featureType: "road", elementType: "geometry", stylers: [{ color: "#ffffff" }] },
            { featureType: "road.arterial", elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
            { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#dadada" }] },
            { featureType: "road.highway", elementType: "labels.text.fill", stylers: [{ color: "#616161" }] },
            { featureType: "road.local", elementType: "labels.text.fill", stylers: [{ color: "#9e9e9e" }] },
            { featureType: "transit.line", elementType: "geometry", stylers: [{ color: "#e5e5e5" }] },
            { featureType: "transit.station", elementType: "geometry", stylers: [{ color: "#eeeeee" }] },
            { featureType: "water", elementType: "geometry", stylers: [{ color: "#c9c9c9" }] },
            { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#9e9e9e" }] }
        ];

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ (‡∏ã‡∏π‡∏°/‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ)
        if (!fullMap) {
            fullMap = new google.maps.Map(mapCanvas, {
                zoom: 13,
                center: { lat: pickupLat, lng: pickupLng },
                styles: stylishMapStyles, // ‡πÉ‡∏™‡πà‡∏™‡πÑ‡∏ï‡∏•‡πå
                disableDefaultUI: false, // ‡πÄ‡∏õ‡∏¥‡∏î UI ‡∏õ‡∏∏‡πà‡∏°‡∏ã‡∏π‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ
                gestureHandling: "greedy" // ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏î‡∏≤‡∏¢
            });
        } else {
            fullMap.setCenter({ lat: pickupLat, lng: pickupLng });
        }

        // ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
        const iconRider = { url: "https://cdn-icons-png.flaticon.com/512/11735/11735014.png", scaledSize: new google.maps.Size(25, 25) }; // ‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå
        const iconPickup = { url: "https://cdn-icons-png.flaticon.com/512/854/854853.png", scaledSize: new google.maps.Size(36, 36) }; // ‡∏û‡∏±‡∏™‡∏î‡∏∏
        const iconDropoff = { url: "https://cdn-icons-png.flaticon.com/512/854/854853.png", scaledSize: new google.maps.Size(36, 36) }; // ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á

        // ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î
        new google.maps.Marker({ position: {lat:riderLat, lng:riderLng}, map: fullMap, icon: iconRider, zIndex:3 });
        new google.maps.Marker({ position: {lat:pickupLat, lng:pickupLng}, map: fullMap, icon: iconPickup, zIndex:2 });
        new google.maps.Marker({ position: {lat:dropoffLat, lng:dropoffLng}, map: fullMap, icon: iconDropoff, zIndex:1 });

        // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ã‡πâ‡∏≥‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß)
        const directionsService = new google.maps.DirectionsService();

        // ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏µ‡πà 1 (‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô)
        if (fullDirectionsDisplay1) fullDirectionsDisplay1.setMap(null);
        fullDirectionsDisplay1 = new google.maps.DirectionsRenderer({
            map: fullMap, suppressMarkers: true, polylineOptions: { strokeColor: "#023696", strokeWeight: 7, strokeOpacity: 1 }
        });
        directionsService.route({ origin: {lat:riderLat, lng:riderLng}, destination: {lat:pickupLat, lng:pickupLng}, travelMode: 'DRIVING' }, (res, status) => {
            if (status === "OK") fullDirectionsDisplay1.setDirections(res);
        });

        // ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏µ‡πà 2 (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß)
        if (fullDirectionsDisplay2) fullDirectionsDisplay2.setMap(null);
        fullDirectionsDisplay2 = new google.maps.DirectionsRenderer({
            map: fullMap, suppressMarkers: true, polylineOptions: { strokeColor: "#82a8ed", strokeWeight: 7, strokeOpacity: 1 }
        });
        directionsService.route({ origin: {lat:pickupLat, lng:pickupLng}, destination: {lat:dropoffLat, lng:dropoffLng}, travelMode: 'DRIVING' }, (res, status) => {
            if (status === "OK") fullDirectionsDisplay2.setDirections(res);
        });
        
        // ‡∏à‡∏±‡∏î‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö
        const bounds = new google.maps.LatLngBounds();
        bounds.extend({lat:riderLat, lng:riderLng});
        bounds.extend({lat:pickupLat, lng:pickupLng});
        bounds.extend({lat:dropoffLat, lng:dropoffLng});
        fullMap.fitBounds(bounds, { top: 80, bottom: 50, left: 50, right: 50 });
    }
    // --- [END] Fullscreen Map Logic ---

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
document.addEventListener('DOMContentLoaded', () => {
    try { setupFormNavigation(); } catch(e) {}
});
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAzn1_v_MRFa2FpMjEeVBsdRtZ4dfZPo4w&libraries=places&callback=initMap" async defer></script>

<div id="fullMapModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
    <div style="position:relative; width:90%; height:90%; margin:5% auto; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 4px 15px rgba(0,0,0,0.2);">
        <button onclick="closeFullMap()" style="position:absolute; top:15px; right:15px; z-index:10; background:#fff; border:none; width:35px; height:35px; border-radius:50%; font-size:18px; color:#666; box-shadow:0 2px 5px rgba(0,0,0,0.1);">‚úï</button>
        <div id="full-map-canvas" style="width:100%; height:100%;"></div>
    </div>
</div>
</body>
</html>