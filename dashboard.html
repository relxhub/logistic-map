<!DOCTYPE html>
<html lang="th">
<head>
<title>Logistic SuperApp</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    :root { --primary: #00B900; --danger: #dc3545; --warning: #ffc107; --bg: #F5F5F5; --card: #FFF; --text: #333; }
    body { margin: 0; padding: 0; font-family: 'Kanit', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 90px; -webkit-tap-highlight-color: transparent; }

    /* LAYOUT */
    .view { display: none; padding: 15px; animation: fadeIn 0.3s; }
    .view.active { display: block; }

    /* HEADER */
    .header { background: white; padding: 20px 20px 15px; border-radius: 0 0 20px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
    .user-info h1 { margin: 0; font-size: 18px; color: #333; }
    .user-info p { margin: 0; font-size: 12px; color: #888; }
    .role-badge { background: #e8f5e9; color: var(--primary); padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }

    /* COMPONENTS */
    .card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; border-left: 4px solid var(--primary); }
    .card-header { font-weight: bold; font-size: 16px; margin-bottom: 8px; display: flex; justify-content: space-between; }
    .card-row { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #555; margin-bottom: 4px; flex-wrap: wrap; }
    .card-actions { margin-top: 10px; display: flex; gap: 8px; justify-content: flex-end; border-top: 1px solid #eee; padding-top: 10px; }
    
    .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .menu-item { background: white; padding: 20px; border-radius: 15px; text-align: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.1s; }
    .menu-item:active { transform: scale(0.98); }
    .menu-item i { font-size: 28px; color: var(--primary); margin-bottom: 10px; display: block; }

    .form-group { margin-bottom: 15px; }
    .form-label { font-size: 14px; font-weight: bold; margin-bottom: 8px; display: block; color: #333; }
    input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: 'Kanit'; outline: none; font-size: 15px; background: #fff; }
    input:focus, select:focus { border-color: var(--primary); }

    .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer; color: white; display: inline-flex; align-items: center; justify-content: center; gap: 5px; margin-top: 5px; transition: 0.2s; }
    .btn:disabled { background-color: #ccc !important; cursor: not-allowed; }
    .btn-primary { background: var(--primary); }
    .btn-danger { background: var(--danger); }
    .btn-warning { background: var(--warning); color: #333; }
    .btn-outline { background: transparent; border: 1px solid #ddd; color: #333; width: auto; padding: 6px 12px; font-size: 12px; }
    .btn-icon { background: none; border: none; cursor: pointer; font-size: 16px; padding: 5px; color: #888; }

    /* MAP */
    .map-preview { width: 100%; height: 180px; border-radius: 8px; margin-bottom: 10px; background: #eee; border: 1px solid #ddd; display: none; position: relative; overflow: hidden; }
    .map-preview-placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px; background: #f9f9f9; cursor: pointer; }
    #map-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; display: none; background: white; flex-direction: column; }
    .map-header-bar { padding: 15px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 2010; display: flex; gap: 10px; align-items: center; }
    #search-box-overlay { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Kanit'; outline: none; background: #f5f5f5; }
    #map-fullscreen { flex-grow: 1; width: 100%; }
    .map-footer-bar { padding: 20px; background: white; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); z-index: 2010; text-align: center; }
    .pac-container { z-index: 10000 !important; font-family: 'Kanit', sans-serif; }

    /* MODAL */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: none; align-items: center; justify-content: center; }
    .modal-box { background: white; width: 85%; max-width: 320px; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); animation: fadeIn 0.2s; }
    .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: var(--primary); }
    .modal-detail { text-align: left; font-size: 14px; color: #555; background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
    .modal-line { display: flex; justify-content: space-between; margin-bottom: 5px; }
    .modal-actions { display: flex; gap: 10px; flex-direction: column; }
    .btn-copy { background: #333; color: white; }

    /* NAV */
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0 25px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 900; }
    .nav-btn { text-align: center; color: #ccc; font-size: 10px; cursor: pointer; flex: 1; }
    .nav-btn.active { color: var(--primary); }
    .nav-btn i { font-size: 22px; display: block; margin-bottom: 4px; }
    .fab { position: fixed; bottom: 90px; right: 20px; width: 50px; height: 50px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; z-index: 800; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
</head>
<body>

    <div class="header">
        <div class="user-info"><h1 id="user-name">...</h1><p id="user-id">ID: ...</p></div>
        <div class="role-badge" id="user-role">...</div>
    </div>

    <!-- HOME -->
    <div id="view-home" class="view active">
        <h2 style="font-size:18px; margin:0 0 15px 0;">‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</h2>
        <div class="grid-menu" id="menu-container"></div>
        <button class="btn btn-danger" style="margin-top:30px;" onclick="confirmSOS()">üö® S.O.S</button>
    </div>

    <!-- PICKUP -->
    <div id="view-pickup" class="view"><h3>üìç ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</h3><div id="pickup-list"></div><div class="fab" onclick="goToAddPickup()"><i class="fa-solid fa-plus"></i></div></div>
    <div id="view-add-pickup" class="view">
        <button class="btn btn-outline" onclick="nav('pickup')" style="margin-bottom:15px;">üîô ‡∏Å‡∏•‡∏±‡∏ö</button><h3 id="pickup-form-title">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà</h3>
        <div class="form-group"><input type="text" id="pickup-search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." onclick="openMap('pickup')" readonly /><button class="btn btn-primary" onclick="openMap('pickup')"><i class="fa-solid fa-map"></i></button></div>
        <div class="form-group"><div id="preview-pickup" class="map-preview" onclick="openMap('pickup')"><div class="map-preview-placeholder">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div></div></div>
        <div class="form-group"><input type="text" id="new-pickup-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö" /></div><button class="btn btn-primary" onclick="savePickup()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>

    <!-- CREATE JOB -->
    <div id="view-create-job" class="view">
        <button class="btn btn-outline" onclick="nav('home')" style="margin-bottom:15px;">üîô ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button><h3>üì¶ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
        <div class="form-group"><input type="text" id="job-search-input" placeholder="üîç ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á..." onclick="openMap('job')" readonly /><button class="btn btn-primary" onclick="openMap('job')"><i class="fa-solid fa-map"></i></button></div>
        <div class="form-group"><div id="preview-job" class="map-preview" onclick="openMap('job')"><div class="map-preview-placeholder">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div></div></div>
        <div class="form-group"><select id="job-pickup-select"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö --</option></select></div>
        <div class="form-group"><input type="text" id="job-bill-id" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•" /></div><button class="btn btn-primary" onclick="submitJob()">üöÄ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</button>
    </div>

    <!-- POOL / MONITOR / RIDER / HISTORY -->
    <div id="view-pool" class="view"><h3>üì¶ Pool</h3><div id="pool-list"></div><button class="btn btn-primary" onclick="sendAction('release_all')">üöÄ ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button></div>
    
    <div id="view-monitor" class="view"><h3>üëÄ Monitor</h3><div id="monitor-list"></div></div>
    
    <div id="view-rider" class="view"><button class="btn btn-outline" onclick="nav('home')" style="margin-bottom:15px;">üîô ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button><h3>üõµ ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3><div id="rider-job-card"></div></div>
    
    <div id="view-history" class="view">
        <button class="btn btn-outline" onclick="nav('home')" style="margin-bottom:15px;">üîô ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button><h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h3>
        <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
            <select id="hist-filter-date" onchange="renderHistoryView()" style="flex:1;"><option value="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option><option value="week">‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ô‡∏µ‡πâ</option><option value="month" selected>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option><option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
            <select id="hist-filter-user" onchange="renderHistoryView()" style="flex:1; display:none;"><option value="all">-- ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô --</option></select>
        </div>
        <div id="history-list"></div>
    </div>

    <!-- MAP & MODAL -->
    <div id="map-overlay">
        <div class="map-header-bar"><button class="btn btn-outline" onclick="closeMap()"><i class="fa-solid fa-arrow-left"></i></button><input id="search-box-overlay" type="text" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." /></div>
        <div id="map-fullscreen"></div><div class="map-footer-bar"><div id="map-status-text">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏∏‡∏î</div><button class="btn btn-primary" id="btn-confirm-loc" disabled>üìç ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div>
    </div>
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" id="modal-title">üì¶ ‡∏™‡∏£‡∏∏‡∏õ</div><div class="modal-detail" id="modal-content"></div>
            <div class="modal-actions">
                <button class="btn btn-copy" onclick="copyShippingPrice()"><i class="fa-solid fa-copy"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
                <div style="display:flex; gap:10px;"><button class="btn btn-outline" style="flex:1;" onclick="closeModal()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button><button class="btn btn-primary" style="flex:1;" onclick="confirmAction()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div>
            </div>
        </div>
    </div>

    <div class="bottom-nav" id="bottom-nav"></div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    let data = { role: 'GUEST' };
    let tempLat, tempLng, map, marker, mapMode, editPickupId, currentJobId, currentEditJobData, mapsLoaded = false;
    let config = { base: 40, km: 10, change_fee: 30 };
    let modalActionType, pendingPayload, pendingCopyText, countdownInterval;

    try {
        const p = new URLSearchParams(window.location.search);
        const r = p.get('data');
        if (r) {
            data = JSON.parse(decodeURIComponent(r));
            if(data.config) config = data.config;
            if(data.role && data.role.startsWith('Role.')) data.role = data.role.replace('Role.', '');
        }

        document.getElementById('user-name').innerText = data.name || 'Guest';
        document.getElementById('user-id').innerText = `ID: ${data.id || '-'}`;
        document.getElementById('user-role').innerText = data.role || '-';
        
        if(data.filter_admins) {
            const sel = document.getElementById('hist-filter-user');
            sel.style.display = 'block';
            data.filter_admins.forEach(u => sel.innerHTML += `<option value="${u}">${u}</option>`);
        }
        
        renderMenu(data.role);
    } catch (e) { console.error(e); }

    function renderMenu(role) {
        const m = document.getElementById('menu-container');
        const n = document.getElementById('bottom-nav');
        let navHtml = `<div class="nav-btn active" onclick="nav('home', this)"><i class="fa-solid fa-house"></i>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</div>`;
        let menuHtml = '';

        // Role Config
        if (role === 'SUPERADMIN') {
            menuHtml = `<div class="menu-item" onclick="goToPage('create-job')"><i class="fa-solid fa-plus-circle"></i><br>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</div><div class="menu-item" onclick="nav('pickup')"><i class="fa-solid fa-map-pin"></i><br>‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö</div><div class="menu-item" onclick="nav('pool')"><i class="fa-solid fa-layer-group"></i><br>Pool</div><div class="menu-item" onclick="nav('monitor')"><i class="fa-solid fa-desktop"></i><br>Monitor</div><div class="menu-item" onclick="nav('history')"><i class="fa-solid fa-clock-rotate-left"></i><br>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`;
            navHtml += `<div class="nav-btn" onclick="nav('pool', this)"><i class="fa-solid fa-box"></i>Pool</div><div class="nav-btn" onclick="nav('monitor', this)"><i class="fa-solid fa-eye"></i>Monitor</div><div class="nav-btn" onclick="nav('history', this)"><i class="fa-solid fa-list"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`;
        } 
        else if (role === 'SUPERVISOR') {
            menuHtml = `<div class="menu-item" onclick="nav('pickup')"><i class="fa-solid fa-map-pin"></i><br>‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö</div><div class="menu-item" onclick="nav('pool')"><i class="fa-solid fa-layer-group"></i><br>Pool</div><div class="menu-item" onclick="nav('monitor')"><i class="fa-solid fa-desktop"></i><br>Monitor</div><div class="menu-item" onclick="nav('history')"><i class="fa-solid fa-clock-rotate-left"></i><br>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`;
            navHtml += `<div class="nav-btn" onclick="nav('pool', this)"><i class="fa-solid fa-box"></i>Pool</div><div class="nav-btn" onclick="nav('monitor', this)"><i class="fa-solid fa-eye"></i>Monitor</div><div class="nav-btn" onclick="nav('history', this)"><i class="fa-solid fa-list"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`;
        }
        else if (role === 'ADMIN') {
            menuHtml = `<div class="menu-item" onclick="goToPage('create-job')"><i class="fa-solid fa-plus-circle"></i><br>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</div><div class="menu-item" onclick="nav('monitor')"><i class="fa-solid fa-desktop"></i><br>Monitor</div><div class="menu-item" onclick="nav('history')"><i class="fa-solid fa-clock-rotate-left"></i><br>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`;
            navHtml += `<div class="nav-btn" onclick="nav('monitor', this)"><i class="fa-solid fa-eye"></i>Monitor</div><div class="nav-btn" onclick="nav('history', this)"><i class="fa-solid fa-list"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`;
        }
        else if (role === 'RIDER') {
            menuHtml = `<div class="menu-item" onclick="nav('rider')"><i class="fa-solid fa-motorcycle"></i><br>‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div><div class="menu-item" onclick="nav('history')"><i class="fa-solid fa-clock-rotate-left"></i><br>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</div>`;
            navHtml += `<div class="nav-btn" onclick="nav('rider', this)"><i class="fa-solid fa-motorcycle"></i>‡∏á‡∏≤‡∏ô</div><div class="nav-btn" onclick="nav('history', this)"><i class="fa-solid fa-list"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`;
        }

        m.innerHTML = menuHtml; m.style.display = 'grid'; n.innerHTML = navHtml; // No X button

        // Safe Load
        if (['SUPERADMIN','SUPERVISOR','ADMIN'].includes(role)) {
            try { renderPickupList(data.pickup_points||[]); } catch(e){}
            try { setupPickupSelector(); } catch(e){}
            try { renderHistoryView(); } catch(e){}
            if(role!=='ADMIN') try{ renderPoolList(data.pool_jobs||[]); } catch(e){}
            try{ renderMonitor(data.monitor_jobs||[]); } catch(e){}
        }
        if (role==='RIDER') {
            try{ renderRiderJob(data.current_job); } catch(e){}
            try{ renderHistoryView(); } catch(e){}
        }
    }

    function renderHistoryView() {
        const list = data.full_history || [];
        const dateMode = document.getElementById('hist-filter-date').value;
        const userMode = document.getElementById('hist-filter-user') ? document.getElementById('hist-filter-user').value : 'all';
        const el = document.getElementById('history-list');
        if(list.length===0) return el.innerHTML='<div style="text-align:center;padding:20px">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
        
        const now=new Date(), start=new Date(now.getFullYear(),now.getMonth(),now.getDate());
        const filtered = list.filter(j => {
            const d = new Date(j.created_at);
            let dm=true;
            if(dateMode==='today') dm=d>=start;
            else if(dateMode==='week'){const w=new Date(start);w.setDate(w.getDate()-7);dm=d>=w;}
            else if(dateMode==='month'){const m=new Date(start);m.setMonth(m.getMonth()-1);dm=d>=m;}
            let um=true; if(userMode!=='all') um=j.admin===userMode;
            return dm && um;
        });

        if(filtered.length===0) return el.innerHTML='<div style="text-align:center;padding:20px">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
        
        el.innerHTML = filtered.map(h => {
            let details = '';
            if (data.role === 'RIDER') {
                details = `<div class="card-row">üì¶ ${h.bill_id}</div><div class="card-row">üìÖ ${new Date(h.created_at).toLocaleString('th-TH')}</div><div class="card-row">üí∞ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß: ${h.price} ${h.extra_fee>0?`(+‡πÅ‡∏Å‡πâ ${h.extra_fee})`:''}</div>`;
            } else {
                details = `<div class="card-row">üë§ ‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á: ${h.admin}</div><div class="card-row">üõµ ‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå: ${h.rider}</div><div class="card-row">üì¶ ${h.bill_id}</div><div class="card-row">üïí ‡∏™‡∏£‡πâ‡∏≤‡∏á: ${new Date(h.created_at).toLocaleString('th-TH')}</div><div class="card-row">üèÅ ‡∏à‡∏ö: ${h.finished_at?new Date(h.finished_at).toLocaleString('th-TH'):'-'}</div><div class="card-row">üí∞ ‡∏Ñ‡πà‡∏≤‡∏£‡∏ñ: ${h.price} ${h.extra_fee>0?`(+${h.extra_fee})`:''}</div>${h.proof?`<div class="card-actions"><a href="${h.proof}" target="_blank" class="btn btn-outline btn-sm">‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏à‡∏ö‡∏á‡∏≤‡∏ô</a></div>`:''}`;
            }
            return `<div class="card" style="border-left:4px solid ${h.status==='COMPLETED'?'#00B900':'#dc3545'}"><div class="card-header">${h.bill_id} <span class="role-badge">${h.status}</span></div>${details}</div>`;
        }).join('');
    }

    function renderMonitor(list) {
        const el = document.getElementById('monitor-list');
        if(list.length===0) return el.innerHTML='<div style="text-align:center;padding:20px">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô</div>';
        el.innerHTML = list.map(j => {
            const str = encodeURIComponent(JSON.stringify(j));
            return `<div class="card"><div class="card-header">${j.bill_id} <span class="role-badge">${j.status}</span></div><div class="card-row">üë§ ‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á: ${j.admin}</div><div class="card-row">üõµ ‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå: ${j.rider}</div><div class="card-row">üì¶ ${j.bill_id}</div><div class="card-row">üïí ‡∏™‡∏£‡πâ‡∏≤‡∏á: ${new Date(j.created_at).toLocaleString('th-TH')}</div>${j.updated_at?`<div class="card-row">üèÅ ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date(j.updated_at).toLocaleString('th-TH')}</div>`:''}<div class="card-row">üí∞ ‡∏Ñ‡πà‡∏≤‡∏£‡∏ñ: ${j.price} ${j.extra_fee>0?`(+${j.extra_fee})`:''}</div>${j.proof?`<div class="card-row"><a href="${j.proof}" target="_blank" style="color:var(--primary);">üì∑ ‡∏î‡∏π‡∏£‡∏π‡∏õ</a></div>`:''}<div class="card-actions">${!['COMPLETED','CANCELLED'].includes(j.status)?`<button class="btn btn-outline btn-sm" onclick="prepareEditDest('${j.job_id}','${str}')">‡πÅ‡∏Å‡πâ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</button>`:''}</div></div>`;
        }).join('');
    }

    // Utils
    function nav(id, el) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById('view-'+id).classList.add('active'); if(el) { document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); } }
    function goToPage(page) { 
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); 
        if(page==='create-job'){ document.getElementById('view-create-job').classList.add('active'); resetJobForm(); setupPickupSelector(); } 
        else if(page==='add-pickup'){ document.getElementById('view-add-pickup').classList.add('active'); editPickupId=null; resetPickupForm(); }
        else { document.getElementById('view-'+page).classList.add('active'); } 
    }
    function setupPickupSelector(){ const el=document.getElementById('job-pickup-select'); if(el && data.pickup_points) el.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö --</option>'+data.pickup_points.map(p=>`<option value="${p.id}">${p.name}</option>`).join(''); }
    function goToAddPickup() { editPickupId = null; resetPickupForm(); goToPage('add-pickup'); document.getElementById('pickup-form-title').innerText = "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà"; }
    function resetPickupForm() { document.getElementById('new-pickup-name').value = ''; document.getElementById('pickup-search-input').value = ''; document.getElementById('preview-pickup').innerHTML = '<div class="map-preview-placeholder">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>'; tempLat = null; tempLng = null; }
    function resetJobForm() { document.getElementById('job-bill-id').value = ''; document.getElementById('job-search-input').value = ''; document.getElementById('job-pickup-select').value = ''; document.getElementById('preview-job').innerHTML = '<div class="map-preview-placeholder">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</div>'; tempLat = null; tempLng = null; }
    function editPickup(id, name, lat, lng) { editPickupId = id; goToPage('add-pickup'); document.getElementById('pickup-form-title').innerText = "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö"; document.getElementById('new-pickup-name').value = name; document.getElementById('pickup-search-input').value = `${lat}, ${lng}`; tempLat = lat; tempLng = lng; showStaticMap('preview-pickup', lat, lng); }
    function savePickup() { const name = document.getElementById('new-pickup-name').value; if(!name || !tempLat) return alert('‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); if(editPickupId) { sendAction('delete_pickup', {id: editPickupId}); setTimeout(() => sendAction('save_pickup', { name, lat: tempLat, lng: tempLng }), 500); } else { sendAction('save_pickup', { name, lat: tempLat, lng: tempLng }); } }
    function submitJob() { const bill = document.getElementById('job-bill-id').value; const pid = document.getElementById('job-pickup-select').value; if(!bill || !tempLat || !pid) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); const pickup = (data.pickup_points || []).find(p => p.id === pid); const dist = calcDist(pickup.lat, pickup.lng, tempLat, tempLng); const price = Math.ceil(config.base + (dist * config.km)); modalActionType = 'create'; pendingPayload = { bill_id: bill, pickup_id: pid, lat: tempLat, lng: tempLng }; pendingCopyText = `‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á : ${price} ‡∏ö‡∏≤‡∏ó\n‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á : ${price} ‡∏ö‡∏≤‡∏ó`; const content = `<div class="modal-line"><span>üìÑ ‡∏ö‡∏¥‡∏•:</span> <b>${bill}</b></div><div class="modal-line"><span>üìç ‡∏£‡∏±‡∏ö:</span> <span>${pickup.name}</span></div><div class="modal-line"><span>üèÅ ‡∏™‡πà‡∏á:</span> <span>(‡∏´‡∏°‡∏∏‡∏î)</span></div><div class="modal-line"><span>üìè ‡∏£‡∏∞‡∏¢‡∏∞:</span> <span>~${dist.toFixed(2)} ‡∏Å‡∏°.</span></div><hr style="margin:5px 0"><div class="modal-line" style="color:var(--primary);"><span>üí∞ ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á:</span> <b>${price} ‡∏ö‡∏≤‡∏ó</b></div>`; document.getElementById('modal-title').innerText = "üì¶ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô"; document.getElementById('modal-content').innerHTML = content; document.getElementById('confirm-modal').style.display = 'flex'; }
    function prepareEditDest(jobId, jobDataStr) { currentJobId = jobId; currentEditJobData = JSON.parse(decodeURIComponent(jobDataStr)); openMap('edit_dest'); }
    function closeModal() { document.getElementById('confirm-modal').style.display = 'none'; }
    function confirmAction() { if (modalActionType === 'create') sendAction('create_job', pendingPayload); else if (modalActionType === 'edit_dest') sendAction('edit_destination', pendingPayload); closeModal(); }
    function copyShippingPrice() { const el = document.createElement('textarea'); el.value = pendingCopyText; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); }
    function sendAction(action, payload={}) { tg.sendData(JSON.stringify({ action, ...payload })); }
    function cancelJob(id) { const r = prompt("‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:"); if(r) sendAction('cancel_job', {job_id: id, reason: r}); }
    function confirmSOS() { if(confirm("SOS?")) sendAction('sos'); }
    function renderPickupList(list) { const el=document.getElementById('pickup-list'); if(!list.length)return el.innerHTML='<div style="text-align:center;padding:20px">‡∏ß‡πà‡∏≤‡∏á</div>'; el.innerHTML=list.map(p=>`<div class="card"><div><b>${p.name}</b></div><div><button class="btn-icon" onclick="editPickup('${p.id}','${p.name}',${p.lat},${p.lng})"><i class="fa-solid fa-pen"></i></button><button class="btn-icon delete" onclick="if(confirm('‡∏•‡∏ö?'))sendAction('delete_pickup',{id:'${p.id}'})"><i class="fa-solid fa-trash"></i></button></div></div>`).join(''); }
    function renderPoolList(list) { const el = document.getElementById('pool-list'); if(list.length === 0) { el.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô Pool</div>'; return; } document.getElementById('pool-count').innerText = list.length; el.innerHTML = list.map(j => `<div class="card" style="border-left:4px solid #ffc107;"><div class="card-header">üìù ${j.bill_id}</div><div class="card-row">üìç ‡∏£‡∏±‡∏ö: ${j.pickup}</div><div class="card-row">üèÅ ‡∏™‡πà‡∏á: ${j.dropoff_lat.toFixed(4)}, ${j.dropoff_lng.toFixed(4)}</div><div class="card-actions"><button class="btn btn-primary btn-sm" onclick="sendAction('release_one', {job_id: '${j.job_id}'})">‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏á‡∏≤‡∏ô</button></div></div>`).join(''); }
    function confirmEditDestPreview() { if (!currentEditJobData || !tempLat) return; const oldPrice = parseFloat(currentEditJobData.price); const newDist = calcDist(currentEditJobData.pickup_lat, currentEditJobData.pickup_lng, tempLat, tempLng); const newPure = Math.ceil(config.base + (newDist * config.km)); const fee = (currentEditJobData.status === 'PICKED_UP') ? config.change_fee : 0; let final = (fee>0) ? ((newPure>oldPrice) ? newPure+fee : oldPrice+fee) : newPure; let det = ''; if(fee>0) { pendingCopyText = `‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á : ${final-fee} ‡∏ö‡∏≤‡∏ó\n‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà : ${fee} ‡∏ö‡∏≤‡∏ó\n‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á : ${final} ‡∏ö‡∏≤‡∏ó`; det = `<div class="modal-line"><span>üíµ ‡πÄ‡∏î‡∏¥‡∏°:</span> <span>${oldPrice}</span></div><div class="modal-line"><span>üõµ ‡πÉ‡∏´‡∏°‡πà:</span> <span>${newPure}</span></div><div class="modal-line"><span>‚ûï ‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô:</span> <b>${fee}</b></div><hr><div class="modal-line" style="color:var(--primary)"><span>üí∞ ‡∏£‡∏ß‡∏°:</span> <b>${final}</b></div>`; } else { pendingCopyText = `‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á : ${final} ‡∏ö‡∏≤‡∏ó`; det = `<div class="modal-line"><span>üíµ ‡πÄ‡∏î‡∏¥‡∏°:</span> <span>${oldPrice}</span></div><div class="modal-line"><span>üõµ ‡πÉ‡∏´‡∏°‡πà:</span> <span>${newPure}</span></div><hr><div class="modal-line" style="color:var(--primary)"><span>üí∞ ‡πÉ‡∏´‡∏°‡πà:</span> <b>${final}</b></div>`; } modalActionType = 'edit_dest'; pendingPayload = { job_id: currentJobId, lat: tempLat, lng: tempLng }; document.getElementById('modal-title').innerText = "‚úèÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô"; document.getElementById('modal-content').innerHTML = `<div class="modal-line"><span>üìÑ ‡∏ö‡∏¥‡∏•:</span> <b>${currentEditJobData.bill_id}</b></div>${det}`; document.getElementById('confirm-modal').style.display = 'flex'; }
    function renderRiderJob(job) { const el = document.getElementById('rider-job-card'); if (countdownInterval) clearInterval(countdownInterval); if (!job) { el.innerHTML = '<div style="text-align:center; padding:40px;">‡∏ß‡πà‡∏≤‡∏á</div>'; return; } let btns = '', color = '#00B900', text = '‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì', extra = ''; if (job.status === 'OFFERED') { color='#ffc107'; text='üîî ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà'; const tSec = (data.config && data.config.offer_timeout_sec) || 60; const serverTimeMs = new Date(data.server_time).getTime(); const clientTimeMs = new Date().getTime(); const timeDiff = clientTimeMs - serverTimeMs; const exp = new Date(job.updated_at).getTime() + (tSec * 1000); extra='<div id="jb-cd" style="text-align:center;color:red;font-weight:bold">...</div>'; btns=`<div style="display:flex;gap:10px"><button class="btn btn-primary" onclick="sendAction('accept_offer',{job_id:'${job.job_id}'})">‡∏£‡∏±‡∏ö</button><button class="btn btn-danger" onclick="sendAction('reject_offer',{job_id:'${job.job_id}'})">‡∏ú‡πà‡∏≤‡∏ô</button></div>`; countdownInterval=setInterval(()=>{ const nowAdj=new Date().getTime()-timeDiff; const s=Math.floor((exp-nowAdj)/1000); if(s<=0){clearInterval(countdownInterval);setTimeout(()=>window.location.reload(),1500);}else{document.getElementById('jb-cd').innerText=s+' ‡∏ß‡∏¥';} },1000); } else if(job.status === 'ASSIGNED') btns=`<a href="https://maps.google.com/?q=${job.pickup_lat},${job.pickup_lng}" target="_blank" class="btn btn-primary">‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö</a><button class="btn btn-warning" onclick="sendAction('rider_update',{status:'PICKED_UP',job_id:'${job.job_id}'})">‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</button><button class="btn btn-danger" style="margin-top:10px" onclick="cancelJob('${job.job_id}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>`; else if(job.status === 'PICKED_UP') btns=`<a href="https://maps.google.com/?q=${job.dropoff_lat},${job.dropoff_lng}" target="_blank" class="btn btn-primary">‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏™‡πà‡∏á</a><button class="btn btn-primary" onclick="sendAction('req_finish',{job_id:'${job.job_id}'});tg.close()">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏à‡∏ö</button>`; el.innerHTML = `<div class="card" style="border-left:5px solid ${color}"><h2>${text}</h2>${extra}<h3>${job.bill_id}</h3><p>üí∞ ${job.price}</p><p>üìç ${job.pickup_name}</p><hr>${btns}</div>`; }
    
    let map; function openMap(m,id){ mapMode=m; currentJobId=id; document.getElementById('map-overlay').style.display='flex'; if(!mapsLoaded)initMap(); }
    function closeMap(){ document.getElementById('map-overlay').style.display='none'; }
    function initMap(){ map=new google.maps.Map(document.getElementById("map-fullscreen"),{zoom:15,center:{lat:13.7563,lng:100.5018},disableDefaultUI:true}); const ac=new google.maps.places.Autocomplete(document.getElementById("search-box-overlay")); ac.bindTo("bounds",map); ac.addListener("place_changed",()=>{ const p=ac.getPlace(); if(p.geometry){ if(p.geometry.viewport)map.fitBounds(p.geometry.viewport); else{map.setCenter(p.geometry.location);map.setZoom(17);} placeMarker(p.geometry.location); } }); map.addListener("click",e=>placeMarker(e.latLng)); mapsLoaded=true; }
    function placeMarker(loc){ if(marker)marker.setMap(null); marker=new google.maps.Marker({position:loc,map:map}); tempLat=loc.lat(); tempLng=loc.lng(); document.getElementById('btn-confirm-loc').disabled=false; document.getElementById('map-status-text').innerText="OK"; }
    document.getElementById('btn-confirm-loc').onclick=()=>{ closeMap(); if(mapMode==='pickup'){ document.getElementById('pickup-search-input').value='OK'; showStaticMap('preview-pickup'); } else if(mapMode==='job'){ document.getElementById('job-search-input').value='OK'; showStaticMap('preview-job'); } else if(mapMode==='edit_dest') confirmEditDestPreview(); };
    function showStaticMap(id){ document.getElementById(id).innerHTML='<div style="background:#eee;height:100%;display:flex;align-items:center;justify-content:center">üìç ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß</div>'; }
    function calcDist(lat1, lon1, lat2, lon2) { const R = 6371; const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180; const a = Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2); return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAzn1_v_MRFa2FpMjEeVBsdRtZ4dfZPo4w&libraries=places&callback=initMap" async defer></script>
</body>
</html>