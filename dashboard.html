<!DOCTYPE html>
<html lang="th">
<head>
<title>Logistic SuperApp</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root { --primary: #00B900; --danger: #dc3545; --warning: #ffc107; --bg: #F5F5F5; --card: #FFF; --text: #333; }
    body { margin: 0; padding: 0; font-family: 'Kanit', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 90px; -webkit-tap-highlight-color: transparent; }
    
    .view { display: none; padding: 15px; animation: fadeIn 0.3s; }
    .view.active { display: block; }
    
    .header { background: white; padding: 20px 20px 15px; border-radius: 0 0 20px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
    .user-info h1 { margin: 0; font-size: 18px; color: #333; }
    .user-info p { margin: 0; font-size: 12px; color: #888; }
    .role-badge { background: #e8f5e9; color: var(--primary); padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }

    .card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; border-left: 4px solid var(--primary); }
    .card-header { font-weight: bold; font-size: 16px; margin-bottom: 8px; display: flex; justify-content: space-between; }
    .card-row { display: flex; align-items: flex-start; gap: 8px; font-size: 13px; color: #555; margin-bottom: 6px; }
    .card-row i { margin-top: 3px; width: 16px; text-align: center; color: var(--primary); }
    .card-actions { margin-top: 10px; display: flex; gap: 8px; justify-content: flex-end; border-top: 1px solid #eee; padding-top: 10px; }

    .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .menu-item { background: white; padding: 20px; border-radius: 15px; text-align: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.1s; }
    .menu-item:active { transform: scale(0.98); }
    .menu-item i { font-size: 28px; color: var(--primary); margin-bottom: 10px; display: block; }

    .form-group { margin-bottom: 15px; }
    .form-label { font-size: 14px; font-weight: bold; margin-bottom: 5px; display: block; color: #333; }
    input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: 'Kanit'; outline: none; font-size: 15px; background: #fff; }
    input:focus, select:focus, textarea:focus { border-color: var(--primary); }

    .btn { box-sizing: border-box; width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer; color: white; display: inline-flex; align-items: center; justify-content: center; gap: 5px; margin-top: 5px; transition: 0.2s; }
    .btn:disabled { background-color: #ccc !important; cursor: not-allowed; }
    .btn-primary { background: var(--primary); }
    .btn-danger { background: var(--danger); }
    .btn-warning { background: var(--warning); color: #333; }
    .btn-outline { background: transparent; border: 1px solid #ddd; color: #333; width: auto; padding: 6px 12px; font-size: 12px; }
    .btn-icon { background: none; border: none; cursor: pointer; font-size: 16px; padding: 5px; color: #888; }
    .btn-icon:hover { color: var(--primary); }
    .btn-icon.delete:hover { color: var(--danger); }
    .btn-call { background: #e8f5e9; color: var(--primary); border: 1px solid var(--primary); padding: 4px 10px; border-radius: 20px; font-size: 12px; text-decoration: none; display: inline-block; margin-left: 5px; }

    .map-preview { width: 100%; height: 180px; border-radius: 8px; margin-bottom: 10px; background: #eee; border: 1px solid #ddd; display: none; position: relative; overflow: hidden; }
    .map-preview-placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px; background: #f9f9f9; cursor: pointer; }
    
    #map-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; display: none; background: white; flex-direction: column; }
    .map-header-bar { padding: 15px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 2010; display: flex; gap: 10px; align-items: center; }
    #search-box-overlay { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Kanit'; outline: none; background: #f5f5f5; }
    #map-fullscreen { flex-grow: 1; width: 100%; }
    .map-footer-bar { padding: 20px; background: white; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); z-index: 2010; text-align: center; }
    .pac-container { z-index: 10000 !important; font-family: 'Kanit', sans-serif; }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: none; align-items: center; justify-content: center; }
    .modal-box { background: white; width: 85%; max-width: 320px; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); animation: fadeIn 0.2s; }
    .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: var(--primary); }
    .modal-detail { text-align: left; font-size: 14px; color: #555; background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
    .modal-line { display: flex; justify-content: space-between; margin-bottom: 5px; }
    .modal-actions { display: flex; gap: 10px; flex-direction: column; }
    .btn-copy { background: #333; color: white; }

    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0 25px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 900; }
    .nav-btn { text-align: center; color: #ccc; font-size: 10px; cursor: pointer; flex: 1; }
    .nav-btn.active { color: var(--primary); }
    .nav-btn i { font-size: 22px; display: block; margin-bottom: 4px; }
    
    .fab { position: fixed; bottom: 90px; right: 20px; width: 50px; height: 50px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; z-index: 800; }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
</head>
<body>

<div class="header">
    <div class="user-info"><h1 id="user-name">...</h1><p id="user-id">ID: ...</p></div>
    <div class="role-badge" id="user-role">...</div>
</div>

<div id="view-home" class="view active">
    <h2 style="font-size:18px; margin:0 0 15px 0;">‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</h2>
    <div class="grid-menu" id="menu-container"></div>
    <button class="btn btn-danger" style="margin-top:30px;" onclick="confirmSOS()">üö® S.O.S</button>
</div>

<div id="view-pickup" class="view">
    <h3>üìç ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</h3>
    <div id="pickup-list"></div>
    <div class="fab" onclick="goToAddPickup()"><i class="fa-solid fa-plus"></i></div>
</div>

<div id="view-add-pickup" class="view">
    <button class="btn btn-outline" onclick="nav('pickup')" style="margin-bottom:15px;">üîô ‡∏Å‡∏•‡∏±‡∏ö</button>
    <h3 id="pickup-form-title">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà</h3>
    <div class="form-group"><input type="text" id="pickup-search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." onclick="openMap('pickup')" readonly /><button class="btn btn-primary" onclick="openMap('pickup')"><i class="fa-solid fa-map"></i></button></div>
    <div class="form-group"><div id="preview-pickup" class="map-preview" onclick="openMap('pickup')"><div class="map-preview-placeholder">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div></div></div>
    <div class="form-group"><input type="text" id="new-pickup-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö" /></div>
    <button class="btn btn-primary" onclick="savePickup()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
</div>

<div id="view-create-job" class="view">
    <button class="btn btn-outline" onclick="nav('home')" style="margin-bottom:15px;">üîô ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
    <h3>üì¶ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
    
    <div class="form-group">
        <label class="form-label">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö</label>
        <select id="job-pickup-select"></select>
    </div>
    
    <div class="form-group">
        <label class="form-label">2. ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</label>
        <div style="display:flex; gap:5px;">
            <input type="text" id="job-search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î..." onclick="openMap('job')" readonly />
            <button class="btn btn-primary" style="width:auto;" onclick="openMap('job')"><i class="fa-solid fa-map"></i></button>
        </div>
        <div id="preview-job" class="map-preview" onclick="openMap('job')" style="margin-top:5px;"><div class="map-preview-placeholder">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div></div>
    </div>
    
    <div class="form-group">
        <label class="form-label">3. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
        
        <input type="text" id="job-bill-id" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏• / Order ID" style="margin-bottom:5px;" enterkeyhint="next" />
        
        <div style="display:flex; gap:5px; margin-bottom:5px;">
            <input type="text" id="job-recv-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö" style="flex:1;" enterkeyhint="next" />
            
            <input type="tel" id="job-recv-phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" style="flex:1;" enterkeyhint="next" />
        </div>
        
        <input type="text" id="job-note" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÅ‡∏ï‡∏Å, ‡∏ù‡∏≤‡∏Å‡∏õ‡πâ‡∏≠‡∏°‡∏¢‡∏≤‡∏°)" enterkeyhint="done" />
    </div>

    <button class="btn btn-primary" id="btn-submit-job" onclick="submitJob()">üöÄ ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</button>
</div>

<div id="view-pool" class="view"><h3>üì¶ Pool</h3><div id="pool-list"></div><button class="btn btn-primary" onclick="sendAction('release_all')">üöÄ ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button></div>

<div id="view-monitor" class="view"><h3>üëÄ Monitor</h3><div id="monitor-list"></div></div>

<div id="view-rider" class="view">
    <button class="btn btn-outline" onclick="nav('home')" style="margin-bottom:15px;">üîô ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
    <h3>üõµ ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
    <div id="rider-job-card"></div>
</div>

<div id="view-history" class="view">
    <button class="btn btn-outline" onclick="nav('home')" style="margin-bottom:15px;">üîô ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
    <h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h3>
    <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
        <select id="hist-filter-date" onchange="renderFullHistory()" style="flex:1;">
            <option value="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>
            <option value="week">‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ô‡∏µ‡πâ</option>
            <option value="month" selected>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
        <select id="hist-filter-user" onchange="renderFullHistory()" style="flex:1; display:none;">
            <option value="all">-- ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô --</option>
        </select>
    </div>
    <div id="history-list"></div>
</div>

<div id="map-overlay">
    <div class="map-header-bar"><button class="btn btn-outline" onclick="closeMap()"><i class="fa-solid fa-arrow-left"></i></button><input id="search-box-overlay" type="text" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." /></div>
    <div id="map-fullscreen"></div>
    <div class="map-footer-bar"><div id="map-status-text">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏∏‡∏î</div><button class="btn btn-primary" id="btn-confirm-loc" disabled>üìç ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div>
</div>

<div id="confirm-modal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-title" id="modal-title">üì¶ ‡∏™‡∏£‡∏∏‡∏õ</div>
        <div class="modal-detail" id="modal-content"></div>
        <div class="modal-actions">
            <button class="btn btn-copy" onclick="copyShippingPrice()"><i class="fa-solid fa-copy"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-outline" style="flex:1;" onclick="closeModal()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button class="btn btn-primary" style="flex:1;" onclick="confirmAction()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>
</div>

<div class="bottom-nav" id="bottom-nav"></div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    
    // STATE
    let data = { role: 'GUEST' };
    let tempLat = null, tempLng = null;
    let map, marker, mapMode, editPickupId = null, currentJobId = null, currentEditJobData = null;
    let mapsLoaded = false;
    let config = { base: 40, km: 10, change_fee: 30 };
    let modalActionType = ''; 
    let pendingPayload = null;
    let pendingCopyText = "";
    let countdownInterval;

    // INIT
    try {
        const params = new URLSearchParams(window.location.search);
        const rawData = params.get('data');
        if (rawData) {
            data = JSON.parse(decodeURIComponent(rawData));
            if(data.config) config = data.config;
            if(data.role && data.role.startsWith('Role.')) data.role = data.role.replace('Role.', '');
        }
        document.getElementById('user-name').innerText = data.name || 'Guest';
        document.getElementById('user-id').innerText = `ID: ${data.id || '-'}`;
        document.getElementById('user-role').innerText = data.role || '-';
        const serverTime = new Date(data.server_time).toLocaleString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        document.getElementById('user-id').innerHTML = `ID: ${data.id || '-'}<br><span style="color:${data.role==='RIDER'?'red':'#888'}; font-size:10px;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${serverTime}</span>`;

        if(data.filter_admins) {
            const sel = document.getElementById('hist-filter-user');
            sel.style.display = 'block';
            data.filter_admins.forEach(u => sel.innerHTML += `<option value="${u}">${u}</option>`);
        }
        
        renderMenu(data.role);

    } catch (e) { console.error("Init Error", e); }

    function renderMenu(role) {
        const menu = document.getElementById('menu-container');
        const nav = document.getElementById('bottom-nav');
        let navHtml = `<div class="nav-btn active" onclick="nav('home', this)"><i class="fa-solid fa-house"></i>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</div>`;
        let menuHtml = '';

        if (['SUPERADMIN', 'ADMIN'].includes(role)) {
            menuHtml += `<div class="menu-item" onclick="goToPage('create-job')"><i class="fa-solid fa-plus-circle"></i><br>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</div>`;
        }
        if (['SUPERADMIN', 'SUPERVISOR'].includes(role)) {
            menuHtml += `<div class="menu-item" onclick="nav('pickup')"><i class="fa-solid fa-map-pin"></i><br>‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö</div>`;
        }
        if (['SUPERADMIN', 'SUPERVISOR', 'ADMIN'].includes(role)) {
            menuHtml += `<div class="menu-item" onclick="nav('history')"><i class="fa-solid fa-clock-rotate-left"></i><br>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`;
            let nh = navHtml + `<div class="nav-btn" onclick="nav('history', this)"><i class="fa-solid fa-list"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`;
            if (role !== 'ADMIN') {
                menuHtml += `<div class="menu-item" onclick="nav('pool')"><i class="fa-solid fa-layer-group"></i><br>Pool</div>`;
                nh += `<div class="nav-btn" onclick="nav('pool', this)"><i class="fa-solid fa-box"></i>Pool</div>`;
            }
            if (['ADMIN', 'SUPERADMIN', 'SUPERVISOR'].includes(role)) {
                menuHtml += `<div class="menu-item" onclick="nav('monitor')"><i class="fa-solid fa-desktop"></i><br>Monitor</div>`;
                nh += `<div class="nav-btn" onclick="nav('monitor', this)"><i class="fa-solid fa-eye"></i>Monitor</div>`;
            }
            navHtml = nh;
        }

        if (role === 'RIDER') {
            menuHtml += `
            <div class="menu-item" onclick="nav('rider')"><i class="fa-solid fa-motorcycle"></i><br>‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
            <div class="menu-item" onclick="nav('history')"><i class="fa-solid fa-clock-rotate-left"></i><br>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</div>
            `;
            navHtml += `<div class="nav-btn" onclick="nav('rider', this)"><i class="fa-solid fa-motorcycle"></i>‡∏á‡∏≤‡∏ô</div>`;
            navHtml += `<div class="nav-btn" onclick="nav('history', this)"><i class="fa-solid fa-list"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`;
        }

        menu.innerHTML = menuHtml;
        menu.style.display = 'grid';
        nav.innerHTML = navHtml + `<div class="nav-btn" onclick="tg.close()"><i class="fa-solid fa-xmark"></i>‡∏õ‡∏¥‡∏î</div>`;

        if (['SUPERADMIN', 'SUPERVISOR', 'ADMIN'].includes(role)) {
            try { renderPickupList(data.pickup_points || []); } catch(e){}
            try { setupPickupSelector(); } catch(e){}
            try { renderFullHistory(); } catch(e){}
            if (role !== 'ADMIN') try { renderPoolList(data.pool_jobs || []); } catch(e){}
            try { renderMonitor(data.monitor_jobs || []); } catch(e){}
        }

        if (role === 'RIDER') {
            try { renderRiderJob(data.current_job); } catch(e){}
            try { renderFullHistory(); } catch(e){} 
        }
    }

    function setupPickupSelector() {
        const list = data.pickup_points || [];
        const sel = document.getElementById('job-pickup-select');
        sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏ --</option>' + 
                        list.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    }

    // --- RENDER FUNCTIONS ---
    function renderFullHistory() {
        const list = data.full_history || [];
        const dateMode = document.getElementById('hist-filter-date').value;
        const userMode = document.getElementById('hist-filter-user').value;
        const el = document.getElementById('history-list');

        if(list.length === 0) { el.innerHTML = '<div style="text-align:center; padding:20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>'; return; }
        
        const now = new Date();
        const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());

        const filtered = list.filter(j => {
            const d = new Date(j.created_at);
            let dateMatch = true;
            if(dateMode === 'today') dateMatch = d >= startOfDay;
            else if(dateMode === 'week') { const w = new Date(startOfDay); w.setDate(w.getDate()-7); dateMatch = d >= w; }
            else if(dateMode === 'month') { const m = new Date(startOfDay); m.setMonth(m.getMonth()-1); dateMatch = d >= m; }
            
            let userMatch = true;
            if(userMode !== 'all') userMatch = j.admin === userMode;
            
            return dateMatch && userMatch;
        });

        if(filtered.length === 0) { el.innerHTML = '<div style="text-align:center; padding:20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</div>'; return; }

        el.innerHTML = filtered.map(h => {
            const isRider = data.role === 'RIDER';
            let details = '';
            if (!isRider) details += `<div class="card-row"><i class="fa-solid fa-user"></i> Admin: ${h.admin} | Rider: ${h.rider}</div>`;
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
            let recv = '';
            if(h.receiver_name && h.receiver_name !== '-') recv += `üßë‚Äçü¶∞ ${h.receiver_name} `;
            if(h.receiver_phone && h.receiver_phone !== '-') recv += `üìû ${h.receiver_phone}`;
            if(recv) details += `<div class="card-row"><i class="fa-solid fa-box-open"></i> ${recv}</div>`;
            if(h.note && h.note !== '-') details += `<div class="card-row"><i class="fa-solid fa-note-sticky"></i> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${h.note}</div>`;

            const proofBtn = (h.proof && !isRider) ? `<div class="card-actions"><a href="${h.proof}" target="_blank" class="btn btn-outline btn-sm">‡∏£‡∏π‡∏õ‡∏à‡∏ö‡∏á‡∏≤‡∏ô</a></div>` : '';

            return `
            <div class="card" style="border-left: 4px solid ${h.status==='COMPLETED'?'#00B900':'#dc3545'};">
                <div class="card-header">${h.bill_id} <span class="role-badge">${h.status}</span></div>
                ${details}
                <div class="card-row"><i class="fa-solid fa-money-bill"></i> ‡∏Ñ‡πà‡∏≤‡∏£‡∏ñ: ${h.price} ${h.extra_fee>0 ? `(+${h.extra_fee})` : ''}</div>
                <div class="card-row"><i class="fa-solid fa-clock"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á: ${new Date(h.created_at).toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' })}</div>
                ${proofBtn}
            </div>
            `;
        }).join('');
    }

    function renderMonitor(list) {
        const filtered = (data.monitor_jobs || []);
        const el = document.getElementById('monitor-list');
        if(filtered.length === 0) { el.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô</div>'; return; }

        el.innerHTML = filtered.map(j => {
            const jobDataStr = encodeURIComponent(JSON.stringify(j));
            const showAdminName = ['SUPERADMIN', 'SUPERVISOR'].includes(data.role);
            
            let details = '';
            if (showAdminName) details += `<div class="card-row"><i class="fa-solid fa-user"></i> Admin: ${j.admin} | Rider: ${j.rider}</div>`;
            else details += `<div class="card-row"><i class="fa-solid fa-motorcycle"></i> Rider: ${j.rider}</div>`;

            // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞ Note
            details += `<div class="card-row"><i class="fa-solid fa-box"></i> ‡∏ö‡∏¥‡∏•: ${j.bill_id}</div>`;
            if(j.receiver_name && j.receiver_name !== '-') {
                details += `<div class="card-row"><i class="fa-solid fa-address-card"></i> ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: ${j.receiver_name} <a href="tel:${j.receiver_phone}" style="text-decoration:none; color:inherit;">üìû ${j.receiver_phone}</a></div>`;
            }
            if(j.note && j.note !== '-') {
                details += `<div class="card-row"><i class="fa-solid fa-comment-dots"></i> Note: ${j.note}</div>`;
            }

            details += `<div class="card-row"><i class="fa-solid fa-clock"></i> ${new Date(j.created_at).toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' })}</div>`;
            
            let priceText = `üí∞ ${j.price}`;
            if (j.extra_fee > 0) priceText += ` (+‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡πà ${j.extra_fee})`;
            details += `<div class="card-row">${priceText}</div>`;

            let actions = '';
            if (j.status === 'COMPLETED' && j.proof) {
                actions += `<a href="${j.proof}" target="_blank" class="btn btn-outline btn-sm">‡∏£‡∏π‡∏õ‡∏à‡∏ö‡∏á‡∏≤‡∏ô</a> `;
            }
            if (!['COMPLETED', 'CANCELLED'].includes(j.status)) {
                actions += `<button class="btn btn-outline btn-sm" onclick="prepareEditDest('${j.job_id}', '${jobDataStr}')">‡πÅ‡∏Å‡πâ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</button>`;
            }

            return `
            <div class="card">
                <div class="card-header">${j.bill_id} <span class="role-badge">${j.status}</span></div>
                ${details}
                <div class="card-actions">${actions}</div>
            </div>
            `;
        }).join('');
    }

    function renderRiderJob(job) {
        const el = document.getElementById('rider-job-card');
        if (countdownInterval) clearInterval(countdownInterval);
        if (!job) { el.innerHTML = '<div style="text-align:center; padding:40px;">‡∏ß‡πà‡∏≤‡∏á</div>'; return; }
        
        let btns = '';
        let statusColor = '#00B900';
        let statusText = '‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì';
        let extraHtml = '';

        if (job.status === 'OFFERED') {
            statusColor = '#ffc107';
            statusText = 'üîî ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß!';
            const timeoutSec = (data.config && data.config.offer_timeout_sec) ? parseInt(data.config.offer_timeout_sec) : 60;
            const serverTimeMs = new Date(data.server_time).getTime();
            const clientTimeMs = new Date().getTime();
            const timeDiff = clientTimeMs - serverTimeMs;
            const updatedTime = new Date(job.updated_at).getTime();
            const expireTime = updatedTime + (timeoutSec * 1000);

            extraHtml = `<div id="job-countdown" style="text-align:center; font-size:24px; font-weight:bold; color:#d9534f; margin:10px 0;">...</div>`;
            btns = `
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="sendAction('accept_offer', {job_id:'${job.job_id}'})">‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</button>
                    <button class="btn btn-danger" onclick="if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?')) sendAction('reject_offer', {job_id:'${job.job_id}'})">‚ùå ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö</button>
                </div>
            `;
            countdownInterval = setInterval(() => {
                const nowAdjusted = new Date().getTime() - timeDiff;
                const diff = expireTime - nowAdjusted;
                if (diff <= 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('job-countdown').innerText = "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤!";
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    const s = Math.floor(diff / 1000);
                    document.getElementById('job-countdown').innerText = `‚è≥ ${s} ‡∏ß‡∏¥`;
                }
            }, 1000);

        } else if(job.status === 'ASSIGNED') {
            btns = `<a href="https://www.google.com/maps/dir/?api=1\\&destination=${job.pickup_lat},${job.pickup_lng}" target="_blank" class="btn btn-primary">üó∫Ô∏è ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö</a>
            <button class="btn btn-warning" onclick="sendAction('rider_update', {status:'PICKED_UP', job_id:'${job.job_id}'})">üì¶ ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</button>
            <button class="btn btn-danger" style="margin-top:10px;" onclick="cancelJob('${job.job_id}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</button>`;
        } else if (job.status === 'PICKED_UP') {
            btns = `<a href="https://www.google.com/maps/dir/?api=1\\&destination=${job.dropoff_lat},${job.dropoff_lng}" target="_blank" class="btn btn-primary">üèÅ ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á</a>
            <button class="btn btn-primary" onclick="sendAction('req_finish', {job_id:'${job.job_id}'}); tg.close();">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>`;
        }

        // ‚úÖ Rider Data Display Logic (Updated for completeness)
        let priceDisplay = `<b>${job.price} ‡∏ø</b>`;
        let extraFeeRow = '';
        if(job.extra_fee && job.extra_fee > 0) {
            priceDisplay = `<b>${job.price} ‡∏ø</b> <span style="font-size:12px; color:${statusColor}">(‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡πà ${job.extra_fee}‡∏ø)</span>`;
            extraFeeRow = `<div style="background:#fff3cd; color:#856404; padding:5px; border-radius:4px; font-size:12px; margin-bottom:5px;">‚ö†Ô∏è ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á +${job.extra_fee}‡∏ø</div>`;
        }

        let contactInfo = '';
        if(job.receiver_name && job.receiver_name !== '-') {
            contactInfo += `<p>üë§ ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: <b>${job.receiver_name}</b></p>`;
        }
        if(job.receiver_phone && job.receiver_phone !== '-') {
            contactInfo += `<p>üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå: <a href="tel:${job.receiver_phone}" class="btn btn-warning btn-sm" style="display:inline-block; width:auto; padding:2px 10px;">${job.receiver_phone} (‡∏Å‡∏î‡πÇ‡∏ó‡∏£)</a></p>`;
        }
        if(job.note && job.note !== '-') {
            contactInfo += `<div style="background:#f8f9fa; border-left:3px solid #6c757d; padding:5px; margin:5px 0; font-size:13px;">üìù <b>Note:</b> ${job.note}</div>`;
        }

        el.innerHTML = `
            <div class="card" style="border-left:5px solid ${statusColor};">
                <h2 style="color:${statusColor}">${statusText}</h2>
                ${extraHtml}
                ${extraFeeRow}
                <h3>${job.bill_id}</h3>
                <p>üí∞ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß: ${priceDisplay}</p>
                <p>üìç ‡∏£‡∏±‡∏ö: ${job.pickup_name}</p>
                <hr>
                ${contactInfo}
                <div style="margin-top:10px;">${btns}</div>
            </div>
        `;
    }

    // --- OTHER FUNCTIONS ---
    function nav(id, el) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-'+id).classList.add('active');
        if(el) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }
    }
    
    function goToPage(page) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        if (page === 'create-job') {
            document.getElementById('view-create-job').classList.add('active');
            resetJobForm();
        } else if (page === 'add-pickup') {
            document.getElementById('view-add-pickup').classList.add('active');
            editPickupId = null;
            resetPickupForm();
        } else {
            document.getElementById('view-'+page).classList.add('active');
        }
    }

    function goToAddPickup() {
        editPickupId = null;
        resetPickupForm();
        goToPage('add-pickup');
        document.getElementById('pickup-form-title').innerText = "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà";
    }

    function resetPickupForm() {
        document.getElementById('new-pickup-name').value = '';
        document.getElementById('pickup-search-input').value = '';
        document.getElementById('preview-pickup').innerHTML = '<div class="map-preview-placeholder">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>';
        tempLat = null; tempLng = null;
    }

    function resetJobForm() {
        document.getElementById('job-bill-id').value = '';
        document.getElementById('job-recv-name').value = '';
        document.getElementById('job-recv-phone').value = '';
        document.getElementById('job-note').value = '';
        document.getElementById('job-search-input').value = '';
        document.getElementById('job-pickup-select').value = '';
        document.getElementById('preview-job').innerHTML = '<div class="map-preview-placeholder">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</div>';
        tempLat = null; tempLng = null;
    }

    function savePickup() {
        const name = document.getElementById('new-pickup-name').value;
        if(!name || !tempLat) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠');
        if(editPickupId) {
            sendAction('delete_pickup', {id: editPickupId});
            setTimeout(() => sendAction('save_pickup', { name, lat: tempLat, lng: tempLng }), 500);
        } else {
            sendAction('save_pickup', { name, lat: tempLat, lng: tempLng });
        }
    }

    function renderPickupList(list) {
        const el = document.getElementById('pickup-list');
        if(list.length === 0) { el.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</div>'; return; }
        el.innerHTML = list.map(p => `
            <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                <div><b>${p.name}</b><br><span style="font-size:10px; color:#999;">‡πÇ‡∏î‡∏¢: ${p.creator_name}</span></div>
                <div style="display:flex; gap:5px;">
                    <button class="btn-icon delete" onclick="if(confirm('‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ô‡∏µ‡πâ?')) sendAction('delete_pickup', {id: '${p.id}'})"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
        `).join('');
    }

    function renderPoolList(list) {
        const el = document.getElementById('pool-list');
        if(list.length === 0) { el.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô Pool</div>'; return; }
        el.innerHTML = list.map(j => `
            <div class="card" style="border-left:4px solid #ffc107;">
                <div class="card-header">üìù ${j.bill_id}</div>
                <div class="card-row">üìç ‡∏£‡∏±‡∏ö: ${j.pickup}</div>
                <div class="card-actions"><button class="btn btn-primary btn-sm" onclick="sendAction('release_one', {job_id: '${j.job_id}'})">‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏á‡∏≤‡∏ô</button></div>
            </div>
        `).join('');
    }

    // --- CREATE JOB & MODAL ---
    function submitJob() {
        const bill = document.getElementById('job-bill-id').value;
        const pid = document.getElementById('job-pickup-select').value;
        
        // New Fields
        const rName = document.getElementById('job-recv-name').value;
        const rPhone = document.getElementById('job-recv-phone').value;
        const note = document.getElementById('job-note').value;

        if(!bill || !tempLat || !pid) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (‡∏ö‡∏¥‡∏•, ‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö, ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á)');
        
        const pickup = (data.pickup_points || []).find(p => p.id === pid);
        const dist = calcDist(pickup.lat, pickup.lng, tempLat, tempLng);
        const price = Math.ceil(config.base + (dist * config.km));
        
        modalActionType = 'create';
        // ‚úÖ ‡πÅ‡∏ô‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÉ‡∏ô payload
        pendingPayload = { 
            bill_id: bill, 
            pickup_id: pid, 
            lat: tempLat, 
            lng: tempLng,
            receiver_name: rName,
            receiver_phone: rPhone,
            note: note
        };
        
        pendingCopyText = `‡∏ö‡∏¥‡∏•: ${bill}\n‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: ${rName} (${rPhone})\n‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á : ${price} ‡∏ö‡∏≤‡∏ó`;
        
        const content = `
        <div class="modal-line"><span>üìÑ ‡∏ö‡∏¥‡∏•:</span> <b>${bill}</b></div>
        <div class="modal-line"><span>üë§ ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö:</span> <span>${rName || '-'}</span></div>
        <div class="modal-line"><span>üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå:</span> <span>${rPhone || '-'}</span></div>
        <div class="modal-line"><span>üìç ‡∏£‡∏±‡∏ö:</span> <span>${pickup.name}</span></div>
        <div class="modal-line"><span>üèÅ ‡∏™‡πà‡∏á:</span> <span>(‡∏´‡∏°‡∏∏‡∏î)</span></div>
        <div class="modal-line"><span>üìè ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á:</span> <span>~${dist.toFixed(2)} ‡∏Å‡∏°.</span></div>
        <hr style="margin: 5px 0; border:0; border-top:1px dashed #ddd;">
        <div class="modal-line" style="font-size:16px; color:var(--primary);"><span>üí∞ ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á:</span> <b>${price} ‡∏ö‡∏≤‡∏ó</b></div>
        `;
        document.getElementById('modal-title').innerText = "üì¶ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô";
        document.getElementById('modal-content').innerHTML = content;
        document.getElementById('confirm-modal').style.display = 'flex';
    }

    function prepareEditDest(jobId, jobDataStr) {
        currentJobId = jobId;
        currentEditJobData = JSON.parse(decodeURIComponent(jobDataStr));
        openMap('edit_dest');
    }

    function confirmEditDestPreview() {
        if (!currentEditJobData || !tempLat) return;
        const oldPrice = parseFloat(currentEditJobData.price);
        const newDist = calcDist(currentEditJobData.pickup_lat, currentEditJobData.pickup_lng, tempLat, tempLng);
        const newPurePrice = Math.ceil(config.base + (newDist * config.km));
        const fee = (currentEditJobData.status === 'PICKED_UP') ? config.change_fee : 0;
        
        let finalPrice = 0;
        let priceDetailHtml = '';

        if (fee > 0) {
            finalPrice = (newPurePrice > oldPrice) ? (newPurePrice + fee) : (oldPrice + fee);
            pendingCopyText = `‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á : ${finalPrice - fee} ‡∏ö‡∏≤‡∏ó\n‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà : ${fee} ‡∏ö‡∏≤‡∏ó\n‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á : ${finalPrice} ‡∏ö‡∏≤‡∏ó`;
            priceDetailHtml = `
            <div class="modal-line"><span>üí∂ ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°:</span> <span>${oldPrice} ‡∏ö‡∏≤‡∏ó</span></div>
            <div class="modal-line"><span>üìè ‡∏£‡∏∞‡∏¢‡∏∞‡πÉ‡∏´‡∏°‡πà:</span> <span>~${newDist.toFixed(2)} ‡∏Å‡∏°.</span></div>
            <div class="modal-line" style="color:${config.primary || 'green'}"><span>‚ûï ‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</span> <b>${fee} ‡∏ö‡∏≤‡∏ó</b></div>
            <hr style="margin: 5px 0;">
            <div class="modal-line" style="font-size:16px; color:var(--primary);"><span>üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÉ‡∏´‡∏°‡πà:</span> <b>${finalPrice} ‡∏ö‡∏≤‡∏ó</b></div>
            `;
        } else {
            finalPrice = newPurePrice;
            pendingCopyText = `‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á : ${finalPrice} ‡∏ö‡∏≤‡∏ó`;
            priceDetailHtml = `
            <div class="modal-line"><span>üí∂ ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°:</span> <span>${oldPrice} ‡∏ö‡∏≤‡∏ó</span></div>
            <div class="modal-line"><span>üìè ‡∏£‡∏∞‡∏¢‡∏∞‡πÉ‡∏´‡∏°‡πà:</span> <span>~${newDist.toFixed(2)} ‡∏Å‡∏°.</span></div>
            <hr style="margin: 5px 0;">
            <div class="modal-line" style="font-size:16px; color:var(--primary);"><span>üí∞ ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà:</span> <b>${finalPrice} ‡∏ö‡∏≤‡∏ó</b></div>
            `;
        }
        
        modalActionType = 'edit_dest';
        pendingPayload = { job_id: currentJobId, lat: tempLat, lng: tempLng };
        
        // Show simplified confirmation (User wants complete info on RIDER side, but here just confirm price)
        const content = `
        <div class="modal-line"><span>üìÑ ‡∏ö‡∏¥‡∏•:</span> <b>${currentEditJobData.bill_id}</b></div>
        <div class="modal-line"><span>üèÅ ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà:</span> <span>(‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏Å)</span></div>
        <div style="background:#f9f9f9; padding:10px; border-radius:8px; margin-top:10px;">
            ${priceDetailHtml}
        </div>
        `;
        document.getElementById('modal-title').innerText = "‚úèÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á";
        document.getElementById('modal-content').innerHTML = content;
        document.getElementById('confirm-modal').style.display = 'flex';
    }

    // --- UTILS & MAP ---
    function closeModal() { document.getElementById('confirm-modal').style.display = 'none'; }
    function confirmAction() {
        if (modalActionType === 'create') sendAction('create_job', pendingPayload);
        else if (modalActionType === 'edit_dest') sendAction('edit_destination', pendingPayload);
        closeModal();
    }
    
    function copyShippingPrice() {
        const el = document.createElement('textarea');
        el.value = pendingCopyText;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        const btn = document.querySelector('.btn-copy');
        const oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-check"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
        setTimeout(() => btn.innerHTML = oldText, 2000);
    }

    function openMap(mode) {
        mapMode = mode;
        document.getElementById('map-overlay').style.display = 'flex';
        document.getElementById('search-box-overlay').value = '';
        document.getElementById('btn-confirm-loc').disabled = true;
        if (!mapsLoaded) initMap();
    }
    function closeMap() { document.getElementById('map-overlay').style.display = 'none'; }
    
    function initMap() {
        const bangkok = { lat: 13.7563, lng: 100.5018 };
        map = new google.maps.Map(document.getElementById("map-fullscreen"), {
            zoom: 15, center: bangkok, disableDefaultUI: true, gestureHandling: "greedy"
        });
        const input = document.getElementById("search-box-overlay");
        const ac = new google.maps.places.Autocomplete(input);
        ac.bindTo("bounds", map);
        ac.addListener("place_changed", () => {
            const p = ac.getPlace();
            if (p.geometry) {
                if (p.geometry.viewport) map.fitBounds(p.geometry.viewport);
                else { map.setCenter(p.geometry.location); map.setZoom(17); }
                placeMarker(p.geometry.location);
            }
        });
        map.addListener("click", (e) => placeMarker(e.latLng));
        mapsLoaded = true;
    }
    
    function placeMarker(loc) {
        if (marker) marker.setMap(null);
        marker = new google.maps.Marker({ position: loc, map: map });
        tempLat = loc.lat();
        tempLng = loc.lng();
        document.getElementById('btn-confirm-loc').disabled = false;
        document.getElementById('map-status-text').innerText = `‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${tempLat.toFixed(4)}, ${tempLng.toFixed(4)}`;
    }
    
    document.getElementById('btn-confirm-loc').addEventListener('click', () => {
        closeMap();
        if (mapMode === 'pickup') {
            document.getElementById('pickup-search-input').value = `${tempLat.toFixed(4)}, ${tempLng.toFixed(4)}`;
            showStaticMap('preview-pickup', tempLat, tempLng);
        } else if (mapMode === 'job') {
            document.getElementById('job-search-input').value = `${tempLat.toFixed(4)}, ${tempLng.toFixed(4)}`;
            showStaticMap('preview-job', tempLat, tempLng);
        } else if (mapMode === 'edit_dest') {
            confirmEditDestPreview();
        }
    });
    
    function showStaticMap(elemId, lat, lng) {
        const el = document.getElementById(elemId);
        el.style.display = 'block';
        el.innerHTML = `<div style="width:100%; height:100%; background:#e0e0e0; display:flex; align-items:center; justify-content:center; flex-direction:column;">
            <i class="fa-solid fa-map-location-dot" style="font-size:30px; color:${elemId.includes('pickup')?'red':'blue'};"></i>
            <span style="font-size:12px; margin-top:5px;">${lat.toFixed(4)}, ${lng.toFixed(4)}</span>
        </div>`;
    }

    function sendAction(action, payload={}) { tg.sendData(JSON.stringify({ action, ...payload })); }
    function cancelJob(id) { const r = prompt("‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:"); if(r) sendAction('cancel_job', {job_id: id, reason: r}); }
    function confirmSOS() { if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô SOS?")) sendAction('sos'); }
    function calcDist(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180; 
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        return R * c; 
    }

    // --- AUTO FOCUS LOGIC ---
    function setupFormNavigation() {
        // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ID ‡∏Ç‡∏≠‡∏á Input ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö
        const inputs = ['job-bill-id', 'job-recv-name', 'job-recv-phone', 'job-note'];

        inputs.forEach((id, index) => {
            const el = document.getElementById(id);
            if (!el) return;

            el.addEventListener('keydown', (e) => {
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Enter (code 13)
                if (e.key === 'Enter' || e.keyCode === 13) {
                    e.preventDefault(); // ‡∏´‡πâ‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î Action ‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÄ‡∏ä‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà)

                    if (index < inputs.length - 1) {
                        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≤‡∏¢ Focus ‡πÑ‡∏õ‡∏ä‡πà‡∏≠‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                        const nextEl = document.getElementById(inputs[index + 1]);
                        if (nextEl) nextEl.focus();
                    } else {
                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ (job-note) ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô
                        el.blur(); 
                        submitJob();
                    }
                }
            });
        });
    }

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
document.addEventListener('DOMContentLoaded', () => {
    try { setupFormNavigation(); } catch(e) {}
});
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAzn1_v_MRFa2FpMjEeVBsdRtZ4dfZPo4w&libraries=places&callback=initMap" async defer></script>
</body>
</html>