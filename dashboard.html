<!DOCTYPE html>
<html lang="th">
<head>
    <title>Logistic SuperApp</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #00B900; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÅ‡∏ö‡∏ö LINE */
            --bg: #F5F5F5;
            --card-bg: #FFFFFF;
            --text-main: #1C1C1E;
            --text-sub: #8E8E93;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        body { margin: 0; padding: 0; font-family: 'Kanit', sans-serif; background-color: var(--bg); color: var(--text-main); -webkit-tap-highlight-color: transparent; padding-bottom: 80px; }
        
        /* --- HEADER --- */
        .header { background: var(--primary); padding: 20px 20px 40px 20px; border-radius: 0 0 20px 20px; color: white; }
        .header h1 { margin: 0; font-size: 24px; }
        .header p { margin: 5px 0 0; font-weight: 300; opacity: 0.9; }
        
        /* --- TAB CONTENT --- */
        .tab-content { display: none; padding: 0 15px; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        
        /* --- CARDS & STATS --- */
        .stats-container { display: flex; gap: 10px; margin-top: -30px; margin-bottom: 20px; }
        .stat-card { flex: 1; background: white; padding: 15px; border-radius: 12px; box-shadow: var(--shadow); text-align: center; }
        .stat-val { font-size: 20px; font-weight: bold; color: var(--primary); }
        .stat-label { font-size: 12px; color: var(--text-sub); }

        /* --- ACTION BUTTONS (HOME) --- */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .action-card { background: white; padding: 20px; border-radius: 16px; box-shadow: var(--shadow); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; cursor: pointer; transition: transform 0.1s; height: 100px; }
        .action-card:active { transform: scale(0.98); }
        .action-icon { font-size: 32px; color: var(--primary); }
        .action-text { font-weight: 600; font-size: 14px; }

        /* --- JOB LIST (HISTORY) --- */
        .job-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; border-left: 5px solid var(--primary); }
        .job-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .job-id { font-weight: bold; font-size: 16px; }
        .job-status { font-size: 12px; padding: 4px 8px; border-radius: 4px; background: #e8f5e9; color: var(--primary); font-weight: bold; }
        .job-detail { font-size: 13px; color: var(--text-sub); display: flex; align-items: center; gap: 5px; margin-bottom: 4px; }
        .job-price { position: absolute; bottom: 15px; right: 15px; font-weight: bold; font-size: 18px; color: var(--text-main); }

        /* --- BOTTOM NAV --- */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 10px 0 20px 0; display: flex; justify-content: space-around; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); border-top-left-radius: 20px; border-top-right-radius: 20px; z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #C7C7CC; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 20px; }
        .nav-item span { font-size: 10px; font-weight: 500; }

        /* --- MAP SCREEN OVERLAY --- */
        #map-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 200; display: none; }
        #map { width: 100%; height: 65%; }
        .map-controls { height: 35%; padding: 20px; background: white; border-radius: 20px 20px 0 0; position: absolute; bottom: 0; width: 100%; box-sizing: border-box; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); }
        .map-back-btn { position: absolute; top: 20px; left: 20px; background: white; padding: 10px 15px; border-radius: 8px; border: none; box-shadow: var(--shadow); z-index: 210; font-weight: bold; }
        
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 10px; font-family: 'Kanit'; box-sizing: border-box; }
        .btn-confirm { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; }
        .btn-confirm:disabled { background: #ccc; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="tab-home" class="tab-content active">
        <div class="header">
            <h1 id="welcomeText">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ...</h1>
            <p id="roleText">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ...</p>
        </div>
        
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-val" id="statTodayJobs">0</div>
                <div class="stat-label">‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="statTodayIncome">0‡∏ø</div>
                <div class="stat-label">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
            </div>
        </div>

        <div style="font-weight: bold; margin-bottom: 15px; padding-left: 5px;">‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</div>
        
        <div class="action-grid">
            <div class="action-card" id="btnCreate" style="display:none;" onclick="openMap()">
                <i class="fa-solid fa-box-open action-icon"></i>
                <div class="action-text">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</div>
            </div>
            <div class="action-card" id="btnPool" style="display:none;" onclick="sendAction('view_pool')">
                <i class="fa-solid fa-layer-group action-icon"></i>
                <div class="action-text">‡∏á‡∏≤‡∏ô‡πÉ‡∏ô Pool</div>
            </div>
            <div class="action-card" style="opacity: 0.5;">
                <i class="fa-solid fa-wallet action-icon"></i>
                <div class="action-text">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô</div>
            </div>
            <div class="action-card" style="opacity: 0.5;">
                <i class="fa-solid fa-headset action-icon"></i>
                <div class="action-text">‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
            </div>
        </div>
    </div>

    <div id="tab-history" class="tab-content" style="padding-top: 20px;">
        <h2 style="padding-left: 5px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
        <div id="jobListContainer">
            <div style="text-align: center; color: #999; margin-top: 50px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        </div>
    </div>

    <div id="tab-profile" class="tab-content" style="padding-top: 20px; text-align: center;">
        <div style="width: 80px; height: 80px; background: #ddd; border-radius: 50%; margin: 20px auto; display: flex; align-items: center; justify-content: center; font-size: 30px;">üë§</div>
        <h2 id="profileName">User Name</h2>
        <p id="profileRole" style="color: #666;">Role</p>
        <div style="margin-top: 20px; background: white; padding: 20px; border-radius: 12px; text-align: left;">
            <div>üì± Telegram ID: <span id="profileId">...</span></div>
            <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
            <div>‚≠ê ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 5.0</div>
        </div>
    </div>

    <div id="map-screen">
        <button class="map-back-btn" onclick="closeMap()"><i class="fa-solid fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö</button>
        <div id="map"></div>
        <div class="map-controls">
            <select id="pickupSelector">
                <option value="0">üè≠ ‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà: Main Warehouse (HQ)</option>
                <option value="1">üè¨ ‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà: Branch 2 (Siam)</option>
            </select>
            <input type="text" id="billId" placeholder="üìù ‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏• / Order ID" />
            <button class="btn-confirm" id="btnConfirm" disabled>üìç ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô</button>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('home', this)">
            <i class="fa-solid fa-house"></i>
            <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
        </div>
        <div class="nav-item" onclick="switchTab('history', this)">
            <i class="fa-solid fa-clock-rotate-left"></i>
            <span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>
        </div>
        <div class="nav-item" onclick="switchTab('profile', this)">
            <i class="fa-solid fa-user"></i>
            <span>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // 1. ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å URL (‡∏ó‡∏µ‡πà Python ‡∏™‡πà‡∏á‡∏°‡∏≤)
        const params = new URLSearchParams(window.location.search);
        const userData = JSON.parse(decodeURIComponent(params.get('data') || '{}'));
        // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á data: { name: '..', role: '..', today_jobs: 5, income: 500, jobs_list: [...] }

        // 2. Render ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        document.getElementById('welcomeText').innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${userData.name}`;
        document.getElementById('roleText').innerText = `‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ${userData.role}`;
        document.getElementById('profileName').innerText = userData.name;
        document.getElementById('profileRole').innerText = userData.role;
        document.getElementById('profileId').innerText = userData.id;

        // Stats
        document.getElementById('statTodayJobs').innerText = userData.today_count || 0;
        document.getElementById('statTodayIncome').innerText = (userData.today_income || 0).toLocaleString() + ' ‡∏ø';

        // ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏° Role
        if (['SUPERADMIN', 'SUPERVISOR', 'ADMIN'].includes(userData.role)) {
            document.getElementById('btnCreate').style.display = 'flex';
        }
        if (['SUPERADMIN', 'SUPERVISOR'].includes(userData.role)) {
            document.getElementById('btnPool').style.display = 'flex';
        }

        // Render History List
        const jobContainer = document.getElementById('jobListContainer');
        if (userData.jobs_list && userData.jobs_list.length > 0) {
            jobContainer.innerHTML = '';
            userData.jobs_list.forEach(job => {
                const html = `
                <div class="job-card">
                    <div class="job-header">
                        <div class="job-id">üìÑ ${job.bill_id}</div>
                        <div class="job-status">${job.status}</div>
                    </div>
                    <div class="job-detail"><i class="fa-solid fa-location-dot"></i> ${job.pickup} ‚ûù ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</div>
                    <div class="job-detail"><i class="fa-solid fa-clock"></i> ${job.time}</div>
                    ${job.proof ? `<div class="job-detail" style="color:#00B900"><i class="fa-solid fa-image"></i> ‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div>` : ''}
                    <div class="job-price">${job.price} ‡∏ø</div>
                </div>`;
                jobContainer.innerHTML += html;
            });
        } else {
            jobContainer.innerHTML = '<div style="text-align:center; padding:20px;">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö</div>';
        }

        // --- UI FUNCTIONS ---
        function switchTab(tabId, el) {
            document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(d => d.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            el.classList.add('active');
        }

        function openMap() { document.getElementById('map-screen').style.display = 'block'; if(!map) initMap(); }
        function closeMap() { document.getElementById('map-screen').style.display = 'none'; }
        function sendAction(action) { tg.sendData(JSON.stringify({ action: action })); }

        // --- MAP LOGIC ---
        let map, marker, selectedLocation = null;
        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 15, center: { lat: 13.7563, lng: 100.5018 },
                disableDefaultUI: true, gestureHandling: "greedy"
            });
            map.addListener("click", (e) => {
                if (marker) marker.setMap(null);
                marker = new google.maps.Marker({ position: e.latLng, map: map, animation: google.maps.Animation.DROP });
                selectedLocation = { lat: e.latLng.lat(), lng: e.latLng.lng() };
                checkReady();
            });
        }

        const billInput = document.getElementById("billId");
        const btnConfirm = document.getElementById("btnConfirm");
        billInput.addEventListener("input", checkReady);

        function checkReady() {
            if (selectedLocation && billInput.value.trim() !== "") {
                btnConfirm.disabled = false;
                btnConfirm.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô";
            } else {
                btnConfirm.disabled = true;
                btnConfirm.innerText = "üìç ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏ö‡∏¥‡∏•";
            }
        }

        btnConfirm.addEventListener("click", () => {
            const pickupIndex = document.getElementById("pickupSelector").value;
            tg.sendData(JSON.stringify({
                action: "create_job",
                bill_id: billInput.value.trim(),
                lat: selectedLocation.lat,
                lng: selectedLocation.lng,
                pickup_index: parseInt(pickupIndex)
            }));
        });
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAzn1_v_MRFa2FpMjEeVBsdRtZ4dfZPo4w&callback=initMap" async defer></script>
</body>
</html>