<!DOCTYPE html>
<html lang="th">
<head>
<title>Logistic SuperApp</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    :root { --primary: #00B900; --danger: #dc3545; --warning: #ffc107; --bg: #F5F5F5; --card: #FFF; --text: #333; }
    body { margin: 0; padding: 0; font-family: 'Kanit', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 90px; -webkit-tap-highlight-color: transparent; }

    /* LAYOUT & UTILS */
    .view { display: none; padding: 15px; animation: fadeIn 0.3s; }
    .view.active { display: block; }

    /* HEADER */
    .header { background: white; padding: 20px 20px 15px; border-radius: 0 0 20px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
    .user-info h1 { margin: 0; font-size: 18px; color: #333; }
    .user-info p { margin: 0; font-size: 12px; color: #888; }
    .role-badge { background: #e8f5e9; color: var(--primary); padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }

    /* CARDS */
    .card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; border-left: 4px solid var(--primary); }
    .card-header { font-weight: bold; font-size: 16px; margin-bottom: 8px; display: flex; justify-content: space-between; }
    .card-row { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #555; margin-bottom: 4px; }
    .card-actions { margin-top: 10px; display: flex; gap: 8px; justify-content: flex-end; border-top: 1px solid #eee; padding-top: 10px; }

    /* MENU GRID */
    .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .menu-item { background: white; padding: 20px; border-radius: 15px; text-align: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.1s; }
    .menu-item:active { transform: scale(0.98); }
    .menu-item i { font-size: 28px; color: var(--primary); margin-bottom: 10px; display: block; }

    /* FORM ELEMENTS */
    .form-group { margin-bottom: 15px; }
    .form-label { font-size: 14px; font-weight: bold; margin-bottom: 8px; display: block; color: #333; }
    input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: 'Kanit'; outline: none; font-size: 15px; background: #fff; }
    input:focus, select:focus { border-color: var(--primary); }

    /* BUTTONS */
    .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer; color: white; display: inline-flex; align-items: center; justify-content: center; gap: 5px; margin-top: 5px; transition: 0.2s; }
    .btn:disabled { background-color: #ccc !important; cursor: not-allowed; }
    .btn-primary { background: var(--primary); }
    .btn-danger { background: var(--danger); }
    .btn-warning { background: var(--warning); color: #333; }
    .btn-outline { background: transparent; border: 1px solid #ddd; color: #333; width: auto; padding: 6px 12px; font-size: 12px; }
    .btn-icon { background: none; border: none; cursor: pointer; font-size: 16px; padding: 5px; color: #888; }
    .btn-icon:hover { color: var(--primary); }
    .btn-icon.delete:hover { color: var(--danger); }

    /* MAP PREVIEW & OVERLAY */
    .map-preview { width: 100%; height: 180px; border-radius: 8px; margin-bottom: 10px; background: #eee; border: 1px solid #ddd; display: none; position: relative; overflow: hidden; }
    .map-preview-placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px; background: #f9f9f9; cursor: pointer; }

    #map-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; display: none; background: white; flex-direction: column; }
    .map-header-bar { padding: 15px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 2010; display: flex; gap: 10px; align-items: center; }
    #search-box-overlay { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Kanit'; outline: none; background: #f5f5f5; }
    #map-fullscreen { flex-grow: 1; width: 100%; }
    .map-footer-bar { padding: 20px; background: white; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); z-index: 2010; text-align: center; }
    
    /* FIX: Z-Index ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Google Autocomplete */
    .pac-container { z-index: 10000 !important; font-family: 'Kanit', sans-serif; }

    /* Custom Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: none; align-items: center; justify-content: center; }
    .modal-box { background: white; width: 85%; max-width: 320px; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); animation: fadeIn 0.2s; }
    .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: var(--primary); }
    .modal-detail { text-align: left; font-size: 14px; color: #555; background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
    .modal-line { display: flex; justify-content: space-between; margin-bottom: 5px; }
    .modal-actions { display: flex; gap: 10px; flex-direction: column; }
    .btn-copy { background: #333; color: white; }

    /* BOTTOM NAV */
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0 25px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 900; }
    .nav-btn { text-align: center; color: #ccc; font-size: 10px; cursor: pointer; flex: 1; }
    .nav-btn.active { color: var(--primary); }
    .nav-btn i { font-size: 22px; display: block; margin-bottom: 4px; }

    .fab { position: fixed; bottom: 90px; right: 20px; width: 50px; height: 50px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; z-index: 800; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
</head>
<body>

    <div class="header">
        <div class="user-info"><h1 id="user-name">...</h1><p id="user-id">ID: ...</p></div>
        <div class="role-badge" id="user-role">...</div>
    </div>

    <div id="view-home" class="view active">
        <h2 style="font-size:18px; margin:0 0 15px 0;">‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</h2>
        <div class="grid-menu" id="menu-container"></div>
        <button class="btn btn-danger" style="margin-top:30px;" onclick="confirmSOS()">üö® S.O.S</button>
    </div>

    <div id="view-pickup" class="view">
        <h3>üìç ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</h3>
        <div id="pickup-list"></div>
        <div class="fab" onclick="goToAddPickup()"><i class="fa-solid fa-plus"></i></div>
    </div>

    <div id="view-add-pickup" class="view">
        <button class="btn btn-outline" onclick="nav('pickup')" style="margin-bottom:15px;">üîô ‡∏Å‡∏•‡∏±‡∏ö</button>
        <h3 id="pickup-form-title">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà</h3>
        
        <div class="form-group">
            <label class="form-label">1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
            <div style="display:flex; gap:10px;">
                <input type="text" id="pickup-search-input" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà..." onclick="openMap('pickup')" readonly />
                <button class="btn btn-primary" style="width:auto; margin:0;" onclick="openMap('pickup')"><i class="fa-solid fa-map"></i></button>
            </div>
        </div>

        <div class="form-group">
            <div id="preview-pickup" class="map-preview" onclick="openMap('pickup')">
                <div class="map-preview-placeholder">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">3. ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö</label>
            <input type="text" id="new-pickup-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ A" />
        </div>

        <button class="btn btn-primary" onclick="savePickup()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>

    <div id="view-create-job" class="view">
        <button class="btn btn-outline" onclick="nav('home')" style="margin-bottom:15px;">üîô ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
        <h3>üì¶ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>

        <div class="form-group">
            <label class="form-label">1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</label>
            <div style="display:flex; gap:10px;">
                <input type="text" id="job-search-input" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà..." onclick="openMap('job')" readonly />
                <button class="btn btn-primary" style="width:auto; margin:0;" onclick="openMap('job')"><i class="fa-solid fa-map"></i></button>
            </div>
        </div>

        <div class="form-group">
            <div id="preview-job" class="map-preview" onclick="openMap('job')">
                <div class="map-preview-placeholder">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏</label>
            <select id="job-pickup-select"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö --</option></select>
        </div>

        <div class="form-group">
            <label class="form-label">3. ‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏• / Order ID</label>
            <input type="text" id="job-bill-id" placeholder="‡πÄ‡∏ä‡πà‡∏ô INV-2024-001" />
        </div>

        <button class="btn btn-primary" onclick="submitJob()">üöÄ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</button>
    </div>

    <div id="view-pool" class="view">
        <div style="display:flex; justify-content:space-between;"><h3>üì¶ Pool</h3><span class="role-badge" id="pool-count">0</span></div>
        <div id="pool-list"></div>
        <button class="btn btn-primary" style="position:fixed; bottom:90px; left:5%; width:90%;" onclick="sendAction('release_all')">üöÄ ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>

    <div id="view-monitor" class="view">
        <div style="display:flex; justify-content:space-between;"><h3>üëÄ Monitor</h3><select id="monitor-filter" onchange="renderMonitor()" style="width:auto;"><option value="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option><option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select></div>
        <div id="monitor-list"></div>
    </div>

    <div id="view-rider" class="view">
        <button class="btn btn-outline" onclick="nav('home')" style="margin-bottom:15px;">üîô ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
        <h3>üõµ ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
        <div id="rider-job-card"></div>
    </div>

    <div id="view-history" class="view">
        <button class="btn btn-outline" onclick="nav('home')" style="margin-bottom:15px;">üîô ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
        <h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
        <div id="history-list"></div>
    </div>

    <div id="map-overlay">
        <div class="map-header-bar">
            <button class="btn btn-outline" style="padding:8px 12px; width:auto;" onclick="closeMap()"><i class="fa-solid fa-arrow-left"></i></button>
            <input id="search-box-overlay" type="text" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà..." />
        </div>
        <div id="map-fullscreen"></div>
        <div class="map-footer-bar">
            <div id="map-status-text" style="font-size:12px; color:#666; margin-bottom:10px;">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î</div>
            <button class="btn btn-primary" id="btn-confirm-loc" disabled>üìç ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">üì¶ ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô</div>
            <div class="modal-detail" id="modal-content"></div>
            <div class="modal-actions">
                <button class="btn btn-copy" onclick="copyShippingPrice()"><i class="fa-solid fa-copy"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á</button>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-outline" style="flex:1;" onclick="closeModal()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="btn btn-primary" style="flex:1;" onclick="confirmCreateJob()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-nav" id="bottom-nav"></div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // STATE
    let data = { role: 'GUEST' };
    let tempLat = null, tempLng = null;
    let map, marker, mapMode, editPickupId = null;
    let mapsLoaded = false;
    let config = { base: 40, km: 10 }; 
    
    // Pending State for Modal
    let pendingJobPayload = null;
    let pendingPriceText = "";
    let countdownInterval;

    // INIT
    try {
        const params = new URLSearchParams(window.location.search);
        const rawData = params.get('data');
        if (rawData) {
            data = JSON.parse(decodeURIComponent(rawData));
            if(data.config) config = data.config;
        }

        document.getElementById('user-name').innerText = data.name || 'Guest';
        document.getElementById('user-id').innerText = `ID: ${data.id || '-'}`;
        document.getElementById('user-role').innerText = data.role || '-';

        renderMenu(data.role);
    } catch (e) { console.error("Init Error", e); }

    // --- RENDERING ---
    function renderMenu(role) {
        const menu = document.getElementById('menu-container');
        const nav = document.getElementById('bottom-nav');
        let navHtml = `<div class="nav-btn active" onclick="nav('home', this)"><i class="fa-solid fa-house"></i>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</div>`;
        let menuHtml = '';

        // --- ADMIN / SUPERVISOR MENUS ---
        if (['SUPERADMIN', 'SUPERVISOR', 'ADMIN'].includes(role)) {
            menuHtml += `
                <div class="menu-item" onclick="goToPage('create-job')"><i class="fa-solid fa-plus-circle"></i><br>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</div>
                <div class="menu-item" onclick="nav('pickup')"><i class="fa-solid fa-map-pin"></i><br>‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö</div>
            `;
            if (role !== 'ADMIN') {
                menuHtml += `<div class="menu-item" onclick="nav('pool')"><i class="fa-solid fa-layer-group"></i><br>Pool</div>`;
                navHtml += `<div class="nav-btn" onclick="nav('pool', this)"><i class="fa-solid fa-box"></i>Pool</div>`;
                renderPoolList(data.pool_jobs || []);
            }
            if (role === 'ADMIN' || role === 'SUPERADMIN') {
                menuHtml += `<div class="menu-item" onclick="nav('monitor')"><i class="fa-solid fa-desktop"></i><br>Monitor</div>`;
                navHtml += `<div class="nav-btn" onclick="nav('monitor', this)"><i class="fa-solid fa-eye"></i>Monitor</div>`;
                renderMonitor(data.monitor_jobs || []);
            }
            setupPickupSelector();
        }

        // --- RIDER MENU ---
        if (role === 'RIDER') {
            menuHtml += `
                <div class="menu-item" onclick="nav('rider')"><i class="fa-solid fa-motorcycle"></i><br>‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
                <div class="menu-item" onclick="nav('history')"><i class="fa-solid fa-clock-rotate-left"></i><br>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</div>
            `;
            navHtml += `<div class="nav-btn" onclick="nav('rider', this)"><i class="fa-solid fa-motorcycle"></i>‡∏á‡∏≤‡∏ô</div>`;
            
            renderRiderJob(data.current_job);
            renderHistory(data.history || []);
        }

        // Render ‡∏•‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        menu.innerHTML = menuHtml;
        menu.style.display = 'grid'; 
        renderPickupList(data.pickup_points || []);

        nav.innerHTML = navHtml + `<div class="nav-btn" onclick="tg.close()"><i class="fa-solid fa-xmark"></i>‡∏õ‡∏¥‡∏î</div>`;
    }

    function renderHistory(list) {
        const el = document.getElementById('history-list');
        if(list.length === 0) { el.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</div>'; return; }
        el.innerHTML = list.map(h => `
            <div class="card" style="border-left: 4px solid ${h.status==='COMPLETED'?'#00B900':'#dc3545'};">
                <div class="card-header">${h.bill_id} <span class="role-badge">${h.status}</span></div>
                <div class="card-row">üìÖ ${h.date}</div>
                <div class="card-row">üí∞ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß: ${h.price} ‡∏ö‡∏≤‡∏ó</div>
            </div>
        `).join('');
    }

    function renderPickupList(list) {
        const el = document.getElementById('pickup-list');
        if(list.length === 0) { el.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</div>'; return; }
        el.innerHTML = list.map(p => `
            <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                <div><b>${p.name}</b><br><span style="font-size:10px; color:#999;">‡πÇ‡∏î‡∏¢: ${p.creator_name}</span></div>
                <div style="display:flex; gap:5px;">
                    <button class="btn-icon" onclick="editPickup('${p.id}', '${p.name}', ${p.lat}, ${p.lng})"><i class="fa-solid fa-pen"></i></button>
                    <button class="btn-icon delete" onclick="if(confirm('‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏ô‡∏µ‡πâ?')) sendAction('delete_pickup', {id: '${p.id}'})"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
        `).join('');
    }

    function renderPoolList(list) {
        document.getElementById('pool-count').innerText = list.length;
        document.getElementById('pool-list').innerHTML = list.map(j => `
            <div class="card" style="border-left:4px solid #ffc107;">
                <div class="card-header">üìù ${j.bill_id}</div>
                <div class="card-row">üìç ‡∏£‡∏±‡∏ö: ${j.pickup}</div>
                <div class="card-row">üèÅ ‡∏™‡πà‡∏á: ${j.dropoff_lat.toFixed(4)}, ${j.dropoff_lng.toFixed(4)}</div>
                <div class="card-actions"><button class="btn btn-primary btn-sm" onclick="sendAction('release_one', {job_id: '${j.job_id}'})">‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏á‡∏≤‡∏ô</button></div>
            </div>
        `).join('');
    }

    function renderMonitor(list) {
        const filtered = (data.monitor_jobs || []);
        const el = document.getElementById('monitor-list');
        if(filtered.length === 0) { el.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô</div>'; return; }
        el.innerHTML = filtered.map(j => `
            <div class="card">
                <div class="card-header">${j.bill_id} <span class="role-badge">${j.status}</span></div>
                <div class="card-row">üë§ Rider: ${j.rider}</div>
                <div class="card-actions">
                    ${j.status === 'COMPLETED' ? `<a href="${j.proof}" target="_blank" class="btn btn-outline btn-sm">‡∏£‡∏π‡∏õ‡∏à‡∏ö‡∏á‡∏≤‡∏ô</a>` : ''}
                    ${!['COMPLETED', 'CANCELLED'].includes(j.status) ? `<button class="btn btn-outline btn-sm" onclick="openMap('edit_dest', '${j.job_id}')">‡πÅ‡∏Å‡πâ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</button>` : ''}
                </div>
            </div>
        `).join('');
    }

    function renderRiderJob(job) {
        const el = document.getElementById('rider-job-card');
        if (countdownInterval) clearInterval(countdownInterval);

        if (!job) { el.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">üõµ ‡∏ß‡πà‡∏≤‡∏á (‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô...)</div>'; return; }

        let btns = '';
        let statusColor = '#00B900';
        let statusText = '‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì';
        let extraHtml = '';

        if (job.status === 'OFFERED') {
            statusColor = '#ffc107'; // ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
            statusText = 'üîî ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß!';
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
            const timeoutSec = (data.config && data.config.offer_timeout_sec) ? parseInt(data.config.offer_timeout_sec) : 300;
            const startTime = new Date(job.updated_at).getTime();
            const expireTime = startTime + (timeoutSec * 1000);

            extraHtml = `<div id="job-countdown" style="text-align:center; font-size:24px; font-weight:bold; color:#d9534f; margin:10px 0;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...</div>`;

            btns = `
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="sendAction('accept_offer', {job_id:'${job.job_id}'})">‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</button>
                    <button class="btn btn-danger" onclick="if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?')) sendAction('reject_offer', {job_id:'${job.job_id}'})">‚ùå ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö</button>
                </div>
            `;

            countdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const diff = expireTime - now;

                if (diff <= 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('job-countdown').innerText = "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤!";
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((diff % (1000 * 60)) / 1000);
                    document.getElementById('job-countdown').innerText = `‚è≥ ${m}:${s < 10 ? '0'+s : s}`;
                }
            }, 1000);

        } else if(job.status === 'ASSIGNED') {
            btns = `<a href="https://www.google.com/maps/dir/?api=1&destination=${job.pickup_lat},${job.pickup_lng}" target="_blank" class="btn btn-primary">üó∫Ô∏è ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö</a>
                    <button class="btn btn-warning" onclick="sendAction('rider_update', {status:'PICKED_UP', job_id:'${job.job_id}'})">üì¶ ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</button>
                    <button class="btn btn-danger" style="margin-top:10px;" onclick="cancelJob('${job.job_id}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</button>`;
        } else if (job.status === 'PICKED_UP') {
            btns = `<a href="https://www.google.com/maps/dir/?api=1&destination=${job.dropoff_lat},${job.dropoff_lng}" target="_blank" class="btn btn-primary">üèÅ ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á</a>
                    <button class="btn btn-primary" onclick="sendAction('req_finish', {job_id:'${job.job_id}'}); tg.close();">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>`;
        }

        el.innerHTML = `
            <div class="card" style="border-left:5px solid ${statusColor};">
                <h2 style="color:${statusColor}">${statusText}</h2>
                ${extraHtml}
                <h3>${job.bill_id}</h3>
                <p>üí∞ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß: <b>${job.price} ‡∏ø</b></p>
                <p>üìç ‡∏£‡∏±‡∏ö: ${job.pickup_name}</p>
                <hr>
                ${btns}
            </div>
        `;
    }

    function setupPickupSelector() {
        const sel = document.getElementById('job-pickup-select');
        sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö --</option>' + (data.pickup_points || []).map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    }

    // --- NAVIGATION ---
    function nav(id, el) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-'+id).classList.add('active');
        if(el) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }
    }

    function goToPage(page) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        if (page === 'create-job') {
            document.getElementById('view-create-job').classList.add('active');
            resetJobForm();
        } else if (page === 'add-pickup') {
            document.getElementById('view-add-pickup').classList.add('active');
            editPickupId = null; 
            resetPickupForm();
        } else {
            document.getElementById('view-'+page).classList.add('active');
        }
    }

    function backToMain() { nav('home'); }

    // --- FORM ACTIONS ---
    function resetPickupForm() {
        document.getElementById('new-pickup-name').value = '';
        document.getElementById('pickup-search-input').value = '';
        document.getElementById('preview-pickup').style.display = 'none';
        document.getElementById('preview-pickup').innerHTML = '<div class="map-preview-placeholder">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>';
        tempLat = null; tempLng = null;
    }

    function resetJobForm() {
        document.getElementById('job-bill-id').value = '';
        document.getElementById('job-search-input').value = '';
        document.getElementById('job-pickup-select').value = '';
        document.getElementById('preview-job').style.display = 'none';
        document.getElementById('preview-job').innerHTML = '<div class="map-preview-placeholder">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</div>';
        tempLat = null; tempLng = null;
    }

    function goToAddPickup() {
        editPickupId = null;
        resetPickupForm();
        goToPage('add-pickup');
        document.getElementById('pickup-form-title').innerText = "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà";
    }

    function editPickup(id, name, lat, lng) {
        editPickupId = id;
        goToPage('add-pickup');
        document.getElementById('pickup-form-title').innerText = "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö";
        document.getElementById('new-pickup-name').value = name;
        document.getElementById('pickup-search-input').value = `${lat}, ${lng}`;
        tempLat = lat; tempLng = lng;
        showStaticMap('preview-pickup', lat, lng);
    }

    function savePickup() {
        const name = document.getElementById('new-pickup-name').value;
        if(!name || !tempLat) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠');
        
        // ‡πÉ‡∏ä‡πâ logic ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå (‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å Backend ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥ Update ‡πÑ‡∏ß‡πâ)
        if(editPickupId) {
            sendAction('delete_pickup', {id: editPickupId});
            setTimeout(() => sendAction('save_pickup', { name, lat: tempLat, lng: tempLng }), 500);
        } else {
            sendAction('save_pickup', { name, lat: tempLat, lng: tempLng });
        }
    }

    function submitJob() {
        const bill = document.getElementById('job-bill-id').value;
        const pid = document.getElementById('job-pickup-select').value;
        if(!bill || !tempLat || !pid) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');

        const pickup = (data.pickup_points || []).find(p => p.id === pid);
        if(!pickup) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö');

        const dist = calcDist(pickup.lat, pickup.lng, tempLat, tempLng);
        const base = (data.config && data.config.base) || 40;
        const perKm = (data.config && data.config.km) || 10;
        const price = Math.ceil(base + (dist * perKm));

        // ‡πÄ‡∏Å‡πá‡∏ö State ‡πÑ‡∏ß‡πâ‡∏£‡∏≠‡∏™‡πà‡∏á
        pendingJobPayload = { bill_id: bill, pickup_id: pid, lat: tempLat, lng: tempLng };
        pendingPriceText = `‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á: ${price} ‡∏ö‡∏≤‡∏ó`;

        const content = `
            <div class="modal-line"><span>üìÑ ‡∏ö‡∏¥‡∏•:</span> <b>${bill}</b></div>
            <div class="modal-line"><span>üìç ‡∏£‡∏±‡∏ö:</span> <span>${pickup.name}</span></div>
            <div class="modal-line"><span>üèÅ ‡∏™‡πà‡∏á:</span> <span>(‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î)</span></div>
            <div class="modal-line"><span>üìè ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á:</span> <span>~${dist.toFixed(2)} ‡∏Å‡∏°.</span></div>
            <hr style="margin: 5px 0; border:0; border-top:1px dashed #ddd;">
            <div class="modal-line" style="font-size:16px; color:var(--primary);"><span>üí∞ ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á:</span> <b>${price} ‡∏ö‡∏≤‡∏ó</b></div>
        `;
        document.getElementById('modal-content').innerHTML = content;
        document.getElementById('confirm-modal').style.display = 'flex';
    }

    // --- MODAL & COPY HELPERS ---
    function closeModal() { document.getElementById('confirm-modal').style.display = 'none'; }
    
    function confirmCreateJob() {
        if(pendingJobPayload) {
            sendAction('create_job', pendingJobPayload);
            closeModal();
        }
    }

    function copyShippingPrice() {
        const el = document.createElement('textarea');
        el.value = pendingPriceText;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        
        const btn = document.querySelector('.btn-copy');
        const oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-check"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
        setTimeout(() => btn.innerHTML = oldText, 2000);
    }

    // --- MAP LOGIC ---
    function openMap(mode, jobId = null) {
        mapMode = mode;
        currentJobId = jobId;
        document.getElementById('map-overlay').style.display = 'flex';
        document.getElementById('search-box-overlay').value = '';
        document.getElementById('btn-confirm-loc').disabled = true;
        if (!mapsLoaded) initMap();
    }

    function closeMap() { document.getElementById('map-overlay').style.display = 'none'; }

    function initMap() {
        const bangkok = { lat: 13.7563, lng: 100.5018 };
        map = new google.maps.Map(document.getElementById("map-fullscreen"), {
            zoom: 15, center: bangkok, disableDefaultUI: true, gestureHandling: "greedy"
        });

        const input = document.getElementById("search-box-overlay");
        const ac = new google.maps.places.Autocomplete(input);
        ac.bindTo("bounds", map);
        ac.addListener("place_changed", () => {
            const p = ac.getPlace();
            if (p.geometry) {
                if (p.geometry.viewport) map.fitBounds(p.geometry.viewport);
                else { map.setCenter(p.geometry.location); map.setZoom(17); }
                placeMarker(p.geometry.location);
            }
        });
        map.addListener("click", (e) => placeMarker(e.latLng));
        mapsLoaded = true;
    }

    function placeMarker(loc) {
        if (marker) marker.setMap(null);
        marker = new google.maps.Marker({ position: loc, map: map });
        tempLat = loc.lat(); 
        tempLng = loc.lng();
        document.getElementById('btn-confirm-loc').disabled = false;
        document.getElementById('map-status-text').innerText = `‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${tempLat.toFixed(4)}, ${tempLng.toFixed(4)}`;
    }

    document.getElementById('btn-confirm-loc').addEventListener('click', () => {
        closeMap();
        if (mapMode === 'pickup') {
            document.getElementById('pickup-search-input').value = `${tempLat.toFixed(4)}, ${tempLng.toFixed(4)}`;
            showStaticMap('preview-pickup', tempLat, tempLng);
        } else if (mapMode === 'job') {
            document.getElementById('job-search-input').value = `${tempLat.toFixed(4)}, ${tempLng.toFixed(4)}`;
            showStaticMap('preview-job', tempLat, tempLng);
        } else if (mapMode === 'edit_dest') {
            if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á?")) {
                sendAction('edit_destination', { job_id: currentJobId, lat: tempLat, lng: tempLng });
            }
        }
    });

    function showStaticMap(elemId, lat, lng) {
        const el = document.getElementById(elemId);
        el.style.display = 'block';
        el.innerHTML = `<div style="width:100%; height:100%; background:#e0e0e0; display:flex; align-items:center; justify-content:center; flex-direction:column;">
            <i class="fa-solid fa-map-location-dot" style="font-size:30px; color:${elemId.includes('pickup')?'red':'blue'};"></i>
            <span style="font-size:12px; margin-top:5px;">${lat.toFixed(4)}, ${lng.toFixed(4)}</span>
        </div>`;
    }

    // --- UTILS ---
    function sendAction(action, payload={}) { tg.sendData(JSON.stringify({ action, ...payload })); }
    function cancelJob(id) { const r = prompt("‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:"); if(r) sendAction('cancel_job', {job_id: id, reason: r}); }
    function confirmSOS() { if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô SOS?")) sendAction('sos'); }
    
    // Haversine Formula (JS)
    function calcDist(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2); 
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        return R * c;
    }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAzn1_v_MRFa2FpMjEeVBsdRtZ4dfZPo4w&libraries=places&callback=initMap" async defer></script>
</body>
</html>